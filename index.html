<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI建築見積システム v10.0</title>
  
  <link rel="icon" href="https://drive.google.com/uc?export=view&id=169_3_Fc8Pbj5fkqX6_KHFb3lNJAKkKnA">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=169_3_Fc8Pbj5fkqX6_KHFb3lNJAKkKnA">
  
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background-color: #E0F2F1; }
    [v-cloak] { display: none !important; }
    #critical-error { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffebee; color: #b71c1c; z-index: 9999; padding: 20px; box-sizing: border-box; overflow: auto; font-family: monospace; white-space: pre-wrap; }
  </style>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    
    :root { --bg-legacy: #E0F2F1; --header-bg: #004D40; --table-th-bg: #B2DFDB; }
    body { background-color: var(--bg-legacy); font-family: 'MS PGothic', 'Noto Sans JP', sans-serif; color: #333; font-size: 16px; margin-bottom: 50px; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .legacy-card { background-color: #F1F8E9; border: 1px solid #888; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
    .menu-card { transition: all 0.2s ease; border: 2px solid #ccc; }
    .menu-card:hover { transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: #666; }
    .grid-legacy { border: 1px solid #666; border-collapse: collapse; width: 100%; font-size: 14px; }
    .grid-legacy th { background-color: var(--table-th-bg); border: 1px solid #666; padding: 4px; text-align: center; font-weight: normal; white-space: nowrap; }
    .grid-legacy td { border: 1px solid #666; padding: 0; background: #fff; height: 28px; vertical-align: middle; }
    .input-cell { width: 100%; height: 100%; border: none; padding: 2px 4px; background: transparent; outline: none; font-family: inherit; }
    .input-cell:focus { background-color: #FFF9C4; } 
    textarea.input-cell { resize: none; overflow: hidden; line-height: 1.2; padding-top: 6px; }
    .num-cell { text-align: right; padding-right: 8px !important; }
    .price-cell-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px 0; }
    .price-cell-wrap input { text-align: center; width: 100%; border: none; background: transparent; outline: none; font-family: inherit; padding: 0 4px; }
    .price-cell-wrap input:focus { background-color: #FFF9C4; }
    .price-cell-wrap .pct-label { font-size: 11px; font-weight: bold; line-height: 1; margin-top: 1px; }
    .function-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #ddd; border-top: 1px solid #999; display: flex; flex-wrap: wrap; padding: 6px; gap: 6px; justify-content: center; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
    .f-btn { background: linear-gradient(to bottom, #fff, #e0e0e0); border: 1px solid #888; padding: 4px 10px; font-size: 14px; border-radius: 3px; cursor: pointer; color: #333; min-width: 80px; text-align: center; display: flex; align-items: center; justify-content: center; }
    .f-btn:hover { background: #eee; }
    .f-btn:active { transform: translateY(1px); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; border: 2px solid #555; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { background: var(--header-bg); color: #fff; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 10px; overflow-y: auto; flex: 1; }
    .menu-btn { background: #fff; border: 1px solid #bbb; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; border-radius: 4px; box-shadow: 2px 2px 0 #ccc; }
    .menu-btn:hover { transform: translateY(-2px); box-shadow: 4px 4px 0 #bbb; }
    .menu-icon { font-size: 48px; display: block; margin: 0 auto 10px; }
    .menu-title { font-size: 18px; font-weight: bold; color: #333; }
    .input-base { width: 100%; border: 1px solid #ccc; padding: 2px 4px; background: #fff; outline: none; }
    .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
    .modal-enter-from, .modal-leave-to { opacity: 0; }

    /* ===== チャットボット ドラッグ ===== */
    .chatbot-container { position: fixed; z-index: 4000; display: flex; flex-direction: column; align-items: end; }
    .chatbot-container.is-dragging { user-select: none; -webkit-user-select: none; }
    .chatbot-drag-handle { cursor: grab; }
    .chatbot-drag-handle:active, .chatbot-container.is-dragging .chatbot-drag-handle { cursor: grabbing; }
    .chatbot-btn-draggable { cursor: grab; touch-action: none; }
    .chatbot-btn-draggable:active, .chatbot-container.is-dragging .chatbot-btn-draggable { cursor: grabbing; }
    body.chatbot-dragging { user-select: none !important; -webkit-user-select: none !important; }

    /* ===== フローティング見積プレビューパネル (ドラッグ可能) ===== */
    .floating-panel-container { position: fixed; z-index: 3500; display: flex; flex-direction: column; }
    .floating-panel-container.is-dragging { user-select: none; -webkit-user-select: none; }
    .floating-panel-drag-handle { cursor: grab; }
    .floating-panel-drag-handle:active, .floating-panel-container.is-dragging .floating-panel-drag-handle { cursor: grabbing; }
    body.floating-panel-dragging { user-select: none !important; -webkit-user-select: none !important; }

    .toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
    .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 16px; pointer-events: auto; display: flex; align-items: center; gap: 10px; justify-content: center; font-weight: bold; }
    .toast.success { background: #43A047; }
    .toast.error { background: #E53935; }
    .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px); }
    
    .stat-card { background: #fff; border: 1px solid #999; padding: 10px; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .stat-val { font-size: 20px; font-weight: bold; font-family: 'mono'; color: #004D40; }
    .stat-label { font-size: 13px; color: #666; }
    
    /* ===== スプリットビュー (左パネル + 見積画面 + 右パネル) ===== */
    .edit-split-wrapper {
      display: flex;
      width: 100%;
      box-sizing: border-box;
      align-items: stretch;
    }
    
    /* 左パネル (単価マスタ等) */
    .edit-split-wrapper .edit-left-panel {
      flex: 0 0 0px;
      width: 0;
      min-width: 0;
      overflow: hidden;
      background: white;
      border-right: 1px solid transparent;
      display: flex;
      flex-direction: column;
      transition: flex-basis 0.3s ease, width 0.3s ease, min-width 0.3s ease, border-color 0.3s ease;
    }
    .edit-split-wrapper .edit-left-panel.is-open {
      flex: 0 0 30%;
      width: 30%;
      min-width: 280px;
      max-width: 400px;
      border-right-color: #ccc;
      box-shadow: 2px 0 5px rgba(0,0,0,0.08);
    }
    /* 左パネル内スクロール: パネル上でのみスクロール、親へ伝播しない */
    .edit-split-wrapper .edit-left-panel .edit-left-panel-scroll {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }
    
    /* 中央：見積明細エリア */
    .edit-split-wrapper .edit-main {
      flex: 1 1 0%;
      min-width: 0;
      overflow: hidden;
    }
    
    /* 右パネル (発注書作成) */
    .edit-split-wrapper .edit-right-panel {
      flex: 0 0 0px;
      width: 0;
      min-width: 0;
      overflow: hidden;
      background: white;
      border-left: 1px solid transparent;
      display: flex;
      flex-direction: column;
      transition: flex-basis 0.3s ease, width 0.3s ease, min-width 0.3s ease, border-color 0.3s ease;
    }
    .edit-split-wrapper .edit-right-panel.is-open {
      flex: 0 0 35%;
      width: 35%;
      min-width: 300px;
      max-width: 450px;
      border-left-color: #ccc;
      box-shadow: -2px 0 5px rgba(0,0,0,0.08);
    }
    .edit-table-scroll {
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .panel-tabs {
      display: flex;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
    }
    .panel-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
      border-bottom: 3px solid transparent;
    }
    .panel-tab.active {
      color: #004D40;
      border-bottom: 3px solid #004D40;
      background: #fff;
    }

    .side-panel-content { flex: 1; overflow-y: auto; padding: 8px; }
    .history-card { border: 1px solid #ddd; margin-bottom: 8px; padding: 6px; border-radius: 4px; background: #fafafa; }
    .history-header { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 4px; border-bottom: 1px dashed #ccc; }
    .history-item { font-size: 13px; padding: 2px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
    .history-item:hover { background-color: #e3f2fd; }
    
    .master-item { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    .master-item:hover { background-color: #e0f2f1; }
    .master-category { font-weight: bold; color: #00695c; margin-right: 4px; font-size: 12px; }
    
    /* 発注先カスタムドロップダウン */
  </style>
  
  <script>
    window._escHtml = function(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); };
    window.showCriticalError = function(msg) {
        document.getElementById('loading-fallback').style.display = 'none';
        const el = document.getElementById('critical-error');
        el.style.display = 'block';
        el.innerHTML = '<h3>システムエラーが発生しました</h3><pre>' + window._escHtml(msg) + '</pre><p>リロードしてください。解決しない場合は管理者に連絡してください。</p>';
        console.error("Critical Error:", msg);
    };
    setTimeout(function() {
        const appEl = document.getElementById('app');
        if (appEl && appEl.getAttribute('v-cloak') !== null) {
            var msg = 'Startup Timeout: Vue.js failed to mount within 30 seconds.\n\n';
            msg += '診断: attempted=' + (window.__mountAttempted?'Y':'N') + ' complete=' + (window.__mountComplete?'Y':'N') + ' script2=' + (window.__script2Ran?'Y':'N') + '\n\n';
            if (typeof Vue === 'undefined') {
                msg += 'Vue.js が読み込まれていません。CDNがブロックされている可能性があります。';
            } else {
                msg += '簡易表示に切り替えます。';
                try {
                    var lb = document.getElementById('loading-fallback');
                    if (lb) lb.style.display = 'none';
                    var minimal = Vue.createApp({ template: '<div style="padding:20px;font-size:16px;"><h3>システム起動に時間がかかっています</h3><p>診断: script2=' + (window.__script2Ran?'Y':'N') + ' attempted=' + (window.__mountAttempted?'Y':'N') + '</p><p>ページを再読み込みするか、ネットワーク環境を確認してください。</p></div>', data: function() { return {}; } });
                    minimal.mount('#app');
                    return;
                } catch (e) { msg += '\n簡易表示も失敗: ' + (e.message||e); }
            }
            window.showCriticalError(msg);
        }
    }, 30000);
  </script>
</head>
<body class="text-gray-900">
  
  <div id="loading-fallback" style="position:fixed; inset:0; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; background-color:#F5F5F5; font-family:sans-serif;">
    <div style="font-size:24px; font-weight:bold; color:#333; margin-bottom:16px;">AI建築見積システム v10.0</div>
    <div class="loader"></div>
    <p style="margin-top:16px; color:#666;">システムを起動しています...</p>
    <p style="margin-top:8px; font-size:12px; color:#999;">※長時間変わらない場合はリロードしてください</p>
  </div>

  <div id="critical-error"></div>

  <div id="app" v-cloak>
    <div class="toast-container">
      <transition-group name="toast">
        <div v-for="n in notifications" :key="n.id" class="toast" :class="n.type">
          <span class="material-icons" style="font-size:18px">{{ n.type === 'success' ? 'check_circle' : 'error' }}</span>
          {{ n.message }}
        </div>
      </transition-group>
    </div>

    <!-- Confirm Modal -->
    <transition name="modal">
      <div v-if="confirmState.show" class="modal-overlay" style="z-index: 3001;">
        <div class="bg-white p-6 rounded shadow-xl max-w-sm w-full border border-gray-300">
          <div class="text-base mb-6 text-gray-800 whitespace-pre-wrap">{{ confirmState.message }}</div>
          <div class="flex justify-end gap-3">
            <button @click="handleConfirm(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold text-sm">キャンセル</button>
            <button @click="handleConfirm(true)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold text-sm shadow">OK</button>
          </div>
        </div>
      </div>
    </transition>

    <!-- Save & Move Modal -->
    <transition name="modal">
      <div v-if="saveConfirmState.show" class="modal-overlay" style="z-index: 3002;">
        <div class="bg-white p-6 rounded shadow-xl max-w-md w-full border border-gray-300">
          <h3 class="text-lg font-bold mb-2">保存されていない変更があります</h3>
          <p class="text-sm text-gray-600 mb-6">ページを移動する前に保存しますか？</p>
          <div class="flex justify-end gap-3">
            <button @click="!saveConfirmState.saving && (saveConfirmState.show = false)" :disabled="saveConfirmState.saving" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">キャンセル</button>
            <button @click="!saveConfirmState.saving && handleSaveAndMove(false)" :disabled="saveConfirmState.saving" class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed">保存せず移動</button>
            <button @click="!saveConfirmState.saving && handleSaveAndMove(true)" :disabled="saveConfirmState.saving" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold text-sm shadow disabled:opacity-50 disabled:cursor-not-allowed">保存して移動</button>
          </div>
        </div>
      </div>
    </transition>
    
    <!-- Vendor Selection Modal -->
    <transition name="modal">
      <div v-if="showVendorSelectModal" class="modal-overlay" style="z-index: 3005;">
        <div class="bg-white p-6 rounded shadow-xl max-w-sm w-full border border-gray-300">
          <h3 class="font-bold text-lg mb-4 text-gray-800">発注先を選択してください</h3>
          <div class="flex flex-col gap-2 mb-4 max-h-60 overflow-y-auto">
            <button v-for="v in vendorCandidates" :key="v" @click="dedicatedOrderPdfMode ? selectDedicatedVendorAndPrint(v) : selectVendorAndPrint(v)"
                    class="px-4 py-3 bg-gray-100 hover:bg-orange-100 border text-left rounded font-bold text-sm transition">
              {{ v }}
            </button>
          </div>
          <button @click="showVendorSelectModal=false; dedicatedOrderPdfMode=false" class="w-full px-4 py-2 border text-gray-500 rounded hover:bg-gray-100 text-xs">キャンセル</button>
        </div>
      </div>
    </transition>

    <!-- Ledger Modal -->
    <transition name="modal">
      <div v-if="showLedgerModal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content w-full max-w-4xl h-[85vh]">
          <div class="modal-header"><span>工事台帳詳細</span><button @click="showLedgerModal=false">×</button></div>
          <div class="modal-body p-4" v-if="ledgerData">
             <div class="flex justify-between items-end border-b-2 border-gray-500 pb-2 mb-4">
                 <div>
                     <div class="text-xs text-gray-500">工事番号: {{ ledgerData.project.id }}</div>
                     <div class="text-xl font-bold">{{ ledgerData.project.project }}</div>
                     <div class="text-sm">{{ ledgerData.project.client }} 様</div>
                 </div>
                 <div class="text-right">
                     <button @click="createLedgerPdf" class="bg-blue-600 text-white px-4 py-1.5 rounded shadow font-bold text-sm hover:bg-blue-700">PDF発行</button>
                 </div>
             </div>
             
             <!-- Summary Cards -->
             <div class="grid grid-cols-3 md:grid-cols-6 gap-2 mb-6">
                 <div class="p-3 bg-gray-50 border rounded text-center">
                     <div class="text-xs text-gray-500 font-bold">売上 (受注)</div>
                     <div class="text-lg font-mono font-bold">{{ formatCurrency(ledgerData.sales) }}</div>
                 </div>
                 <div class="p-3 bg-red-50 border border-red-200 rounded text-center">
                     <div class="text-xs text-red-500 font-bold">原価 (発注)</div>
                     <div class="text-lg font-mono font-bold text-red-700">{{ formatCurrency(ledgerData.totalOrder) }}</div>
                 </div>
                 <div class="p-3 bg-green-50 border border-green-200 rounded text-center">
                     <div class="text-xs text-green-500 font-bold">粗利 (予定)</div>
                     <div class="text-lg font-mono font-bold text-green-700">{{ formatCurrency(ledgerData.profit) }}</div>
                 </div>
                 <div class="p-3 bg-yellow-50 border border-yellow-200 rounded text-center">
                     <div class="text-xs text-yellow-600 font-bold">利益率</div>
                     <div class="text-lg font-bold">{{ ledgerData.profitRate }}%</div>
                 </div>
                 <div class="p-3 bg-blue-50 border border-blue-200 rounded text-center">
                     <div class="text-xs text-blue-600 font-bold">入金済</div>
                     <div class="text-lg font-mono font-bold text-blue-700">{{ formatCurrency(ledgerData.totalDeposit || 0) }}</div>
                 </div>
                 <div class="p-3 bg-pink-50 border border-pink-200 rounded text-center">
                     <div class="text-xs text-pink-600 font-bold">出金済</div>
                     <div class="text-lg font-mono font-bold text-pink-700">{{ formatCurrency(ledgerData.totalWithdrawal || 0) }}</div>
                 </div>
             </div>
             
             <div class="text-sm font-bold mb-1 border-l-4 border-blue-500 pl-2">発注・請求明細</div>
             <table class="grid-legacy">
                 <thead>
                     <tr><th class="w-24">日付</th><th class="w-16">区分</th><th>業者名 / 摘要</th><th class="w-24 text-right">発注金額</th><th class="w-24 text-right">支払済</th></tr>
                 </thead>
                 <tbody>
                     <tr v-for="(o, i) in ledgerData.orders" :key="i" class="hover:bg-gray-50">
                         <td class="text-center">{{ o.date }}</td>
                         <td class="text-center"><span class="bg-gray-200 px-1 rounded text-[10px]">発注</span></td>
                         <td class="pl-2">
                             <div class="font-bold">{{ o.vendor }}</div>
                             <div class="text-xs text-gray-500">{{ o.item }}</div>
                         </td>
                         <td class="text-right num-cell">{{ formatCurrency(o.amount) }}</td>
                         <td class="text-right num-cell">-</td>
                     </tr>
                     <tr v-for="(inv, i) in ledgerData.invoices" :key="'inv'+i" class="bg-green-50 hover:bg-green-100">
                         <td class="text-center">{{ inv.date }}</td>
                         <td class="text-center"><span class="bg-green-200 text-green-800 px-1 rounded text-[10px]">支払</span></td>
                         <td class="pl-2">
                             <div class="font-bold">{{ inv.vendor }}</div>
                             <div class="text-xs text-gray-500">{{ inv.item }}</div>
                         </td>
                         <td class="text-right num-cell">-</td>
                         <td class="text-right num-cell font-bold">{{ formatCurrency(inv.amount) }}</td>
                     </tr>
                 </tbody>
             </table>

             <!-- 入金明細 -->
             <div v-if="ledgerData.deposits && ledgerData.deposits.length > 0" class="mt-4">
                 <div class="text-sm font-bold mb-1 border-l-4 border-blue-500 pl-2">入金明細</div>
                 <table class="grid-legacy">
                     <thead>
                         <tr><th class="w-24">入金日</th><th>取引先</th><th class="w-16">種別</th><th class="w-24 text-right">入金額</th><th class="w-20 text-right">手数料</th><th>備考</th></tr>
                     </thead>
                     <tbody>
                         <tr v-for="(d, i) in ledgerData.deposits" :key="i" class="bg-blue-50 hover:bg-blue-100">
                             <td class="text-center">{{ d.date }}</td>
                             <td class="pl-2 font-bold">{{ d.client }}</td>
                             <td class="text-center text-xs">{{ d.type }}</td>
                             <td class="text-right num-cell font-mono font-bold text-blue-800">{{ formatCurrency(d.amount) }}</td>
                             <td class="text-right num-cell font-mono text-xs">{{ formatCurrency(d.fee) }}</td>
                             <td class="text-xs text-gray-600 pl-2">{{ d.remarks }}</td>
                         </tr>
                         <tr class="bg-blue-100 font-bold">
                             <td colspan="3" class="text-right">入金合計</td>
                             <td class="text-right num-cell font-mono">{{ formatCurrency(ledgerData.totalDeposit || 0) }}</td>
                             <td colspan="2"></td>
                         </tr>
                     </tbody>
                 </table>
             </div>

             <!-- 出金明細 -->
             <div v-if="ledgerData.payments && ledgerData.payments.length > 0" class="mt-4">
                 <div class="text-sm font-bold mb-1 border-l-4 border-red-500 pl-2">出金明細</div>
                 <table class="grid-legacy">
                     <thead>
                         <tr><th class="w-24">出金日</th><th>支払先</th><th class="w-16">種別</th><th class="w-24 text-right">出金額</th><th class="w-20 text-right">手数料</th><th>備考</th></tr>
                     </thead>
                     <tbody>
                         <tr v-for="(pm, i) in ledgerData.payments" :key="i" class="bg-red-50 hover:bg-red-100">
                             <td class="text-center">{{ pm.date }}</td>
                             <td class="pl-2 font-bold">{{ pm.supplier }}</td>
                             <td class="text-center text-xs">{{ pm.type }}</td>
                             <td class="text-right num-cell font-mono font-bold text-red-800">{{ formatCurrency(pm.amount) }}</td>
                             <td class="text-right num-cell font-mono text-xs">{{ formatCurrency(pm.fee) }}</td>
                             <td class="text-xs text-gray-600 pl-2">{{ pm.remarks }}</td>
                         </tr>
                         <tr class="bg-red-100 font-bold">
                             <td colspan="3" class="text-right">出金合計</td>
                             <td class="text-right num-cell font-mono">{{ formatCurrency(ledgerData.totalWithdrawal || 0) }}</td>
                             <td colspan="2"></td>
                         </tr>
                     </tbody>
                 </table>
             </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- Preview Modal -->
    <transition name="modal">
      <div v-if="showPreviewModal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content w-full max-w-5xl h-[80vh]">
          <div class="modal-header"><span>仕訳データプレビュー</span><button @click="showPreviewModal=false">×</button></div>
          <div class="modal-body">
             <div v-if="previewData.headers" class="overflow-auto">
                 <table class="grid-legacy">
                     <thead>
                         <tr><th v-for="(h, i) in previewData.headers" :key="i">{{ h }}</th></tr>
                     </thead>
                     <tbody>
                         <tr v-for="(row, i) in previewData.rows" :key="i">
                             <td v-for="(c, j) in row" :key="j" class="text-xs px-1 whitespace-nowrap">{{ c }}</td>
                         </tr>
                     </tbody>
                 </table>
             </div>
             <div v-else class="text-center p-4">データがありません</div>
          </div>
          <div class="p-2 border-t flex justify-end">
              <button @click="downloadJournalCsv" class="bg-green-600 text-white px-4 py-2 rounded font-bold">CSVダウンロード</button>
          </div>
        </div>
      </div>
    </transition>

    <!-- 入金登録モーダル -->
    <transition name="modal">
      <div v-if="showDepositModal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content w-full max-w-lg">
          <div class="modal-header"><span>入金登録</span><button @click="showDepositModal=false">×</button></div>
          <div class="modal-body space-y-2 text-sm">
            <div><label class="block font-bold mb-1">入金日</label><input v-model="depositForm.date" type="date" class="border p-1 w-full"></div>
            <div><label class="block font-bold mb-1">取引先名 <span class="text-red-500">*</span></label><input v-model="depositForm.client" class="border p-1 w-full" placeholder="顧客名"></div>
            <div><label class="block font-bold mb-1">工事名</label><input v-model="depositForm.project" class="border p-1 w-full" placeholder="対象工事"></div>
            <div><label class="block font-bold mb-1">関連見積ID</label><input v-model="depositForm.estimateId" class="border p-1 w-full" placeholder="見積ID"></div>
            <div><label class="block font-bold mb-1">入金種別</label><select v-model="depositForm.type" class="border p-1 w-full"><option>振込</option><option>現金</option><option>小切手</option><option>手形</option><option>相殺</option><option>その他</option></select></div>
            <div><label class="block font-bold mb-1">入金金額 <span class="text-red-500">*</span></label><num-input v-model="depositForm.amount" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">振込手数料</label><num-input v-model="depositForm.fee" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">相殺金額</label><num-input v-model="depositForm.offset" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">備考</label><input v-model="depositForm.remarks" class="border p-1 w-full" placeholder="メモ"></div>
          </div>
          <div class="p-2 border-t flex justify-end gap-2">
            <button @click="showDepositModal=false" class="bg-gray-400 text-white px-4 py-2 rounded">キャンセル</button>
            <button @click="saveDeposit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">保存</button>
          </div>
        </div>
      </div>
    </transition>

    <!-- 出金登録モーダル -->
    <transition name="modal">
      <div v-if="showPaymentModal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content w-full max-w-lg">
          <div class="modal-header"><span>出金登録</span><button @click="showPaymentModal=false">×</button></div>
          <div class="modal-body space-y-2 text-sm">
            <div><label class="block font-bold mb-1">出金日</label><input v-model="paymentForm.date" type="date" class="border p-1 w-full"></div>
            <div><label class="block font-bold mb-1">支払先名 <span class="text-red-500">*</span></label><input v-model="paymentForm.supplier" class="border p-1 w-full" placeholder="業者名"></div>
            <div><label class="block font-bold mb-1">工事名</label><input v-model="paymentForm.project" class="border p-1 w-full" placeholder="対象工事"></div>
            <div><label class="block font-bold mb-1">関連発注ID</label><input v-model="paymentForm.orderId" class="border p-1 w-full" placeholder="発注ID"></div>
            <div><label class="block font-bold mb-1">関連請求書ID</label><input v-model="paymentForm.invoiceId" class="border p-1 w-full" placeholder="請求書ID"></div>
            <div><label class="block font-bold mb-1">出金種別</label><select v-model="paymentForm.type" class="border p-1 w-full"><option>振込</option><option>現金</option><option>小切手</option><option>手形</option><option>相殺</option><option>その他</option></select></div>
            <div><label class="block font-bold mb-1">出金金額 <span class="text-red-500">*</span></label><num-input v-model="paymentForm.amount" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">振込手数料</label><num-input v-model="paymentForm.fee" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">相殺金額</label><num-input v-model="paymentForm.offset" class="border p-1 w-full text-right" placeholder="0" /></div>
            <div><label class="block font-bold mb-1">備考</label><input v-model="paymentForm.remarks" class="border p-1 w-full" placeholder="メモ"></div>
          </div>
          <div class="p-2 border-t flex justify-end gap-2">
            <button @click="showPaymentModal=false" class="bg-gray-400 text-white px-4 py-2 rounded">キャンセル</button>
            <button @click="savePayment" class="bg-red-600 text-white px-4 py-2 rounded font-bold">保存</button>
          </div>
        </div>
      </div>
    </transition>

    <header style="background-color: var(--header-bg); color: white; padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
      <div class="flex items-center gap-2 cursor-pointer" @click="checkUnsavedChanges(() => goHome())">
        <span class="material-icons">architecture</span>
        <span class="font-bold text-lg">AI建築見積システム <span style="font-size: 10px; font-weight: normal;">v10.0</span></span>
      </div>
      <div class="text-xs flex gap-4 items-center">
        <span>{{ userEmail }}</span>
        <span v-if="auth.isAdmin" class="bg-yellow-500 text-black px-1 rounded">管理者</span>
        <button v-if="currentTab !== 'menu'" @click="checkUnsavedChanges(() => goHome())" class="bg-white text-black px-2 py-1 rounded border border-gray-400 hover:bg-gray-200">メニュー</button>
      </div>
    </header>

    <main :class="(currentTab === 'edit' || currentTab === 'dedicated_order') ? 'w-full p-4 mb-16' : 'max-w-7xl mx-auto p-4 mb-16'">
      <datalist id="vendor-list"><option v-for="v in masters.vendors" :key="v.displayName" :value="v.displayName"></option></datalist>
      <datalist id="unit-list"><option v-for="u in unitOptions" :key="u" :value="u"></option></datalist>
      <div v-if="loading" class="flex flex-col items-center justify-center h-64"><div class="loader mb-4"></div><p>{{ loadingMessage }}</p></div>

      <div v-else>
        <!-- メニュー画面 -->
        <div v-if="currentTab === 'menu'" class="max-w-4xl mx-auto">
          <!-- リマインドパネル -->
          <div v-if="reminders.length > 0" class="mb-4 border rounded shadow-sm bg-white">
            <div class="flex justify-between items-center px-3 py-2 border-b bg-gray-50">
              <span class="font-bold text-sm flex items-center gap-1">
                <span class="material-icons text-orange-500" style="font-size:18px">notifications_active</span>
                リマインド ({{ reminders.length }}件)
              </span>
            </div>
            <div class="divide-y max-h-48 overflow-y-auto">
              <div v-for="r in reminders" :key="r.type + r.id" class="flex items-center gap-2 px-3 py-2 text-sm"
                   :class="r.severity === 'danger' ? 'bg-red-50' : r.severity === 'warning' ? 'bg-yellow-50' : 'bg-blue-50'">
                <span class="material-icons" style="font-size:18px"
                      :class="r.severity === 'danger' ? 'text-red-600' : r.severity === 'warning' ? 'text-yellow-600' : 'text-blue-500'">
                  {{ r.severity === 'danger' ? 'error' : r.severity === 'warning' ? 'warning' : 'info' }}
                </span>
                <span class="flex-1">
                  <template v-if="r.type === 'pdf_missing'">
                    <span class="font-bold">{{ r.docType }} PDF未作成:</span> {{ r.label }}
                  </template>
                  <template v-else-if="r.type === 'deposit_overdue'">
                    <span class="font-bold text-red-700">入金期日超過:</span> {{ r.label }} ({{ Math.abs(r.daysLeft) }}日超過)
                  </template>
                  <template v-else-if="r.type === 'deposit_due'">
                    <span class="font-bold text-yellow-700">入金期日接近:</span> {{ r.label }} (あと{{ r.daysLeft }}日)
                  </template>
                  <template v-else-if="r.type === 'payment_overdue'">
                    <span class="font-bold text-red-700">出金期日超過:</span> {{ r.label }} ({{ Math.abs(r.daysLeft) }}日超過)
                  </template>
                  <template v-else-if="r.type === 'payment_due'">
                    <span class="font-bold text-yellow-700">出金期日接近:</span> {{ r.label }} (あと{{ r.daysLeft }}日)
                  </template>
                </span>
                <span v-if="r.dueDate" class="text-xs text-gray-500">期日: {{ r.dueDate }}</span>
              </div>
            </div>
          </div>
          <div v-else-if="remindersLoading" class="mb-4 text-center text-gray-400 text-sm py-2">
            <span class="material-icons animate-spin" style="font-size:16px">refresh</span> リマインド確認中...
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="menu-btn" @click="createNewEstimate">
                <span class="material-icons menu-icon text-blue-600">description</span>
                <div class="menu-title">御見積書作成</div>
                <div class="text-xs text-gray-500 mt-2">OCR取込、過去データ参照、新規作成。</div>
              </div>
              <button @click="openEstimateHistoryFromMenu" class="w-full mt-2 bg-teal-50 text-teal-700 border border-teal-300 px-4 py-2 text-sm font-bold rounded hover:bg-teal-100 shadow-sm transition flex items-center justify-center gap-1">
                <span class="material-icons text-base">history</span> 見積履歴
              </button>
            </div>

            <div>
              <div class="menu-btn" @click="handleNavigation('dedicated_order')">
                <span class="material-icons menu-icon text-orange-500">shopping_cart</span>
                <div class="menu-title">発注書作成</div>
                <div class="text-xs text-gray-500 mt-2">発注書作成（単独）</div>
              </div>
              <button @click="openOrderHistoryFromMenu" class="w-full mt-2 bg-indigo-50 text-indigo-700 border border-indigo-300 px-4 py-2 text-sm font-bold rounded hover:bg-indigo-100 shadow-sm transition flex items-center justify-center gap-1">
                <span class="material-icons text-base">history</span> 発注履歴
              </button>
            </div>
            
            <div v-if="auth.isAdmin" class="menu-btn" @click="goToProjectList">
              <span class="material-icons menu-icon text-indigo-500">analytics</span>
              <div class="menu-title">案件一覧・売上統計</div>
              <div class="text-xs text-gray-500 mt-2">進捗確認、売上集計。</div>
            </div>

            <div class="menu-btn" @click="goToInvoice">
              <span class="material-icons menu-icon text-pink-600">receipt_long</span>
              <div class="menu-title">請求書受取</div>
              <div class="text-xs text-gray-500 mt-2">受取請求書の確認・登録。</div>
            </div>

            <div v-if="auth.isAdmin" class="menu-btn" @click="goToAdmin">
              <span class="material-icons menu-icon text-yellow-600">admin_panel_settings</span>
              <div class="menu-title">管理者画面</div>
              <div class="text-xs text-gray-500 mt-2">承認フロー、マスタ管理。</div>
            </div>
          </div>
        </div>

        <!-- Phase 4: 発注書作成専用画面 -->
        <div v-if="currentTab === 'dedicated_order'" class="space-y-4">
            <div class="flex justify-between items-center bg-white p-3 border border-gray-400 rounded shadow-sm">
                <h2 class="font-bold text-lg flex items-center gap-2"><span class="material-icons text-orange-600">edit_note</span> 発注書編集</h2>
                <div class="flex items-center gap-2">
                    <button @click="openFloatingPanelList('estimate', 'order')" class="bg-teal-50 text-teal-700 border border-teal-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-teal-100 shadow-sm transition flex items-center gap-1">
                        <span class="material-icons text-[14px]">description</span> 見積履歴
                    </button>
                    <button @click="openFloatingPanelList('order', 'order')" class="bg-indigo-50 text-indigo-700 border border-indigo-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-indigo-100 shadow-sm transition flex items-center gap-1">
                        <span class="material-icons text-[14px]">history</span> 発注履歴
                    </button>
                    <button @click="createNewDedicatedOrder" class="bg-red-50 text-red-700 border border-red-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-red-100 shadow-sm transition flex items-center gap-1">
                        <span class="material-icons text-[14px]">delete_sweep</span> クリア
                    </button>
                    <button v-if="formSnapshot && formSnapshot.source === 'dedicated_order'" @click="restoreSnapshot" class="bg-blue-50 text-blue-700 border border-blue-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-blue-100 shadow-sm transition flex items-center gap-1">
                        <span class="material-icons text-[14px]">undo</span> 元に戻す
                    </button>
                </div>
            </div>

            <div class="edit-split-wrapper">
              <!-- 左パネル (単価マスタ/材料費単価) - 発注書作成用 -->
              <div class="edit-left-panel" :class="{ 'is-open': leftPanelMode !== null && leftPanelContext === 'dedicated_order' }">
                  <div class="bg-gray-100 border-b border-gray-300 flex justify-between items-center px-2 py-1">
                    <span class="font-bold text-sm text-gray-700">{{ leftPanelMode === 'price' ? '単価マスタ選択' : leftPanelMode === 'material' ? '材料費単価マスタ' : '元請見積履歴' }}</span>
                    <button @click="closeLeftPanel" class="text-gray-500 hover:text-gray-800 font-bold text-lg px-2">×</button>
                  </div>
                  <div class="p-2 border-b bg-white">
                    <input v-if="leftPanelMode === 'price'" v-model="searchMasterKeyword" class="w-full border p-1 text-xs" placeholder="品名・仕様・企業名・基本など スペースでAND検索">
                    <input v-if="leftPanelMode === 'set'" v-model="searchSetKeyword" class="w-full border p-1 text-xs" placeholder="セット名で検索...">
                    <input v-if="leftPanelMode === 'material'" v-model="searchMaterialKeyword" class="w-full border p-1 text-xs" placeholder="品名・仕様・単位 スペースでAND検索">
                  </div>
                  <div class="edit-left-panel-scroll bg-gray-50 p-2">
                    <div v-if="leftPanelMode === 'price'">
                      <div v-if="filteredMasters.length === 0" class="p-4 text-center text-xs text-gray-500">該当データなし</div>
                      <div v-for="(m, mi) in filteredMasters" :key="mi" @mousedown="applyMasterItem(m)" class="bg-white mb-2 rounded shadow-sm hover:bg-blue-50 cursor-pointer overflow-hidden">
                        <div class="grid grid-cols-3 gap-0 border border-gray-200">
                          <div class="border-r border-gray-200 p-1.5">
                            <div class="text-[9px] text-gray-500 mb-0.5">品名</div>
                            <div class="text-xs font-bold text-blue-900 break-words whitespace-normal leading-relaxed">{{ m.product }}</div>
                          </div>
                          <div class="border-r border-gray-200 p-1.5">
                            <div class="text-[9px] text-gray-500 mb-0.5">仕様</div>
                            <div class="text-[10px] text-gray-600 break-words whitespace-normal leading-relaxed">{{ m.spec || '-' }}</div>
                          </div>
                          <div class="p-1.5 bg-blue-50/50">
                            <div class="text-[9px] text-gray-500 mb-0.5">単価</div>
                            <div class="text-xs font-mono font-bold text-blue-900">{{ formatCurrency(m.price) }}</div>
                          </div>
                        </div>
                        <div class="text-[9px] text-gray-400 px-1.5 py-0.5 bg-gray-50 border-t border-gray-100">{{ m.source }}</div>
                      </div>
                    </div>

                    <div v-if="leftPanelMode === 'set'">
                      <div v-if="filteredSets.length === 0" class="p-4 text-center text-xs text-gray-500">該当セットなし</div>
                      <div v-for="s in filteredSets" :key="s.name" @mousedown="applySetItem(s.name)" class="bg-white mb-1 p-2 rounded shadow-sm hover:bg-green-50 cursor-pointer">
                        <div class="font-bold text-green-900 text-xs">{{ s.name }}</div>
                        <div v-if="s.firstItem" class="text-gray-500 text-[10px] truncate">{{ s.firstItem }}</div>
                        <div class="text-gray-600 text-[10px] flex justify-between">
                          <span>{{ s.count }}点</span>
                          <span class="font-mono">約 {{ formatCurrency(s.totalPrice) }}</span>
                        </div>
                      </div>
                    </div>

                    <div v-if="leftPanelMode === 'material'">
                      <button v-if="materialEditIdx !== 'new'" @click="openMaterialAdd" class="w-full bg-teal-600 text-white text-xs py-1.5 rounded hover:bg-teal-700 flex items-center justify-center gap-1 mb-2">
                        <span class="material-icons" style="font-size:14px">add</span>新規追加
                      </button>
                      <!-- 新規追加カード -->
                      <div v-if="materialEditIdx === 'new'" class="bg-white mb-2 rounded shadow-sm overflow-hidden border-2 border-teal-400">
                        <div class="grid grid-cols-3 gap-0 border-b border-gray-200">
                          <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.product" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="品名 (必須)"></div>
                          <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.spec" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="仕様"></div>
                          <div class="p-1"><input v-model.number="materialEditData.price" type="number" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="単価"></div>
                        </div>
                        <div class="flex items-center justify-between px-1.5 py-1 bg-gray-50">
                          <input v-model="materialEditData.unit" class="border border-teal-300 p-0.5 text-xs rounded w-16" placeholder="単位">
                          <span class="flex gap-1">
                            <button @click="saveMaterialItem" class="bg-teal-600 text-white text-[10px] px-2 py-0.5 rounded hover:bg-teal-700">保存</button>
                            <button @click="cancelMaterialEdit" class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded hover:bg-gray-300">取消</button>
                          </span>
                        </div>
                      </div>
                      <div v-if="filteredMaterialPrices.length === 0" class="p-4 text-center text-xs text-gray-500">該当データなし</div>
                      <div v-for="(m, mi) in filteredMaterialPrices" :key="mi" class="bg-white mb-2 rounded shadow-sm overflow-hidden" :class="materialEditIdx === mi ? 'border-2 border-teal-400' : ''">
                        <!-- 編集モード -->
                        <template v-if="materialEditIdx === mi">
                          <div class="grid grid-cols-3 gap-0 border-b border-gray-200">
                            <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.product" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="品名"></div>
                            <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.spec" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="仕様"></div>
                            <div class="p-1"><input v-model.number="materialEditData.price" type="number" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="単価"></div>
                          </div>
                          <div class="flex items-center justify-between px-1.5 py-1 bg-gray-50">
                            <input v-model="materialEditData.unit" class="border border-teal-300 p-0.5 text-xs rounded w-16" placeholder="単位">
                            <span class="flex gap-1">
                              <button @click="saveMaterialItem" class="bg-teal-600 text-white text-[10px] px-2 py-0.5 rounded hover:bg-teal-700">保存</button>
                              <button @click="cancelMaterialEdit" class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded hover:bg-gray-300">取消</button>
                            </span>
                          </div>
                        </template>
                        <!-- 表示モード -->
                        <template v-else>
                          <div @mousedown="applyMasterItem({product: m.product, spec: m.spec, unit: m.unit, price: m.price, category: '-', source: '材料費'})" class="grid grid-cols-3 gap-0 border border-gray-200 hover:bg-teal-50 cursor-pointer">
                            <div class="border-r border-gray-200 p-1.5"><div class="text-[9px] text-gray-500 mb-0.5">品名</div><div class="text-xs font-bold text-teal-900 break-words whitespace-normal leading-relaxed">{{ m.product }}</div></div>
                            <div class="border-r border-gray-200 p-1.5"><div class="text-[9px] text-gray-500 mb-0.5">仕様</div><div class="text-[10px] text-gray-600 break-words whitespace-normal leading-relaxed">{{ m.spec || '-' }}</div></div>
                            <div class="p-1.5 bg-teal-50/50"><div class="text-[9px] text-gray-500 mb-0.5">単価</div><div class="text-xs font-mono font-bold text-teal-900">{{ formatCurrency(m.price) }}</div></div>
                          </div>
                          <div class="text-[9px] text-gray-400 px-1.5 py-0.5 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                            <span>{{ m.unit || '-' }} / {{ m.updatedAt }}</span>
                            <span class="flex gap-1">
                              <button @click.stop="openMaterialEdit(m, mi)" class="text-blue-500 hover:text-blue-700" title="編集"><span class="material-icons" style="font-size:13px">edit</span></button>
                              <button @click.stop="deleteMaterialItem(m)" class="text-red-400 hover:text-red-600" title="削除"><span class="material-icons" style="font-size:13px">delete</span></button>
                            </span>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
              </div>

              <div class="edit-main legacy-card p-4 rounded shadow-inner relative">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 mb-4 bg-white/50 p-2 rounded border border-black/10">
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">日付:</label>
                        <input type="date" v-model="dedicatedOrderForm.header.date" class="input-base text-xs">
                    </div>
                    <div class="flex items-center relative">
                        <label class="w-16 text-xs font-bold">顧客名:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.client"
                               @focus="clientDropdown.show = true; clientDropdown.filter = dedicatedOrderForm.header.client"
                               @input="clientDropdown.filter = dedicatedOrderForm.header.client"
                               @blur="setTimeout(() => clientDropdown.show = false, 200)"
                               class="input-base text-xs" placeholder="クリックで候補表示" autocomplete="off">
                        <div v-if="clientDropdown.show && filteredCompanies.length"
                             class="absolute top-full left-16 right-0 z-50 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto">
                          <div v-for="c in filteredCompanies" :key="c.name"
                               @mousedown.prevent="onDedicatedClientSelect(c.name)"
                               class="px-3 py-1.5 text-xs cursor-pointer hover:bg-blue-100 flex justify-between items-center">
                            <span>{{ c.name }}</span>
                            <span class="text-[10px] px-1 rounded"
                                  :class="c.type === '元請' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'">{{ c.type }}</span>
                          </div>
                        </div>
                    </div>
                    <div class="flex items-center relative">
                        <label class="w-16 text-xs font-bold">件名:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.relEstId" class="input-base text-xs" placeholder="関連見積ID"
                               @focus="showEstSuggestions = estSuggestions.length > 0"
                               @blur="setTimeout(() => showEstSuggestions = false, 200)" autocomplete="off">
                        <div v-if="showEstSuggestions && estSuggestions.length"
                             class="absolute top-full left-16 right-0 z-50 bg-white border border-gray-300 rounded shadow-lg max-h-48 overflow-y-auto">
                          <div v-for="est in estSuggestions" :key="est.id"
                               @mousedown.prevent="selectEstimateSuggestion(est)"
                               class="px-3 py-1.5 text-xs cursor-pointer hover:bg-blue-100 border-b border-gray-100">
                            <span class="font-bold">{{ est.id }}</span>
                            <span class="ml-2 text-gray-600">{{ est.project }}</span>
                            <span class="ml-1 text-[10px] text-gray-400">{{ formatCurrency(est.totalAmount) }}円</span>
                          </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">工事名:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.project" class="input-base text-xs">
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">工事場所:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.location" class="input-base text-xs">
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">工期:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.period" class="input-base text-xs">
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">決済条件:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.payment" class="input-base text-xs">
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">有効期限:</label>
                        <input type="text" v-model="dedicatedOrderForm.header.expiry" class="input-base text-xs">
                    </div>
                    <div class="flex items-center">
                        <label class="w-16 text-xs font-bold">税区分:</label>
                        <select v-model="dedicatedOrderForm.header.taxMode" class="input-base text-xs"><option>税別</option><option>税込</option></select>
                    </div>
                </div>

                <!-- 選択ツールバー -->
                <div class="flex justify-between items-center mb-2 px-2 flex-wrap gap-1">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">
                      <span class="material-icons text-sm align-middle">check_box</span>
                      選択: <b>{{ dedicatedSelectedCount }}</b>件
                    </span>
                    <button @click="selectAllDedicatedRows" class="px-2 py-1 bg-blue-100 rounded hover:bg-blue-200 font-bold text-xs">全選択</button>
                    <button @click="clearAllDedicatedSelection" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 font-bold text-xs">全解除</button>
                  </div>
                  <div v-if="dedicatedSelectedCount > 0" class="flex items-center gap-1">
                    <select v-model="batchDedicatedVendor" class="text-xs border rounded px-2 py-1 bg-white">
                      <option value="">発注先を選択</option>
                      <option v-for="v in (masters.vendors || [])" :key="v.displayName || v.name" :value="v.displayName || v.name">{{ v.displayName || v.name }}</option>
                    </select>
                    <button @click="applyBatchDedicatedVendor" class="px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600 text-xs font-bold">
                      一括発注先変更（{{ dedicatedSelectedCount }}件）
                    </button>
                  </div>
                </div>

                <div class="edit-table-scroll" style="height: calc(100vh - 390px); min-height: 200px; border: 1px solid #999;">
                    <table class="grid-legacy w-full min-w-[1000px]">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th rowspan="2" style="width:28px;"><input type="checkbox" :checked="dedicatedSelectedCount === dedicatedOrderForm.items.length && dedicatedOrderForm.items.length > 0" @change="$event.target.checked ? selectAllDedicatedRows() : clearAllDedicatedSelection()" title="全選択/解除"></th>
                                <th rowspan="2" style="width:30px;"></th>
                                <th rowspan="2" style="width:140px;">品名</th>
                                <th rowspan="2" style="width:100px;">仕様</th>
                                <th colspan="4" class="bg-blue-100 text-blue-900 border-l border-r border-blue-300">【見積】</th>
                                <th colspan="5" class="bg-orange-100 text-orange-900 border-l border-r border-orange-300">【実行】</th>
                                <th rowspan="2" style="width:28px;"></th>
                            </tr>
                            <tr>
                                <th style="width:60px;" class="bg-blue-50">数量</th>
                                <th style="width:50px;" class="bg-blue-50">単位</th>
                                <th style="width:80px;" class="bg-blue-50">単価</th>
                                <th style="width:90px;" class="bg-blue-50">金額</th>
                                <th style="width:100px;" class="bg-orange-50">発注先</th>
                                <th style="width:60px;" class="bg-orange-50">数量</th>
                                <th style="width:50px;" class="bg-orange-50">単位</th>
                                <th style="width:80px;" class="bg-orange-50">単価</th>
                                <th style="width:90px;" class="bg-orange-50">金額</th>
                            </tr>
                        </thead>
                        <tbody @input.capture="isDirty=true" @change.capture="isDirty=true">
                            <tr v-for="(item, i) in dedicatedOrderForm.items" :key="i"
                                :class="{ 'bg-blue-100': item.selected, 'hover:bg-gray-50': !item.selected }"
                                @contextmenu.prevent="onRowContextMenu($event, i, 'dedicated')">
                                <td class="text-center" style="cursor:pointer; user-select:none;">
                                  <input type="checkbox" v-model="item.selected" @click.stop tabindex="-1">
                                </td>
                                <td class="text-center bg-gray-100">{{ i+1 }}</td>
                                <td><textarea v-model="item.product" @focus="openLeftPanel('price', i, 'dedicated_order')" class="input-cell font-bold" placeholder="品名" rows="1" v-auto-resize @click.stop :data-row="i" data-col="0" @keydown="cellNav($event)"></textarea></td>
                                <td><textarea v-model="item.spec" class="input-cell text-xs" placeholder="仕様" rows="1" v-auto-resize @click.stop :data-row="i" data-col="1" @keydown="cellNav($event)"></textarea></td>
                                <td class="bg-blue-50"><num-input :model-value="item.estQty" @update:model-value="v => { item.estQty = v; calcDedicatedLine(item) }" class="input-cell num-cell" :data-row="i" data-col="2" @keydown="cellNav($event)" /></td>
                                <td class="bg-blue-50"><input type="text" v-model="item.estUnit" list="unit-list" class="input-cell text-center" placeholder="-" :data-row="i" data-col="3" @keydown="cellNav($event)"></td>
                                <td style="background:#E3F2FD"><num-input :model-value="item.estPrice" @update:model-value="v => { item.estPrice = v; calcDedicatedLine(item) }" class="input-cell num-cell" :data-row="i" data-col="4" @keydown="cellNav($event)" /></td>
                                <td class="num-cell font-mono bg-blue-100 font-bold text-blue-900">{{ item.estAmount ? formatCurrency(item.estAmount) : '' }}</td>
                                <td class="bg-orange-50"><input type="text" v-model="item.vendor" list="vendor-list" class="input-cell text-xs" placeholder="業者選択..." :data-row="i" data-col="5" @keydown="cellNav($event)"></td>
                                <td class="bg-orange-50"><num-input :model-value="item.exeQty" @update:model-value="v => { item.exeQty = v; calcDedicatedLine(item) }" class="input-cell num-cell" :data-row="i" data-col="6" @keydown="cellNav($event)" /></td>
                                <td class="bg-orange-50"><input type="text" v-model="item.exeUnit" list="unit-list" class="input-cell text-center" placeholder="-" :data-row="i" data-col="7" @keydown="cellNav($event)"></td>
                                <td class="bg-orange-50"><num-input :model-value="item.exePrice" @update:model-value="v => { item.exePrice = v; calcDedicatedLine(item) }" class="input-cell num-cell" :data-row="i" data-col="8" @keydown="cellNav($event)" /></td>
                                <td class="num-cell font-mono bg-orange-100 text-orange-900 font-bold">{{ item.exeAmount ? formatCurrency(item.exeAmount) : '' }}</td>
                                <td class="text-center"><button @click="removeDedicatedItem(i)" class="text-gray-400 hover:text-red-500 text-sm font-bold">×</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button @click="dedicatedOrderForm.items.push({product:'',spec:'',vendor:'',estQty:'',estUnit:'',estPrice:'',estAmount:0,exeQty:'',exeUnit:'',exePrice:'',exeAmount:0,selected:false})" class="mt-2 w-full py-2 border border-dashed border-gray-400 text-gray-500 text-xs hover:bg-white transition font-bold">+ 行追加</button>
                </div>

                <div class="mt-2 flex justify-end gap-6 text-sm font-bold p-3 bg-white border border-gray-400 shadow-sm flex-wrap">
                    <div class="text-orange-800">実行合計(原価): <span class="text-xl">{{ formatCurrency(totalDedicatedAmount) }}</span></div>
                    <div class="text-blue-900 border-l pl-4 border-gray-400">見積合計(売上): <span class="text-xl">{{ formatCurrency(totalDedicatedEstimate) }}</span></div>
                    <div class="border-l pl-4 border-gray-400" :class="totalDedicatedEstimate - totalDedicatedAmount >= 0 ? 'text-green-700' : 'text-red-700'">
                        粗利: <span class="text-xl">{{ formatCurrency(totalDedicatedEstimate - totalDedicatedAmount) }}</span>
                        <span class="text-xs bg-gray-200 px-1 rounded ml-1">{{ totalDedicatedEstimate ? (((totalDedicatedEstimate - totalDedicatedAmount) / totalDedicatedEstimate) * 100).toFixed(1) : 0 }}%</span>
                    </div>
                    <div class="border-l pl-4 border-gray-400 text-orange-700">
                        原価率: <span class="text-xl">{{ totalDedicatedEstimate ? ((totalDedicatedAmount / totalDedicatedEstimate) * 100).toFixed(1) : 0 }}%</span>
                    </div>
                </div>
              </div>
            </div>
        </div>

        <!-- 案件一覧 (タブ切替: 見積案件 / 発注案件) -->
        <div v-if="currentTab === 'list' && auth.isAdmin" class="space-y-4">
          <!-- タブ切替 -->
          <div class="flex border-b-2 border-gray-400 bg-white rounded-t">
            <button @click="listSubTab='estimate'" class="px-6 py-3 font-bold text-sm transition-colors flex items-center gap-2" :class="listSubTab==='estimate' ? 'bg-teal-100 border-b-3 border-teal-600 text-teal-800' : 'text-gray-500 hover:bg-gray-50'">
              <span class="material-icons text-lg">description</span> 見積案件一覧
            </button>
            <button @click="listSubTab='order'" class="px-6 py-3 font-bold text-sm transition-colors flex items-center gap-2" :class="listSubTab==='order' ? 'bg-orange-100 border-b-3 border-orange-600 text-orange-800' : 'text-gray-500 hover:bg-gray-50'">
              <span class="material-icons text-lg">shopping_cart</span> 発注案件一覧
            </button>
          </div>

          <!-- 見積案件一覧タブ -->
          <div v-if="listSubTab==='estimate'">
            <div class="bg-white p-4 border border-gray-400 rounded shadow-sm">
              <div class="flex flex-wrap gap-4 items-end mb-4">
                <div><label class="text-[10px] block font-bold">表示年</label><select v-model="filter.year" class="border p-1 text-xs w-24 bg-gray-50"><option value="">全て</option><option v-for="y in years" :key="y" :value="y">{{y}}年</option></select></div>
                <div><label class="text-[10px] block font-bold">表示月</label><select v-model="filter.month" class="border p-1 text-xs w-24 bg-gray-50"><option value="">全て</option><option v-for="m in 12" :key="m" :value="m">{{m}}月</option></select></div>
                <div><label class="text-[10px] block font-bold">元請企業</label><select v-model="filter.client" class="border p-1 text-xs w-40 bg-gray-50"><option value="">全ての元請</option><option v-for="c in masters.clients" :key="c" :value="c">{{c}}</option></select></div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                <div class="stat-card"><div class="stat-label">総売上(見積)</div><div class="stat-val">{{ formatCurrency(stats.totalSales) }}</div></div>
                <div class="stat-card"><div class="stat-label">総原価(発注)</div><div class="stat-val text-orange-800">{{ formatCurrency(stats.totalCost) }}</div></div>
                <div class="stat-card"><div class="stat-label">受取請求総額</div><div class="stat-val text-purple-800">{{ formatCurrency(stats.totalInvoiced) }}</div></div>
                <div class="stat-card"><div class="stat-label">粗利(予定)</div><div class="stat-val" :class="stats.totalProfit < 0 ? 'text-red-600':''">{{ formatCurrency(stats.totalProfit) }}</div></div>
                <div class="stat-card"><div class="stat-label">平均粗利率</div><div class="stat-val" :class="Number(stats.margin) < 15 ? 'text-red-600':''">{{ stats.margin }}%</div></div>
                <div class="stat-card"><div class="stat-label">支払予定残</div><div class="stat-val text-red-600">{{ formatCurrency(stats.pendingPayment) }}</div></div>
              </div>
            </div>

            <div class="bg-white border border-gray-400 rounded overflow-hidden mt-4">
              <div class="bg-teal-50 p-2 text-xs font-bold border-b border-gray-400 flex justify-between">
                <span>見積案件リスト ({{ filteredProjects.length }}件)</span>
                <span class="text-gray-500">※入金欄は入金データとの連携結果です</span>
              </div>
              <div class="overflow-x-auto">
                <table class="grid-legacy">
                  <thead>
                    <tr>
                      <th style="width:80px">日付</th><th>顧客名</th><th>工事名</th><th style="width:80px">売上(見積)</th><th style="width:80px">発注(予定)</th><th style="width:80px">請求(確定)</th><th style="width:70px">粗利</th><th style="width:40px">%</th><th style="width:70px">入金</th><th style="width:50px">状態</th><th style="width:80px">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="p in filteredProjects" :key="p.id" class="hover:bg-yellow-50 transition">
                      <td class="text-center">{{ p.date }}</td><td class="font-bold text-center">{{ p.client }}</td><td class="text-center truncate max-w-xs">{{ p.project }}</td>
                      <td class="text-right num-cell font-mono">{{ formatCurrency(p.totalAmount) }}</td>
                      <td class="text-right num-cell font-mono text-orange-900">{{ formatCurrency(p.totalOrderAmount) }}</td>
                      <td class="text-right num-cell font-mono text-purple-900 font-bold">{{ formatCurrency(p.totalInvoicedAmount) }}</td>
                      <td class="text-right num-cell font-mono" :class="p.totalAmount-p.totalOrderAmount < 0 ? 'text-red-600 font-bold':''">{{ formatCurrency(p.totalAmount - p.totalOrderAmount) }}</td>
                      <td class="text-center text-[10px]" :class="((p.totalAmount-p.totalOrderAmount)/p.totalAmount*100) < 15 ? 'text-red-600':''">{{ p.totalAmount ? ((p.totalAmount-p.totalOrderAmount)/p.totalAmount*100).toFixed(0) : 0 }}%</td>
                      <td class="text-center">
                        <template v-if="p.depositCount > 0">
                          <span class="text-[10px] font-bold px-1 rounded" :class="p.totalDeposit >= Math.floor(p.totalAmount * 1.1) ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'">{{ p.totalDeposit >= Math.floor(p.totalAmount * 1.1) ? '入金済' : '一部入金' }}</span>
                          <div class="text-[9px] font-mono text-gray-600">{{ formatCurrency(p.totalDeposit) }}</div>
                        </template>
                        <span v-else class="text-[10px] text-gray-400">未入金</span>
                      </td>
                      <td class="text-center text-[10px]"><span class="bg-gray-100 px-1 rounded">{{ p.status }}</span></td>
                      <td class="text-center">
                          <button @click="loadEstimate(p.id, true)" class="text-blue-700 underline text-[10px] hover:text-blue-900 mr-2">開く</button>
                          <button @click="openLedger(p.id)" class="text-green-700 underline text-[10px] hover:text-green-900">台帳</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 発注案件一覧タブ -->
          <div v-if="listSubTab==='order'">
            <div class="bg-white p-4 border border-gray-400 rounded shadow-sm">
              <div class="flex flex-wrap gap-4 items-end mb-4">
                <div><label class="text-[10px] block font-bold">表示年</label><select v-model="orderListFilter.year" class="border p-1 text-xs w-24 bg-gray-50"><option value="">全て</option><option v-for="y in orderListYears" :key="y" :value="y">{{ y }}年</option></select></div>
                <div><label class="text-[10px] block font-bold">表示月</label><select v-model="orderListFilter.month" class="border p-1 text-xs w-24 bg-gray-50"><option value="">全て</option><option v-for="m in 12" :key="m" :value="m">{{ m }}月</option></select></div>
                <div><label class="text-[10px] block font-bold">発注先で絞り込み</label>
                  <select v-model="orderListFilter.vendor" class="border p-1 text-xs w-48 bg-gray-50">
                    <option value="">全ての発注先</option>
                    <option v-for="v in orderListVendors" :key="v" :value="v">{{v}}</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <div class="stat-card"><div class="stat-label">発注件数</div><div class="stat-val">{{ filteredOrderList.length }}</div></div>
                <div class="stat-card"><div class="stat-label">発注総額</div><div class="stat-val text-orange-800">{{ formatCurrency(filteredOrderList.reduce((s,o)=>s+o.totalAmount,0)) }}</div></div>
                <div class="stat-card"><div class="stat-label">出金済</div><div class="stat-val text-red-700">{{ formatCurrency(filteredOrderList.reduce((s,o)=>s+(o.totalPaid||0),0)) }}</div></div>
                <div class="stat-card"><div class="stat-label">未払残高</div><div class="stat-val text-blue-700">{{ formatCurrency(filteredOrderList.reduce((s,o)=>s+o.totalAmount-(o.totalPaid||0),0)) }}</div></div>
              </div>
            </div>

            <div class="bg-white border border-gray-400 rounded overflow-hidden mt-4">
              <div class="bg-orange-50 p-2 text-xs font-bold border-b border-gray-400 flex justify-between">
                <span>発注案件リスト ({{ filteredOrderList.length }}件)</span>
                <span class="text-gray-500">※出金データと連携しています</span>
              </div>
              <div class="overflow-x-auto">
                <table class="grid-legacy">
                  <thead>
                    <tr>
                      <th style="width:80px">発注日</th><th style="width:90px">作成者</th><th>発注先</th><th>工事名</th><th style="width:90px">発注金額</th><th style="width:60px">PDF</th><th style="width:90px">出金済</th><th style="width:70px">振込状況</th><th style="width:80px">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="o in filteredOrderList" :key="o.id" class="hover:bg-orange-50 transition">
                      <td class="text-center text-xs">{{ o.date }}</td>
                      <td class="text-center text-[10px] truncate max-w-[80px]">{{ o.creator ? o.creator.split('@')[0] : '-' }}</td>
                      <td class="font-bold text-center">{{ o.vendor }}</td>
                      <td class="text-center truncate max-w-xs text-xs">{{ o.project || o.relEstId || '-' }}</td>
                      <td class="text-right num-cell font-mono">{{ formatCurrency(o.totalAmount) }}</td>
                      <td class="text-center">
                        <span v-if="o.hasPdf" class="text-[10px] bg-green-200 text-green-800 px-1 rounded font-bold">作成済</span>
                        <span v-else class="text-[10px] bg-gray-200 text-gray-600 px-1 rounded">未作成</span>
                      </td>
                      <td class="text-right num-cell font-mono text-red-700">{{ formatCurrency(o.totalPaid || 0) }}</td>
                      <td class="text-center">
                        <template v-if="o.paymentCount > 0">
                          <span class="text-[10px] font-bold px-1 rounded" :class="(o.totalPaid||0) >= o.totalAmount ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'">{{ (o.totalPaid||0) >= o.totalAmount ? '振込済' : '一部振込' }}</span>
                        </template>
                        <span v-else class="text-[10px] text-gray-400">未振込</span>
                      </td>
                      <td class="text-center">
                        <button @click="reprintOrderPdf(o.id)" class="text-blue-700 underline text-[10px] hover:text-blue-900">PDF</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div v-if="filteredOrderList.length === 0" class="p-8 text-center text-gray-500 text-sm">発注データがありません</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 編集画面(見積) -->
        <div v-if="currentTab === 'edit'" class="space-y-4">
          <div class="flex justify-between items-center bg-white p-3 border border-gray-400 rounded shadow-sm">
             <h2 class="font-bold text-lg flex items-center gap-2"><span class="material-icons text-blue-600">edit_note</span> 見積編集</h2>
             <div class="flex items-center gap-2">
               <button @click="toggleSidePanel('order')" class="bg-orange-50 text-orange-700 border border-orange-300 px-3 py-1.5 text-xs font-bold rounded hover:bg-orange-100 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">shopping_cart</span> 発注書修正
               </button>
               <button @click="openFloatingPanelList('estimate', 'estimate')" class="bg-teal-50 text-teal-700 border border-teal-300 px-3 py-1.5 text-xs font-bold rounded hover:bg-teal-100 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">description</span> 見積履歴
               </button>
               <button @click="openFloatingPanelList('order', 'estimate')" class="bg-indigo-50 text-indigo-700 border border-indigo-300 px-3 py-1.5 text-xs font-bold rounded hover:bg-indigo-100 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">local_shipping</span> 発注履歴
               </button>

               <button v-if="showBackButton || isReviewMode" @click="checkUnsavedChanges(() => handleBack())" class="bg-gray-100 border border-gray-400 px-4 py-1.5 text-xs font-bold rounded hover:bg-gray-200 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">arrow_back</span> 戻る
               </button>
               <button @click="clearEstimateForm" class="bg-red-50 text-red-700 border border-red-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-red-100 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">delete_sweep</span> クリア
               </button>
               <button v-if="formSnapshot && formSnapshot.source === 'edit'" @click="restoreSnapshot" class="bg-blue-50 text-blue-700 border border-blue-300 px-4 py-1.5 text-xs font-bold rounded hover:bg-blue-100 shadow-sm transition flex items-center gap-1">
                  <span class="material-icons text-[14px]">undo</span> 元に戻す
               </button>
             </div>
          </div>
          
          <div class="edit-split-wrapper">
              <!-- 左パネル (単価マスタ/セット) -->
              <div class="edit-left-panel" :class="{ 'is-open': leftPanelMode !== null && leftPanelContext === 'estimate' }">
                  <div class="bg-gray-100 border-b border-gray-300 flex justify-between items-center px-2 py-1">
                    <span class="font-bold text-sm text-gray-700">
                      {{ leftPanelMode === 'price' ? '単価マスタ選択' : leftPanelMode === 'material' ? '材料費単価マスタ' : '元請見積履歴' }}
                    </span>
                    <button @click="closeLeftPanel" class="text-gray-500 hover:text-gray-800 font-bold text-lg px-2">×</button>
                  </div>
                  
                  <div class="p-2 border-b bg-white">
                    <input v-if="leftPanelMode === 'price'" v-model="searchMasterKeyword" class="w-full border p-1 text-xs" placeholder="品名・仕様・企業名・基本など スペースでAND検索">
                    <input v-if="leftPanelMode === 'set'" v-model="searchSetKeyword" class="w-full border p-1 text-xs" placeholder="セット名で検索...">
                    <input v-if="leftPanelMode === 'material'" v-model="searchMaterialKeyword" class="w-full border p-1 text-xs" placeholder="品名・仕様・単位 スペースでAND検索">
                  </div>

                  <div class="edit-left-panel-scroll bg-gray-50 p-2">
                    <div v-if="leftPanelMode === 'price'">
                      <div v-if="filteredMasters.length === 0" class="p-4 text-center text-xs text-gray-500">該当データなし</div>
                      <div v-for="(m, i) in filteredMasters" :key="i" @mousedown="applyMasterItem(m)" class="bg-white mb-2 rounded shadow-sm hover:bg-blue-50 cursor-pointer overflow-hidden">
                        <div class="grid grid-cols-3 gap-0 border border-gray-200">
                          <div class="border-r border-gray-200 p-1.5">
                            <div class="text-[9px] text-gray-500 mb-0.5">品名</div>
                            <div class="text-xs font-bold text-blue-900 break-words whitespace-normal leading-relaxed">{{ m.product }}</div>
                          </div>
                          <div class="border-r border-gray-200 p-1.5">
                            <div class="text-[9px] text-gray-500 mb-0.5">仕様</div>
                            <div class="text-[10px] text-gray-600 break-words whitespace-normal leading-relaxed">{{ m.spec || '-' }}</div>
                          </div>
                          <div class="p-1.5 bg-blue-50/50">
                            <div class="text-[9px] text-gray-500 mb-0.5">単価</div>
                            <div class="text-xs font-mono font-bold text-blue-900">{{ formatCurrency(m.price) }}</div>
                          </div>
                        </div>
                        <div class="text-[9px] text-gray-400 px-1.5 py-0.5 bg-gray-50 border-t border-gray-100">{{ m.source }}</div>
                      </div>
                    </div>

                    <div v-if="leftPanelMode === 'set'">
                      <div v-if="filteredSets.length === 0" class="p-4 text-center text-xs text-gray-500">該当セットなし</div>
                      <div v-for="s in filteredSets" :key="s.name" @mousedown="applySetItem(s.name)" class="bg-white mb-1 p-2 rounded shadow-sm hover:bg-green-50 cursor-pointer">
                        <div class="font-bold text-green-900 text-xs">{{ s.name }}</div>
                        <div v-if="s.firstItem" class="text-gray-500 text-[10px] truncate">{{ s.firstItem }}</div>
                        <div class="text-gray-600 text-[10px] flex justify-between">
                          <span>{{ s.count }}点</span>
                          <span class="font-mono">約 {{ formatCurrency(s.totalPrice) }}</span>
                        </div>
                      </div>
                    </div>

                    <div v-if="leftPanelMode === 'material'">
                      <button v-if="materialEditIdx !== 'new'" @click="openMaterialAdd" class="w-full bg-teal-600 text-white text-xs py-1.5 rounded hover:bg-teal-700 flex items-center justify-center gap-1 mb-2">
                        <span class="material-icons" style="font-size:14px">add</span>新規追加
                      </button>
                      <!-- 新規追加カード -->
                      <div v-if="materialEditIdx === 'new'" class="bg-white mb-2 rounded shadow-sm overflow-hidden border-2 border-teal-400">
                        <div class="grid grid-cols-3 gap-0 border-b border-gray-200">
                          <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.product" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="品名 (必須)"></div>
                          <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.spec" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="仕様"></div>
                          <div class="p-1"><input v-model.number="materialEditData.price" type="number" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="単価"></div>
                        </div>
                        <div class="flex items-center justify-between px-1.5 py-1 bg-gray-50">
                          <input v-model="materialEditData.unit" class="border border-teal-300 p-0.5 text-xs rounded w-16" placeholder="単位">
                          <span class="flex gap-1">
                            <button @click="saveMaterialItem" class="bg-teal-600 text-white text-[10px] px-2 py-0.5 rounded hover:bg-teal-700">保存</button>
                            <button @click="cancelMaterialEdit" class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded hover:bg-gray-300">取消</button>
                          </span>
                        </div>
                      </div>
                      <div v-if="filteredMaterialPrices.length === 0" class="p-4 text-center text-xs text-gray-500">該当データなし</div>
                      <div v-for="(m, i) in filteredMaterialPrices" :key="i" class="bg-white mb-2 rounded shadow-sm overflow-hidden" :class="materialEditIdx === i ? 'border-2 border-teal-400' : ''">
                        <!-- 編集モード -->
                        <template v-if="materialEditIdx === i">
                          <div class="grid grid-cols-3 gap-0 border-b border-gray-200">
                            <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.product" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="品名"></div>
                            <div class="border-r border-gray-200 p-1"><input v-model="materialEditData.spec" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="仕様"></div>
                            <div class="p-1"><input v-model.number="materialEditData.price" type="number" class="w-full border border-teal-300 p-1 text-xs rounded" placeholder="単価"></div>
                          </div>
                          <div class="flex items-center justify-between px-1.5 py-1 bg-gray-50">
                            <input v-model="materialEditData.unit" class="border border-teal-300 p-0.5 text-xs rounded w-16" placeholder="単位">
                            <span class="flex gap-1">
                              <button @click="saveMaterialItem" class="bg-teal-600 text-white text-[10px] px-2 py-0.5 rounded hover:bg-teal-700">保存</button>
                              <button @click="cancelMaterialEdit" class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded hover:bg-gray-300">取消</button>
                            </span>
                          </div>
                        </template>
                        <!-- 表示モード -->
                        <template v-else>
                          <div @mousedown="applyMasterItem({product: m.product, spec: m.spec, unit: m.unit, price: m.price, category: '-', source: '材料費'})" class="grid grid-cols-3 gap-0 border border-gray-200 hover:bg-teal-50 cursor-pointer">
                            <div class="border-r border-gray-200 p-1.5"><div class="text-[9px] text-gray-500 mb-0.5">品名</div><div class="text-xs font-bold text-teal-900 break-words whitespace-normal leading-relaxed">{{ m.product }}</div></div>
                            <div class="border-r border-gray-200 p-1.5"><div class="text-[9px] text-gray-500 mb-0.5">仕様</div><div class="text-[10px] text-gray-600 break-words whitespace-normal leading-relaxed">{{ m.spec || '-' }}</div></div>
                            <div class="p-1.5 bg-teal-50/50"><div class="text-[9px] text-gray-500 mb-0.5">単価</div><div class="text-xs font-mono font-bold text-teal-900">{{ formatCurrency(m.price) }}</div></div>
                          </div>
                          <div class="text-[9px] text-gray-400 px-1.5 py-0.5 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                            <span>{{ m.unit || '-' }} / {{ m.updatedAt }}</span>
                            <span class="flex gap-1">
                              <button @click.stop="openMaterialEdit(m, i)" class="text-blue-500 hover:text-blue-700" title="編集"><span class="material-icons" style="font-size:13px">edit</span></button>
                              <button @click.stop="deleteMaterialItem(m)" class="text-red-400 hover:text-red-600" title="削除"><span class="material-icons" style="font-size:13px">delete</span></button>
                            </span>
                          </div>
                        </template>
                      </div>
                    </div>
                  </div>
              </div>

              <!-- 中央：見積明細エリア -->
              <div class="edit-main legacy-card p-4 rounded shadow-inner relative">
                <!-- 見積入力ヘッダー -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 mb-4 bg-white/50 p-2 rounded border border-black/10">
                  <div class="flex items-center">
                      <label class="w-16 text-xs font-bold">日付:</label>
                      <input type="date" v-model="form.header.date" class="input-base text-xs">
                  </div>
                  <div class="flex items-center relative">
                      <label class="w-16 text-xs font-bold">顧客名:</label>
                      <input type="text" v-model="form.header.client"
                             @focus="clientDropdown.show = true; clientDropdown.filter = form.header.client"
                             @input="clientDropdown.filter = form.header.client; onClientInput($event)"
                             @blur="setTimeout(() => clientDropdown.show = false, 200)"
                             class="input-base text-xs" placeholder="クリックで候補表示" autocomplete="off">
                      <div v-if="clientDropdown.show && filteredCompanies.length"
                           class="absolute top-full left-16 right-0 z-50 bg-white border border-gray-300 rounded shadow-lg max-h-60 overflow-y-auto">
                        <div v-for="c in filteredCompanies" :key="c.name"
                             @mousedown.prevent="form.header.client = c.name; clientDropdown.show = false; onClientInput({target:{value:c.name}})"
                             class="px-3 py-1.5 text-xs cursor-pointer hover:bg-blue-100 flex justify-between items-center">
                          <span>{{ c.name }}</span>
                          <span class="text-[10px] px-1 rounded"
                                :class="c.type === '元請' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'">{{ c.type }}</span>
                        </div>
                      </div>
                  </div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">状態:</label><select v-model="form.header.status" class="input-base text-xs"><option>下書き</option><option>見積提出</option><option>成約</option><option>失注</option><option>保留</option><option>管理者確認中</option></select></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">工事名:</label><input type="text" v-model="form.header.project" class="input-base text-xs"></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">工事場所:</label><input type="text" v-model="form.header.location" class="input-base text-xs"></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">工期:</label><input type="text" v-model="form.header.period" class="input-base text-xs"></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">支払条件:</label><input type="text" v-model="form.header.payment" class="input-base text-xs"></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">有効期限:</label><input type="text" v-model="form.header.expiry" class="input-base text-xs"></div>
                  <div class="flex items-center"><label class="w-16 text-xs font-bold">税区分:</label><select v-model="form.header.taxMode" class="input-base text-xs"><option>税別</option><option>税込</option></select></div>
                </div>

                <!-- 改善5: 統一ツールバー（モード廃止・チェックボックス常設） -->
                <div class="flex justify-between items-center mb-2 px-2 flex-wrap gap-1">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">
                      <span class="material-icons text-sm align-middle">check_box</span>
                      選択: <b>{{ selectedItemsCount }}</b>件
                    </span>
                    <button @click="selectAllRows" class="px-2 py-1 bg-blue-100 rounded hover:bg-blue-200 font-bold text-xs">全選択</button>
                    <button @click="clearAllSelection" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 font-bold text-xs">全解除</button>
                  </div>
                  <div class="flex items-center gap-1">
                    <button @click="selectByVendorPrompt" class="px-2 py-1 bg-orange-100 rounded hover:bg-orange-200 text-xs font-bold" title="同じ発注先の行を一括選択">
                      <span class="material-icons text-xs align-middle">store</span> 業者別選択
                    </button>
                    <button @click="selectByCategoryPrompt" class="px-2 py-1 bg-teal-100 rounded hover:bg-teal-200 text-xs font-bold" title="同じ工種の行を一括選択">
                      <span class="material-icons text-xs align-middle">category</span> 工種別選択
                    </button>
                    <button @click="selectByProductPrompt" class="px-2 py-1 bg-purple-100 rounded hover:bg-purple-200 text-xs font-bold" title="同じ品名の行を一括選択">
                      <span class="material-icons text-xs align-middle">inventory_2</span> 品名別選択
                    </button>
                    <button @click="selectUnorderedRows" class="px-2 py-1 bg-red-100 rounded hover:bg-red-200 text-xs font-bold" title="未発注行を一括選択">
                      <span class="material-icons text-xs align-middle">warning</span> 未発注選択
                    </button>
                  </div>
                </div>

                <!-- 一括単価変更ツールバー -->
                <div class="flex items-center gap-2 mb-2 px-2 py-1 bg-yellow-50 border border-yellow-200 rounded flex-wrap">
                  <span class="text-xs font-bold text-yellow-800">
                    <span class="material-icons text-sm align-middle">percent</span> 一括単価変更
                  </span>
                  <select v-model="bulkPriceTarget" class="text-xs border rounded px-1 py-0.5">
                    <option value="price">見積単価</option>
                    <option value="cost">原価単価</option>
                    <option value="both">両方</option>
                  </select>
                  <div class="flex items-center gap-0.5">
                    <num-input v-model="bulkPricePercent" class="w-16 text-xs border rounded px-1 py-0.5 text-right" placeholder="10" />
                    <span class="text-xs font-bold">%</span>
                  </div>
                  <button @click="applyBulkPriceChange" class="px-2 py-0.5 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs font-bold">
                    適用<span v-if="selectedItemsCount > 0">（選択 {{ selectedItemsCount }}件）</span><span v-else>（全行）</span>
                  </button>
                  <span class="text-xs text-gray-500">※ 選択行がある場合は選択行のみ適用</span>
                </div>

                <!-- 見積入力明細 -->
                <div class="edit-table-scroll" style="height: calc(100vh - 350px); min-height: 200px; border: 1px solid #999;">
                  <table class="grid-legacy w-full min-w-[1000px]">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                      <tr>
                        <th rowspan="2" style="width:28px;"><input type="checkbox" :checked="selectedItemsCount === form.items.length && form.items.length > 0" @change="$event.target.checked ? selectAllRows() : clearAllSelection()" title="全選択/解除"></th><th rowspan="2" style="width:30px;"></th><th rowspan="2" style="width:140px;">品名</th><th rowspan="2" style="width:100px;">仕様</th><th rowspan="2" style="width:50px;">数量</th><th rowspan="2" style="width:40px;">単位</th>
                        <th colspan="2" class="bg-blue-100 text-blue-900 border-l border-r border-blue-300">【見積（売価）】</th>
                        <th colspan="5" class="bg-orange-100 text-orange-900 border-l border-r border-orange-300">【実行（原価）/ 発注】</th>
                        <th rowspan="2" class="w-16 bg-green-100 text-green-900">粗利%</th>
                        <th rowspan="2" style="width:28px;"></th>
                      </tr>
                      <tr>
                        <th style="width:80px;" class="bg-blue-50">単価</th><th style="width:90px;" class="bg-blue-50">金額</th>
                        <th style="width:120px;" class="bg-orange-50">発注先</th><th style="width:80px;" class="bg-orange-50">原価単価</th><th style="width:60px;" class="bg-orange-50">発注数</th><th style="width:40px;" class="bg-orange-50">単位</th><th style="width:80px;" class="bg-orange-50">発注金額</th>
                      </tr>
                    </thead>
                    <tbody @input.capture="isDirty=true" @change.capture="isDirty=true">
                      <tr v-for="(item, idx) in form.items" :key="item._uid || idx" :id="'item-row-' + idx"
                          @contextmenu.prevent="onRowContextMenu($event, idx, 'estimate')"
                          @click="sidePanelMode === 'order' ? handleEstimateRowClick(item, idx) : null"
                          :class="{
                            'bg-blue-100': item.selected,
                            'hover:bg-gray-50': !item.selected,
                            'cursor-pointer hover:bg-orange-100 border-l-4 border-orange-500': sidePanelMode === 'order' && !item.selected,
                            'bg-blue-50': activeLeftPanelRow === idx && !item.selected
                          }">
                        <td class="text-center" style="cursor:pointer; user-select:none;">
                          <input type="checkbox" v-model="item.selected" @click.stop="handleRowSelection(idx, $event)" tabindex="-1">
                        </td>
                        <td class="text-center bg-gray-100">{{ idx+1 }}</td>
                        <td class="relative">
                            <textarea v-model="item.product" @focus="openLeftPanel('price', idx)" class="input-cell font-bold" placeholder="品名" rows="1" v-auto-resize @click.stop :data-row="idx" data-col="0" @keydown="cellNav($event)"></textarea>
                        </td>
                        <td><textarea v-model="item.spec" class="input-cell text-xs" placeholder="仕様" rows="1" v-auto-resize @click.stop :data-row="idx" data-col="1" @keydown="cellNav($event)"></textarea></td>
                        <td><num-input :model-value="item.qty" @update:model-value="v => { item.qty = v; calcLine(item) }" class="input-cell num-cell bg-blue-50" @click.stop :data-row="idx" data-col="2" @keydown="cellNav($event)" /></td>
                        <td><input type="text" v-model="item.unit" list="unit-list" class="input-cell text-center" placeholder="-" @click.stop :data-row="idx" data-col="3" @keydown="cellNav($event)"></td>
                        <td style="background:#E3F2FD" class="relative group">
                            <div class="price-cell-wrap">
                              <num-input :model-value="item.price" @update:model-value="v => { item.price = v; calcLine(item) }" @click.stop :data-row="idx" data-col="4" @keydown="cellNav($event)" />
                              <span v-if="getPricePct(item)" class="pct-label" :class="Number(getPricePct(item)) > 0 ? 'text-blue-600' : 'text-red-500'">({{ Number(getPricePct(item)) > 0 ? '+' : '' }}{{ getPricePct(item) }}%)</span>
                            </div>
                            <button v-if="!item.price && item.product" @click.stop="predictPrice(item)" class="absolute top-0 left-0 bg-purple-600 text-white text-[10px] px-1 opacity-20 hover:opacity-100 transition-opacity" title="AI単価予測">AI</button>
                        </td>
                        <td class="num-cell font-mono bg-blue-100 font-bold text-blue-900">{{ item.amount ? formatCurrency(item.amount) : '' }}</td>

                        <td class="bg-orange-50"><input type="text" v-model="item.vendor" list="vendor-list" class="input-cell text-xs" placeholder="業者選択..." @click.stop :data-row="idx" data-col="5" @keydown="cellNav($event)"></td>
                        <td class="bg-orange-50">
                            <div class="price-cell-wrap">
                              <num-input :model-value="item.cost" @update:model-value="v => { item.cost = v; calcLine(item) }" @click.stop :data-row="idx" data-col="6" @keydown="cellNav($event)" />
                              <span v-if="getCostPct(item)" class="pct-label" :class="Number(getCostPct(item)) > 0 ? 'text-orange-600' : 'text-red-500'">({{ Number(getCostPct(item)) > 0 ? '+' : '' }}{{ getCostPct(item) }}%)</span>
                            </div>
                        </td>
                        <td class="bg-orange-50"><num-input :model-value="item.orderedQty" @update:model-value="v => { item.orderedQty = v; calcLine(item) }" class="input-cell num-cell" @click.stop :data-row="idx" data-col="7" @keydown="cellNav($event)" /></td>
                        <td class="bg-orange-50"><input type="text" v-model="item.exeUnit" list="unit-list" class="input-cell text-center" placeholder="-" @click.stop :data-row="idx" data-col="8" @keydown="cellNav($event)"></td>
                        <td class="num-cell font-mono bg-orange-100 text-orange-900 font-bold">{{ (item.orderedQty && item.cost) ? formatCurrency(Math.round(item.orderedQty * item.cost)) : '' }}</td>
                        
                        <td class="text-right num-cell font-bold" :class="(item.amount && item.qty && item.cost) ? ((item.amount - item.qty * item.cost) / item.amount * 100 < 15 ? 'text-red-500' : 'text-green-700') : ''">
                          <span v-if="Number(item.price) && Number(item.qty)">{{ calculateMargin(item) }}%</span>
                          <span v-else class="text-gray-400">-</span>
                        </td>
                        <td class="text-center"><button @click.stop="removeItem(idx)" class="text-gray-400 hover:text-red-500 text-sm font-bold">×</button></td>
                      </tr>
                    </tbody>
                  </table>
                  <button @click="addItem" class="mt-2 w-full py-2 border border-dashed border-gray-400 text-gray-500 text-xs hover:bg-white transition font-bold">+ 行追加</button>
                </div>
                
                <div class="mt-2 flex justify-end gap-6 text-sm font-bold p-3 bg-white border border-gray-400 shadow-sm flex-wrap">
                   <div class="text-orange-800">発注合計(原価): <span class="text-xl">{{ formatCurrency(totalEstimatedCost) }}</span></div>
                   <div class="text-blue-900 border-l pl-4 border-gray-400">見積合計(売上): <span class="text-xl">{{ formatCurrency(totalAmount) }}</span></div>
                   <div class="border-l pl-4 border-gray-400" :class="totalAmount-totalEstimatedCost >= 0 ? 'text-green-700' : 'text-red-700'">
                       粗利: <span class="text-xl">{{ formatCurrency(totalAmount-totalEstimatedCost) }}</span>
                       <span class="text-xs bg-gray-200 px-1 rounded ml-1">{{ totalAmount ? (((totalAmount - totalEstimatedCost) / totalAmount) * 100).toFixed(1) : 0 }}%</span>
                   </div>
                   <div class="border-l pl-4 border-gray-400 text-orange-700">
                       発注割合(原価率): <span class="text-xl">{{ totalAmount ? ((totalEstimatedCost / totalAmount) * 100).toFixed(1) : 0 }}%</span>
                   </div>
                </div>
              </div>
              <!-- 右サイドパネル (発注作成) - Flexの右カラム -->
              <div class="edit-right-panel" :class="{ 'is-open': sidePanelMode !== null }">
                  <div class="bg-gray-100 border-b border-gray-300 flex justify-between items-center px-2 py-1">
                    <span class="font-bold text-sm text-gray-700">発注先変更パネル</span>
                    <button @click="closeSidePanel" class="text-gray-500 hover:text-gray-800 font-bold text-lg px-2">×</button>
                  </div>

                  <div class="side-panel-content flex-1 flex flex-col min-h-0 bg-gray-50 relative">
                    <!-- 発注書作成モード -->
                    <div v-if="sidePanelMode === 'order'" class="flex-1 flex flex-col min-h-0">
                        <!-- 新規作成 -->
                        <div class="flex-1 flex flex-col min-h-0">
                            <div class="p-2 text-xs bg-green-50 text-green-800 border-b border-green-200 flex-shrink-0">
                                <span class="material-icons text-sm align-middle">info</span> 発注専用の単価を設定できます。見積原価は参照のみです。
                            </div>
                            
                            <!-- 選択行の一括操作（パネル全体に広がる） -->
                            <div v-if="selectedItemsCount > 0" class="flex-1 flex flex-col min-h-0 bg-blue-50 border-b-2 border-blue-300 p-3 overflow-hidden">
                                <div class="text-xs font-bold mb-1.5 text-blue-800 flex-shrink-0">
                                    選択行の一括操作 ({{ selectedItemsCount }}件)
                                </div>
                                <!-- 発注先プルダウン -->
                                <div class="mb-2 flex-shrink-0">
                                    <select v-model="batchVendorSelect" class="w-full border border-blue-300 rounded px-2 py-1.5 text-xs bg-white">
                                        <option value="">発注先を選択</option>
                                        <option v-for="v in (masters.vendors || [])" :key="v.displayName || v.name" :value="v.displayName || v.name">{{ v.displayName || v.name }}</option>
                                    </select>
                                </div>
                                <!-- 選択行の一覧（最大320px、超えたらスクロール） -->
                                <div class="max-h-80 overflow-y-auto border border-gray-200 rounded bg-white mb-2">
                                    <div v-for="(item, idx) in form.items.filter(i => i.selected)" :key="idx" class="p-1.5 border-b border-gray-100 text-xs">
                                        <div class="font-bold truncate">{{ item.product }} <span class="text-gray-500 font-normal">{{ item.spec }}</span></div>
                                        <div class="flex justify-between text-[10px] text-gray-500">
                                            <span>数量: {{ formatCurrency(item.qty) }} {{ item.unit }}</span>
                                            <span>発注先: {{ item.vendor || '未設定' }}</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- 一括適用ボタン -->
                                <div class="flex-shrink-0">
                                    <button @click="batchUpdateVendor" 
                                            :disabled="!batchVendorSelect"
                                            class="w-full bg-orange-600 text-white px-4 py-2 rounded font-bold text-xs hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1">
                                        <span class="material-icons text-sm">sync_alt</span> 一括適用
                                    </button>
                                    <div class="text-[10px] text-gray-500 mt-1 text-center">
                                        ※見積に反映されます
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="orderInPanel.items.length === 0 && selectedItemsCount === 0" class="p-4 text-center text-gray-500 text-xs">
                                <div class="font-bold mb-2 text-gray-600">使い方</div>
                                1. 見積明細の行を<strong>クリック</strong>してパネルに追加<br>
                                2. 発注先・単価を変更<br>
                                3. 下部の「<strong>保存（見積に反映）</strong>」ボタンを押す
                            </div>

                            <div v-if="orderInPanel.items.length > 0" class="flex-1 overflow-y-auto min-h-0">
                                <div v-for="(item, i) in orderInPanel.items" :key="i" class="bg-white p-2 border-b border-gray-200 text-xs relative group hover:bg-orange-50">
                                    <button @click="removeOrderItem(i)" class="absolute top-1 right-1 text-gray-400 hover:text-red-500 font-bold">×</button>
                                    <div class="font-bold mb-1 pr-4 truncate">{{ item.product }} <span class="text-gray-500 font-normal">{{ item.spec }}</span></div>
                                    <div class="grid grid-cols-2 gap-2 mb-1">
                                        <div>
                                            <label class="block text-[9px] text-gray-500">発注先</label>
                                            <input type="text" v-model.lazy="item.vendor" list="vendor-list" class="border p-1 w-full text-xs" placeholder="業者を選択">
                                        </div>
                                        <div>
                                            <label class="block text-[9px] text-gray-500">発注単価</label>
                                            <num-input v-model="item.cost" class="border p-1 w-full text-right" placeholder="単価" />
                                        </div>
                                    </div>
                                    <div v-if="item.estimateCost" class="text-[9px] text-gray-400 mb-1 px-1">
                                        見積原価参考: {{ formatCurrency(item.estimateCost) }}
                                        <span v-if="Number(item.cost) !== Number(item.estimateCost)" class="text-orange-600 font-bold ml-1">
                                            (差額: {{ formatCurrency(Number(item.cost) - Number(item.estimateCost)) }})
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 items-end">
                                        <div>
                                            <label class="block text-[9px] text-gray-500">発注数</label>
                                            <div class="flex items-center">
                                                <num-input v-model="item.qty" class="border p-1 w-full text-right" />
                                                <span class="ml-1 text-[10px]">{{ item.unit }}</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <label class="block text-[9px] text-gray-500">発注金額</label>
                                            <div class="font-mono font-bold text-orange-800">{{ formatCurrency((item.qty||0)*(item.cost||0)) }}</div>
                                        </div>
                                        <div class="text-right">
                                            <label class="block text-[9px] text-gray-500">粗利%</label>
                                            <div class="font-bold" :class="calcPanelMargin(item) < 15 ? 'text-red-500' : 'text-green-700'">
                                                {{ calcPanelMargin(item) }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- パネル下部: 発注先一括変更・保存ボタン -->
                            <div v-if="orderInPanel.items.length > 0" class="flex-shrink-0 border-t-2 border-gray-300 bg-gray-50 p-3 space-y-3">
                                <template v-if="orderInPanel.items.length > 0">
                                    <div class="bg-yellow-50 border border-yellow-300 p-2 rounded">
                                        <div class="text-xs font-bold mb-1.5 text-gray-700 flex items-center gap-1">
                                            <span class="material-icons text-sm">business</span> 発注先を一括変更
                                        </div>
                                        <div class="flex gap-2">
                                            <select v-model="tempBatchVendor" class="border border-gray-300 p-2 flex-1 text-xs rounded"><option value="">発注先を選択</option><option v-for="v in masters.vendors" :key="v.displayName" :value="v.displayName">{{ v.displayName }}</option></select>
                                            <button @click="applyBatchVendorToPanel" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs hover:bg-blue-700 flex items-center gap-1 whitespace-nowrap">
                                                <span class="material-icons text-sm">sync_alt</span> 一括適用
                                            </button>
                                        </div>
                                        <div class="text-[10px] text-gray-500 mt-1">
                                            ※ 全明細に一括適用（未設定も含む）
                                        </div>
                                    </div>
                                    <button @click="saveOrderPanelToEstimate" 
                                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-sm shadow-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <span class="material-icons">save</span> 保存（見積に反映）
                                    </button>
                                    <div class="text-[10px] text-gray-600 text-center">
                                        発注先・単価・数量の変更を見積明細に反映します
                                    </div>
                                </template>
                            </div>
                        </div>


                    </div>
                  </div>
              </div>
          </div>
        </div>

        <!-- 請求書受取など他のタブは変更なし -->
        <div v-if="currentTab === 'invoice'" class="space-y-4">
            <!-- (省略) -->
            <div class="flex justify-between items-center bg-white p-2 border border-gray-400 rounded">
                <h2 class="font-bold">請求書受取処理 (Googleドライブ連携)</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" style="height:calc(100vh - 350px);min-height:300px;">
                <div class="bg-white border border-gray-400 p-2 flex flex-col min-h-0 overflow-hidden">
                    <div class="mb-2 flex-shrink-0">
                        <label class="block w-full bg-green-600 text-white text-center text-sm font-bold py-2 rounded cursor-pointer hover:bg-green-700 transition mb-2">
                            <span class="material-icons text-sm align-middle mr-1">upload_file</span>PDFファイルを読み込む
                            <input type="file" accept=".pdf,image/*" class="hidden" @change="uploadInvoicePdf($event)">
                        </label>
                        <div v-if="uploadedInvoiceFile" class="bg-green-50 border border-green-300 p-1.5 text-xs rounded mb-2">
                            <span class="font-bold text-green-800">読込済:</span> {{ uploadedInvoiceFile.name }}
                            <span v-if="isAnalyzing" class="ml-1 text-blue-600 font-bold animate-pulse">解析中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-xs">未処理ファイル (Drive)</span>
                            <button @click="loadInvoiceFiles" class="text-xs text-blue-600 underline">更新</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto border border-gray-300 min-h-0">
                        <div v-if="invoiceFiles.length === 0" class="p-2 text-xs text-gray-500 text-center">ファイルがありません</div>
                        <div v-for="f in invoiceFiles" :key="f.id"
                             @click="selectInvoiceFile(f)"
                             class="p-2 border-b cursor-pointer hover:bg-blue-100 text-xs"
                             :class="selectedInvoiceFile && selectedInvoiceFile.id === f.id ? 'bg-blue-200' : ''">
                            <div class="font-bold truncate" style="max-width:100%;">{{ f.name }}</div>
                            <div class="text-gray-500">{{ f.updated }}</div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 bg-white border border-gray-400 p-4 min-h-0 overflow-y-auto">
                    <div v-if="invoiceForm.id" class="bg-yellow-100 text-yellow-800 p-2 mb-2 text-xs font-bold border border-yellow-300 flex justify-between items-center">
                        <span>編集中 (ID: {{ invoiceForm.id }})</span>
                        <button @click="resetInvoiceForm" class="text-blue-600 underline">新規入力へ戻る</button>
                    </div>

                    <div v-if="!selectedInvoiceFile && !uploadedInvoiceFile && !invoiceForm.id" class="flex items-center justify-center h-full text-gray-400">
                        PDFを読み込むか、左側のリストからファイルを選択してください
                    </div>
                    
                    <div v-else class="space-y-4">
                        <div v-if="uploadedInvoiceFile" class="bg-green-50 p-2 border border-green-200 text-xs">
                            <span class="font-bold">アップロード済:</span> {{ uploadedInvoiceFile.name }}
                            <span v-if="isAnalyzing" class="ml-2 text-blue-600 font-bold animate-pulse">解析中...</span>
                        </div>
                        <div v-else-if="selectedInvoiceFile" class="bg-blue-50 p-2 border border-blue-200 text-xs">
                            <span class="font-bold">ファイル選択中:</span> {{ selectedInvoiceFile.name }}
                            <span v-if="isAnalyzing" class="ml-2 text-blue-600 font-bold animate-pulse">解析中...</span>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold mb-1">工事番号 (自動)</label>
                                <input v-model="invoiceForm.constructionId" class="input-base bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">担当者</label>
                                <input type="text" v-model="invoiceForm.person" @change="checkOrderBalance" list="vendor-list" class="input-base bg-yellow-50">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">施工者</label>
                                <input type="text" v-model="invoiceForm.contractor" class="input-base bg-yellow-50">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">工事名 (検索・選択)</label>
                                <input v-model="invoiceForm.project" list="active-projects" @change="onProjectSelect" class="input-base bg-yellow-50" placeholder="入力して検索...">
                                <datalist id="active-projects">
                                    <option v-for="p in activeProjects" :key="p.id" :value="p.name" :data-id="p.id"></option>
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">工事場所</label>
                                <input type="text" v-model="invoiceForm.location" class="input-base">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold mb-1">内容</label>
                                <input type="text" v-model="invoiceForm.content" class="input-base">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">着工日</label>
                                <input type="text" v-model="invoiceForm.date" class="input-base" placeholder="yyyy/MM/dd">
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">請求金額 (税込)</label>
                                <num-input v-model="invoiceForm.amount" class="input-base text-right font-mono text-lg" />
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1">相殺額</label>
                                <num-input v-model="invoiceForm.offset" class="input-base text-right font-mono text-lg text-red-600" />
                            </div>
                            <div class="flex items-end justify-end">
                                <div class="font-bold text-lg">支払予定額: {{ formatCurrency(invoiceForm.amount - invoiceForm.offset) }}</div>
                            </div>
                            <div v-if="orderBalance" class="col-span-2 bg-orange-50 border border-orange-200 p-2 text-xs flex justify-between items-center">
                                <div>
                                    <span class="font-bold text-orange-800">発注情報:</span>
                                    発注額: {{ formatCurrency(orderBalance.totalOrder) }} /
                                    既払: {{ formatCurrency(orderBalance.totalPaid) }}
                                </div>
                                <div class="font-bold" :class="orderBalance.balance < 0 ? 'text-red-600' : 'text-blue-600'">
                                    発注残: {{ formatCurrency(orderBalance.balance) }}
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button @click="registerInvoice" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700 font-bold">
                                {{ invoiceForm.id ? '更新する' : '確定・登録する' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 border-t border-gray-400 pt-2">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-sm">登録済み請求書一覧 (編集は行をクリック)</span>
                    <button @click="fetchInvoices" class="text-xs text-blue-600 underline">リスト更新</button>
                </div>
                <div class="overflow-x-auto bg-white border border-gray-300 h-40">
                      <table class="grid-legacy">
                        <thead>
                           <tr>
                             <th>日時</th><th>ステータス</th><th>工事名</th><th>担当者</th><th>施工者</th><th>金額</th><th>操作</th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr v-for="inv in adminInvoices" :key="inv.id" class="hover:bg-yellow-50 cursor-pointer" @click="editInvoice(inv)">
                               <td class="text-center text-[10px]">{{ inv.registeredAt }}</td>
                               <td class="text-center text-xs">{{ inv.status }}</td>
                               <td class="pl-2 text-xs truncate max-w-xs">{{ inv.project }}</td>
                               <td class="pl-2 text-xs">{{ inv.person }}</td>
                               <td class="pl-2 text-xs">{{ inv.contractor }}</td>
                               <td class="text-right num-cell font-mono">{{ formatCurrency(inv.amount) }}</td>
                               <td class="text-center"><button class="bg-gray-200 border px-2 py-0.5 text-[10px]">編集</button></td>
                           </tr>
                        </tbody>
                      </table>
                </div>
            </div>
        </div>

        <!-- 管理者画面 (Phase 1 改修) -->
        <div v-if="currentTab === 'admin'" class="max-w-6xl mx-auto space-y-6">
          <div class="flex border-b border-gray-400 mb-4">
              <button @click="adminSubTab='approval'; loadAdminSubTab('approval')" class="px-4 py-2 font-bold" :class="adminSubTab==='approval' ? 'bg-yellow-100 border-b-2 border-yellow-600' : 'text-gray-500'">承認・管理</button>
              <button @click="loadAnalysis" class="px-4 py-2 font-bold" :class="adminSubTab==='analysis' ? 'bg-indigo-100 border-b-2 border-indigo-600' : 'text-gray-500'">経営分析</button>
              <button @click="adminSubTab='accounting'" class="px-4 py-2 font-bold" :class="adminSubTab==='accounting' ? 'bg-green-100 border-b-2 border-green-600' : 'text-gray-500'">会計連携</button>
              <button @click="adminSubTab='deposits'; fetchDeposits()" class="px-4 py-2 font-bold" :class="adminSubTab==='deposits' ? 'bg-blue-100 border-b-2 border-blue-600' : 'text-gray-500'">入金管理</button>
              <button @click="adminSubTab='payments'; fetchPayments()" class="px-4 py-2 font-bold" :class="adminSubTab==='payments' ? 'bg-red-100 border-b-2 border-red-600' : 'text-gray-500'">出金管理</button>
              <button @click="adminSubTab='settings'; fetchReminderTriggerStatus(); fetchLineSettings()" class="px-4 py-2 font-bold" :class="adminSubTab==='settings' ? 'bg-gray-200 border-b-2 border-gray-600' : 'text-gray-500'">設定</button>
          </div>

          <!-- 承認・管理タブ -->
          <div v-if="adminSubTab === 'approval'" class="space-y-6">
              <div v-if="adminTabLoading" class="text-center py-8 text-gray-500">
                  <span class="material-icons animate-spin" style="font-size:24px">refresh</span>
                  <p class="mt-2 text-sm">データ読込中...</p>
              </div>
              <div class="legacy-card p-4">
                <h2 class="font-bold border-b border-gray-400 mb-2">承認待ち見積書</h2>
                <table class="grid-legacy">
                   <thead><tr><th>日付</th><th>顧客名</th><th>工事名</th><th class="text-right">金額</th><th>操作</th><th>削除</th></tr></thead>
                   <tbody>
                       <tr v-for="p in adminProjects" :key="p.id">
                           <td class="text-center">{{ p.date }}</td>
                           <td class="font-bold text-center">{{ p.client }}</td>
                           <td class="text-center">{{ p.project }}</td>
                           <td class="text-right">{{ formatCurrency(p.totalAmount) }}</td>
                           <td class="text-center"><button @click="loadEstimate(p.id)" class="bg-yellow-400 border border-yellow-600 px-2 text-xs">確認</button></td>
                           <td class="text-center"><button @click="deleteItem(p.id)" class="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">削除</button></td>
                       </tr>
                   </tbody>
                </table>
                <div v-if="adminProjects.length===0" class="text-center py-4 text-gray-500">承認待ち見積書はありません</div>
              </div>
              
              <div class="legacy-card p-4">
                <h2 class="font-bold border-b border-gray-400 mb-2">承認待ち発注書</h2>
                <table class="grid-legacy">
                   <thead><tr><th>日付</th><th>発注先</th><th>納品場所</th><th class="text-right">金額</th><th>操作</th><th>削除</th></tr></thead>
                   <tbody>
                       <tr v-for="o in adminOrders" :key="o.id">
                           <td class="text-center">{{ o.date }}</td>
                           <td class="font-bold text-center">{{ o.vendor }}</td>
                           <td class="text-center">{{ o.location }}</td>
                           <td class="text-right">{{ formatCurrency(o.totalAmount) }}</td>
                           <td class="text-center"><button @click="openOrderForEdit(o.id)" class="bg-yellow-400 border border-yellow-600 px-2 text-xs">確認</button></td>
                           <td class="text-center"><button @click="deleteItem(o.id)" class="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">削除</button></td>
                       </tr>
                   </tbody>
                </table>
                <div v-if="adminOrders.length===0" class="text-center py-4 text-gray-500">承認待ち発注書はありません</div>
              </div>

              <div class="legacy-card p-4">
                <h2 class="font-bold border-b border-gray-400 mb-2">受取請求書管理</h2>
                <div class="overflow-x-auto">
                  <table class="grid-legacy">
                    <thead>
                       <tr>
                         <th>登録日</th><th>ステータス</th><th>担当者</th><th>施工者</th><th>工事名</th><th>請求金額</th><th>支払予定額</th><th>操作</th><th>削除</th>
                       </tr>
                    </thead>
                    <tbody>
                       <tr v-for="inv in adminInvoices" :key="inv.id">
                           <td class="text-center text-[10px]">{{ inv.registeredAt }}</td>
                           <td class="text-center">
                             <span :class="{'bg-blue-100 text-blue-800': inv.status==='着工', 'bg-green-100 text-green-800': inv.status==='完了', 'bg-yellow-100 text-yellow-800': inv.status==='未確認' || inv.status==='確認済', 'bg-gray-200': inv.status==='支払済'}" class="px-1 rounded text-xs font-bold">{{ inv.status }}</span>
                           </td>
                           <td class="font-bold text-center">{{ inv.person }}</td>
                           <td class="text-center">{{ inv.contractor }}</td>
                           <td class="text-center truncate max-w-xs">{{ inv.project }}</td>
                           <td class="text-right font-mono">{{ formatCurrency(inv.amount) }}</td>
                           <td class="text-right font-mono text-blue-900 font-bold">{{ formatCurrency(inv.payment) }}</td>
                           <td class="text-center">
                              <button v-if="inv.status==='着工' || inv.status==='未確認' || inv.status==='確認済'" @click="updateInvoiceStatus(inv.id, '完了')" class="bg-green-600 text-white px-2 py-1 text-xs rounded">完了にする</button>
                           </td>
                           <td class="text-center"><button @click="deleteItem(inv.id)" class="bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">削除</button></td>
                       </tr>
                    </tbody>
                  </table>
                  <div v-if="adminInvoices.length===0" class="text-center py-4 text-gray-500">受取請求書はありません</div>
                </div>
              </div>
          </div>

          <!-- 経営分析タブ -->
          <div v-if="adminSubTab === 'analysis'" class="space-y-6">
              <div class="legacy-card p-4">
                  <div class="flex justify-between items-center mb-4">
                      <h2 class="font-bold text-lg">月次売上・粗利推移</h2>
                      <select v-model="analysisYear" @change="loadAnalysis" class="border p-1">
                          <option v-for="y in years" :key="y" :value="y">{{ y }}年</option>
                      </select>
                  </div>
                  <div class="w-full min-h-[280px] relative" style="height: min(320px, 40vh);">
                      <canvas id="salesChart"></canvas>
                      <div v-if="analysisData.monthly && analysisData.monthly.every(m => !m.sales && !m.profit)" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm bg-gray-50/80">データがありません</div>
                  </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="legacy-card p-4">
                      <h2 class="font-bold mb-2">顧客別売上ランキング (TOP10)</h2>
                      <table class="grid-legacy">
                          <thead><tr><th>順位</th><th>顧客名</th><th class="text-right">売上</th><th class="text-right">粗利</th></tr></thead>
                          <tbody>
                              <tr v-for="(c, i) in (analysisData.ranking || [])" :key="i">
                                  <td class="text-center">{{ i+1 }}</td>
                                  <td class="font-bold">{{ c.name }}</td>
                                  <td class="text-right font-mono">{{ formatCurrency(c.sales) }}</td>
                                  <td class="text-right font-mono text-green-700">{{ formatCurrency(c.profit) }}</td>
                              </tr>
                          </tbody>
                      </table>
                      <div v-if="!analysisData.ranking || analysisData.ranking.length === 0" class="p-4 text-center text-gray-500 text-sm">データがありません</div>
                  </div>
                  <div class="legacy-card p-4 flex flex-col justify-center items-center">
                      <div class="text-gray-500 mb-2">年間総売上</div>
                      <div class="text-4xl font-bold font-mono text-blue-800">{{ formatCurrency(analysisTotalSales) }}</div>
                      <div class="text-gray-500 mt-4 mb-2">年間総粗利</div>
                      <div class="text-3xl font-bold font-mono text-green-700">{{ formatCurrency(analysisTotalProfit) }}</div>
                  </div>
              </div>
          </div>

          <!-- 会計連携タブ (新設) -->
          <div v-if="adminSubTab === 'accounting'" class="space-y-6">
               <div class="legacy-card p-4 mt-6">
                  <h2 class="font-bold border-b border-gray-400 mb-2 flex items-center gap-2">
                      <span class="material-icons text-green-600">file_download</span> 会計連携 (CSV出力)
                  </h2>
                  <div class="flex items-end gap-4 p-2 bg-gray-50 flex-wrap">
                      <div>
                          <label class="block text-xs font-bold mb-1">対象年</label>
                          <select v-model="journalYear" class="border p-1 text-sm">
                              <option v-for="y in journalYears" :key="y" :value="y">{{ y }}年</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-xs font-bold mb-1">対象月</label>
                          <select v-model="journalMonth" class="border p-1 text-sm">
                              <option v-for="m in 12" :key="m" :value="m">{{ m }}月</option>
                          </select>
                      </div>
                      <div class="flex gap-2 items-center text-sm font-bold">
                          <label><input type="checkbox" v-model="journalIncludePurchases"> 仕入(請求書)</label>
                          <label><input type="checkbox" v-model="journalIncludeSales"> 売上(見積/請求)</label>
                      </div>
                      <div class="flex-1 text-right">
                        <button @click="showPreview" class="bg-blue-600 text-white px-4 py-1.5 rounded shadow hover:bg-blue-700 text-sm font-bold flex items-center gap-1 ml-auto mb-1">
                            <span class="material-icons text-sm">table_view</span> プレビュー
                        </button>
                        <button @click="downloadJournalCsv" class="bg-green-600 text-white px-4 py-1.5 rounded shadow hover:bg-green-700 text-sm font-bold flex items-center gap-1 ml-auto">
                            <span class="material-icons text-sm">download</span> CSV出力
                        </button>
                      </div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1 pl-2">※「着工」または「完了」の受取請求書のみ出力されます。</div>
                  <div class="text-xs text-gray-600 mt-2 p-2 bg-blue-50 rounded">「入金管理」「出金管理」に実データを登録すると、現金・小切手・手形・振込等の項目に実績値が反映されます。</div>
               </div>
          </div>

          <!-- 入金管理タブ -->
          <div v-if="adminSubTab === 'deposits'" class="space-y-6">
              <div v-if="adminTabLoading" class="text-center py-8 text-gray-500">
                  <span class="material-icons animate-spin" style="font-size:24px">refresh</span>
                  <p class="mt-2 text-sm">データ読込中...</p>
              </div>
              <div class="legacy-card p-4">
                  <h2 class="font-bold border-b border-gray-400 mb-2 flex items-center justify-between">
                      <span class="flex items-center gap-2"><span class="material-icons text-blue-600">account_balance</span> 入金管理</span>
                      <button @click="openDepositModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-blue-700">新規登録</button>
                  </h2>
                  <div class="overflow-x-auto">
                      <table class="grid-legacy">
                          <thead><tr><th>入金日</th><th>取引先</th><th>工事名</th><th>種別</th><th class="text-right">金額</th><th>ステータス</th><th>操作</th></tr></thead>
                          <tbody>
                              <tr v-for="d in deposits" :key="d.id">
                                  <td class="text-center text-xs">{{ d.date }}</td>
                                  <td class="font-bold">{{ d.client }}</td>
                                  <td class="text-center truncate max-w-[120px]">{{ d.project }}</td>
                                  <td class="text-center text-xs">{{ d.type }}</td>
                                  <td class="text-right font-mono">{{ formatCurrency(d.amount) }}</td>
                                  <td class="text-center"><span :class="d.status==='取消'?'bg-gray-200':'bg-green-100 text-green-800'" class="px-1 rounded text-xs">{{ d.status }}</span></td>
                                  <td class="text-center">
                                      <button v-if="d.status!=='取消'" @click="openDepositModal(d)" class="bg-yellow-400 border border-yellow-600 px-2 text-xs mr-1">編集</button>
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                      <div v-if="deposits.length===0" class="text-center py-8 text-gray-500">入金データがありません</div>
                  </div>
              </div>
          </div>

          <!-- 出金管理タブ -->
          <div v-if="adminSubTab === 'payments'" class="space-y-6">
              <div v-if="adminTabLoading" class="text-center py-8 text-gray-500">
                  <span class="material-icons animate-spin" style="font-size:24px">refresh</span>
                  <p class="mt-2 text-sm">データ読込中...</p>
              </div>
              <div class="legacy-card p-4">
                  <h2 class="font-bold border-b border-gray-400 mb-2 flex items-center justify-between">
                      <span class="flex items-center gap-2"><span class="material-icons text-red-600">payments</span> 出金管理</span>
                      <button @click="openPaymentModal()" class="bg-red-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-red-700">新規登録</button>
                  </h2>
                  <div class="overflow-x-auto">
                      <table class="grid-legacy">
                          <thead><tr><th>出金日</th><th>支払先</th><th>工事名</th><th>種別</th><th class="text-right">金額</th><th>ステータス</th><th>操作</th></tr></thead>
                          <tbody>
                              <tr v-for="p in payments" :key="p.id">
                                  <td class="text-center text-xs">{{ p.date }}</td>
                                  <td class="font-bold">{{ p.supplier }}</td>
                                  <td class="text-center truncate max-w-[120px]">{{ p.project }}</td>
                                  <td class="text-center text-xs">{{ p.type }}</td>
                                  <td class="text-right font-mono">{{ formatCurrency(p.amount) }}</td>
                                  <td class="text-center"><span :class="p.status==='取消'?'bg-gray-200':'bg-green-100 text-green-800'" class="px-1 rounded text-xs">{{ p.status }}</span></td>
                                  <td class="text-center">
                                      <button v-if="p.status!=='取消'" @click="openPaymentModal(p)" class="bg-yellow-400 border border-yellow-600 px-2 text-xs mr-1">編集</button>
                                  </td>
                              </tr>
                          </tbody>
                      </table>
                      <div v-if="payments.length===0" class="text-center py-8 text-gray-500">出金データがありません</div>
                  </div>
              </div>
          </div>

          <!-- 設定タブ -->
          <div v-if="adminSubTab === 'settings'" class="space-y-6">
              <div class="legacy-card p-4">
                  <h2 class="font-bold border-b border-gray-400 mb-4 flex items-center gap-2">
                      <span class="material-icons text-gray-600">settings</span> システム設定
                  </h2>

                  <!-- リマインドメール通知 -->
                  <div class="bg-white border rounded p-4">
                      <h3 class="font-bold text-sm mb-3 flex items-center gap-2">
                          <span class="material-icons text-orange-500" style="font-size:20px">notifications_active</span>
                          リマインドメール通知
                      </h3>
                      <p class="text-xs text-gray-600 mb-3">
                          有効にすると、毎朝9時に入金/出金の期日接近・超過のリマインドメールが自動送信されます。
                      </p>
                      <div class="flex items-center gap-4">
                          <span class="text-sm">ステータス:</span>
                          <span v-if="reminderTriggerLoading" class="text-gray-400 text-sm">
                              <span class="material-icons animate-spin" style="font-size:16px">refresh</span> 確認中...
                          </span>
                          <template v-else>
                              <span v-if="reminderTriggerActive" class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold">有効</span>
                              <span v-else class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">無効</span>
                          </template>
                      </div>
                      <div class="flex gap-2 mt-3">
                          <button @click="toggleReminderTrigger(true)" :disabled="reminderTriggerLoading || reminderTriggerActive"
                                  class="px-4 py-1.5 text-sm font-bold rounded border"
                                  :class="reminderTriggerActive ? 'bg-gray-100 text-gray-400 border-gray-300 cursor-not-allowed' : 'bg-green-600 text-white border-green-700 hover:bg-green-700'">
                              有効にする
                          </button>
                          <button @click="toggleReminderTrigger(false)" :disabled="reminderTriggerLoading || !reminderTriggerActive"
                                  class="px-4 py-1.5 text-sm font-bold rounded border"
                                  :class="!reminderTriggerActive ? 'bg-gray-100 text-gray-400 border-gray-300 cursor-not-allowed' : 'bg-red-600 text-white border-red-700 hover:bg-red-700'">
                              無効にする
                          </button>
                      </div>
                  </div>

                  <!-- LINE通知設定 -->
                  <div class="bg-white border rounded p-4 mt-4">
                      <h3 class="font-bold text-sm mb-3 flex items-center gap-2">
                          <span class="material-icons text-green-500" style="font-size:20px">chat</span>
                          LINE通知設定
                      </h3>
                      <p class="text-xs text-gray-600 mb-3">
                          LINE Messaging APIと連携して、リマインド通知をLINEにも送信します。<br>
                          複数のユーザーIDを登録すると、全員に同時通知されます。
                      </p>

                      <div class="space-y-4">
                          <!-- トークン -->
                          <div>
                              <label class="text-xs font-bold text-gray-600 block mb-1">チャネルアクセストークン</label>
                              <div class="flex gap-2 items-center">
                                  <input type="password" v-model="lineSettings.token" placeholder="トークンを入力..."
                                         class="flex-1 border rounded px-2 py-1 text-sm font-mono">
                                  <button @click="saveLineToken" :disabled="lineSettingsLoading || !lineSettings.token"
                                          class="bg-green-600 text-white px-3 py-1 text-sm font-bold rounded border border-green-700 hover:bg-green-700 disabled:opacity-50 whitespace-nowrap">
                                      保存
                                  </button>
                              </div>
                              <span v-if="lineSettings.hasToken" class="text-green-600 text-xs flex items-center gap-1 mt-1">
                                  <span class="material-icons" style="font-size:14px">check_circle</span> 設定済 ({{ lineSettings.tokenPreview }})
                              </span>
                          </div>

                          <!-- 送信先一覧 -->
                          <div>
                              <label class="text-xs font-bold text-gray-600 block mb-1">送信先ユーザーID（{{ lineSettings.userIds.length }}件登録中）</label>
                              <div v-if="lineSettings.userIds.length > 0" class="border rounded divide-y mb-2">
                                  <div v-for="(uid, idx) in lineSettings.userIds" :key="idx"
                                       class="flex items-center justify-between px-3 py-1.5 text-sm">
                                      <span class="font-mono text-xs">{{ uid }}</span>
                                      <button @click="removeLineUser(uid)" :disabled="lineSettingsLoading"
                                              class="text-red-500 hover:text-red-700 text-xs flex items-center gap-0.5 disabled:opacity-50">
                                          <span class="material-icons" style="font-size:16px">delete</span> 削除
                                      </button>
                                  </div>
                              </div>
                              <div v-else class="text-xs text-gray-400 mb-2">送信先が登録されていません</div>

                              <!-- 追加フォーム -->
                              <div class="flex gap-2 items-center">
                                  <input type="text" v-model="lineSettings.newUserId" placeholder="U1234abcd... を入力"
                                         @keyup.enter="addLineUser"
                                         class="flex-1 border rounded px-2 py-1 text-sm font-mono">
                                  <button @click="addLineUser" :disabled="lineSettingsLoading || !lineSettings.newUserId"
                                          class="bg-blue-600 text-white px-3 py-1 text-sm font-bold rounded border border-blue-700 hover:bg-blue-700 disabled:opacity-50 whitespace-nowrap">
                                      追加
                                  </button>
                              </div>
                          </div>

                          <!-- テスト送信 -->
                          <div>
                              <button @click="testLineSend" :disabled="lineSettingsLoading || lineSettings.userIds.length === 0"
                                      class="bg-purple-600 text-white px-4 py-1.5 text-sm font-bold rounded border border-purple-700 hover:bg-purple-700 disabled:opacity-50 flex items-center gap-1">
                                  <span class="material-icons" style="font-size:16px">send</span>
                                  テスト送信（全{{ lineSettings.userIds.length }}人）
                              </button>
                          </div>
                      </div>
                  </div>

                  <!-- LINE Bot連携 (Webhook) -->
                  <div class="bg-white border rounded p-4 mt-4">
                      <h3 class="font-bold text-sm mb-3 flex items-center gap-2">
                          <span class="material-icons text-blue-500" style="font-size:20px">webhook</span>
                          LINE Bot連携 (Webhook)
                      </h3>
                      <p class="text-xs text-gray-600 mb-3">
                          LINEからメッセージを送ると請求書データとして受け付け、未処理ファイルに追加します。<br>
                          LINE DevelopersコンソールでWebhook URLを設定してください。
                      </p>

                      <div class="space-y-4">
                          <!-- Webhook URL -->
                          <div>
                              <label class="text-xs font-bold text-gray-600 block mb-1">Webhook URL</label>
                              <div class="flex gap-2 items-center">
                                  <input type="text" :value="webhookUrl" readonly class="input-base text-xs flex-1" style="background:#f9fafb; cursor:default;" placeholder="デプロイ後に取得できます">
                                  <button @click="fetchWebhookUrl" class="bg-gray-200 text-gray-700 px-3 py-1.5 text-xs rounded hover:bg-gray-300">取得</button>
                                  <button @click="copyWebhookUrl" :disabled="!webhookUrl" class="bg-blue-500 text-white px-3 py-1.5 text-xs rounded hover:bg-blue-600 disabled:opacity-50">コピー</button>
                              </div>
                          </div>

                          <!-- チャネルシークレット -->
                          <div>
                              <label class="text-xs font-bold text-gray-600 block mb-1">チャネルシークレット（Webhook認証用）</label>
                              <div class="flex gap-2 items-center">
                                  <input type="password" v-model="lineSettings.channelSecret" placeholder="チャネルシークレットを入力..."
                                      class="input-base text-xs flex-1">
                                  <button @click="saveLineChannelSecret" :disabled="!lineSettings.channelSecret || lineSettingsLoading"
                                      class="bg-blue-600 text-white px-3 py-1.5 text-xs font-bold rounded border border-blue-700 hover:bg-blue-700 disabled:opacity-50">
                                      保存
                                  </button>
                              </div>
                              <p class="text-xs text-gray-500 mt-1">LINE Developersコンソール > チャネル基本設定 から取得できます</p>
                          </div>

                          <!-- 利用方法 -->
                          <div class="bg-blue-50 border border-blue-200 rounded p-3">
                              <p class="text-xs font-bold text-blue-700 mb-2">LINE Botの使い方</p>
                              <ol class="text-xs text-blue-800 space-y-1 list-decimal ml-4">
                                  <li>LINE DevelopersでMessaging APIチャネルを作成</li>
                                  <li>チャネルアクセストークンを上の「LINE通知設定」に登録</li>
                                  <li>チャネルシークレットを上の欄に登録</li>
                                  <li>「取得」ボタンでWebhook URLを取得し、LINE Developersに設定</li>
                                  <li>LINE BotのQRコードを読み取って友だち追加</li>
                                  <li>メッセージを送信すると請求書データとして受け付けられます</li>
                              </ol>
                              <div class="mt-2 bg-white border rounded p-2">
                                  <p class="text-xs font-bold text-gray-600 mb-1">メッセージフォーマット例:</p>
                                  <pre class="text-xs text-gray-700 whitespace-pre-wrap">請求元: ○○建設
請求金額: 1000000
請求日: 2026/02/20
内容: 外壁塗装工事
現場名: ○○邸新築工事</pre>
                              </div>
                          </div>
                      </div>
                  </div>

              </div>
          </div>

        </div>
      </div>
    </main>

    <!-- AIチャットボット -->
    <div class="chatbot-container" :class="{ 'is-dragging': isDragging }"
         :style="{ left: chatPosX + 'px', top: chatPosY + 'px' }">
      
      <transition name="modal">
        <div v-if="showChatBot" class="bg-white border border-gray-400 shadow-2xl rounded-lg mb-4 flex flex-col" style="width: min(500px, calc(100vw - 40px)); height: 650px; max-height: calc(100vh - 120px); overflow: hidden;">
          <div class="bg-purple-700 text-white p-3 font-bold flex justify-between items-center shadow-sm chatbot-drag-handle"
               @mousedown.prevent="onChatDragStart($event)" @touchstart="onChatDragStart($event)">
            <span class="flex items-center gap-1"><span class="material-icons text-sm">psychology</span>AIアシスタント</span>
            <button @click="showChatBot=false" class="text-white hover:text-purple-200 font-bold text-2xl w-10 h-10 flex items-center justify-center rounded hover:bg-white/20 transition-colors" title="閉じる">×</button>
          </div>

          <!-- モード切替タブ -->
          <div class="flex border-b bg-white text-xs">
            <button @click="chatMode='help'" :class="chatMode==='help' ? 'border-b-2 border-purple-600 text-purple-700 font-bold' : 'text-gray-500'" class="flex-1 py-2 px-3 hover:bg-purple-50 transition-colors">
              <span class="material-icons text-[14px] align-middle mr-0.5">help_outline</span>システム解説
            </button>
            <button @click="chatMode='action'" :class="chatMode==='action' ? 'border-b-2 border-orange-500 text-orange-700 font-bold' : 'text-gray-500'" class="flex-1 py-2 px-3 hover:bg-orange-50 transition-colors">
              <span class="material-icons text-[14px] align-middle mr-0.5">auto_fix_high</span>操作アシスタント
            </button>
          </div>

          <!-- システム解説モード -->
          <template v-if="chatMode==='help'">
            <div class="flex-1 min-h-0 p-3 overflow-y-auto bg-gray-50 text-sm space-y-3" id="chat-history">
              <div v-for="(msg, i) in chatMessages" :key="i" :class="msg.role === 'user' ? 'text-right' : 'text-left'">
                <div :class="msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border border-gray-300 text-gray-800'"
                     class="inline-block px-3 py-2 rounded-lg max-w-[90%] whitespace-pre-wrap shadow-sm text-left leading-relaxed">
                  <span v-if="msg.role==='ai'" class="font-bold text-purple-700 block mb-1 text-[10px]">AI</span>
                  {{ msg.text }}
                </div>
              </div>
              <div v-if="isChatThinking" class="flex justify-start">
                <div class="bg-white border border-gray-300 px-3 py-2 rounded-lg text-gray-500 text-[10px] animate-pulse">考え中...</div>
              </div>
            </div>
            <div class="p-2 border-t bg-gray-100">
              <div class="flex gap-2">
                <input v-model="chatInput" @keydown.enter="!$event.isComposing && !isChatThinking && sendChatMessage()" :disabled="isChatThinking"
                       class="flex-1 border border-gray-300 p-2 rounded text-xs focus:outline-none focus:border-purple-500"
                       placeholder="例: 見積書PDFの出し方は？">
                <button @click="sendChatMessage" :disabled="isChatThinking || !chatInput"
                        class="bg-purple-600 text-white px-3 py-1 rounded shadow hover:bg-purple-700 disabled:opacity-50 transition-colors">
                  <span class="material-icons text-sm">send</span>
                </button>
              </div>
            </div>
          </template>

          <!-- 操作アシスタントモード -->
          <template v-if="chatMode==='action'">
            <div class="flex-1 min-h-0 p-3 overflow-y-auto bg-gray-50 text-sm space-y-3" id="ai-assistant-history">
              <div v-for="(msg, i) in aiAssistantMessages" :key="i">
                <!-- ユーザーメッセージ -->
                <div v-if="msg.role==='user'" class="text-right">
                  <div class="inline-block px-3 py-2 rounded-lg max-w-[90%] bg-blue-600 text-white shadow-sm text-left whitespace-pre-wrap leading-relaxed">{{ msg.text }}</div>
                </div>
                <!-- AIテキスト応答 -->
                <div v-else-if="msg.role==='ai'" class="text-left">
                  <div class="inline-block px-3 py-2 rounded-lg max-w-[90%] bg-white border border-gray-300 text-gray-800 shadow-sm whitespace-pre-wrap leading-relaxed">
                    <span class="font-bold text-orange-600 block mb-1 text-[10px]">操作AI</span>{{ msg.text }}
                  </div>
                </div>
                <!-- プレビューカード -->
                <div v-else-if="msg.role==='preview'" class="text-left">
                  <div class="inline-block px-3 py-2 rounded-lg max-w-[95%] shadow-sm" :class="msg.applied ? 'bg-green-50 border border-green-300' : msg.cancelled ? 'bg-gray-100 border border-gray-300' : 'bg-amber-50 border border-amber-400'">
                    <span class="font-bold text-orange-600 block mb-1 text-[10px]">操作AI</span>
                    <div class="font-bold text-sm mb-1">{{ msg.text }}</div>
                    <div class="text-xs text-gray-600 whitespace-pre-wrap bg-white rounded p-2 mb-2 border">{{ msg.detail }}</div>
                    <div v-if="msg.confidence < 0.7" class="text-xs text-red-600 mb-2 flex items-center gap-1">
                      <span class="material-icons text-[14px]">warning</span>信頼度が低いです ({{ Math.round(msg.confidence * 100) }}%)。内容を確認してください。
                    </div>
                    <div v-if="msg.applied" class="text-xs text-green-700 font-bold flex items-center gap-1"><span class="material-icons text-[14px]">check_circle</span>適用済み（「元に戻す」で復元可能）</div>
                    <div v-else-if="msg.cancelled" class="text-xs text-gray-500">キャンセル済み</div>
                    <div v-else class="flex gap-2">
                      <button @click="applyAiActions()" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-orange-600 shadow transition-colors flex items-center gap-1">
                        <span class="material-icons text-[14px]">check</span>適用
                      </button>
                      <button @click="cancelAiAction()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-300 transition-colors">キャンセル</button>
                    </div>
                  </div>
                </div>
              </div>
              <div v-if="isAiAssistantThinking" class="flex justify-start">
                <div class="bg-white border border-gray-300 px-3 py-2 rounded-lg text-gray-500 text-[10px] animate-pulse">{{ aiAssistantLoadingText || 'AI分析中...' }}</div>
              </div>
            </div>
            <div class="p-2 border-t bg-gray-100">
              <div class="flex gap-2">
                <input v-model="aiAssistantInput" @keydown.enter="!$event.isComposing && !isAiAssistantThinking && sendAiAssistantMessage()" :disabled="isAiAssistantThinking"
                       class="flex-1 border border-gray-300 p-2 rounded text-xs focus:outline-none focus:border-orange-500"
                       :placeholder="aiAssistantPlaceholder">
                <button @click="sendAiAssistantMessage" :disabled="isAiAssistantThinking || !aiAssistantInput"
                        class="bg-orange-500 text-white px-3 py-1 rounded shadow hover:bg-orange-600 disabled:opacity-50 transition-colors">
                  <span class="material-icons text-sm">send</span>
                </button>
              </div>
            </div>
          </template>
        </div>
      </transition>

      <button v-if="assistantBtnVisible" @click="onChatBtnClick"
              @contextmenu.prevent="openAssistantCtxMenu($event)"
              @mousedown="onChatDragStart($event)" @touchstart="onChatDragStart($event)"
              class="chatbot-btn-draggable bg-purple-700 text-white w-14 h-14 rounded-full shadow-lg hover:bg-purple-800 transition flex items-center justify-center border-2 border-white"
              :class="{ 'transform hover:scale-110': !isDragging }">
        <span class="material-icons" style="font-size: 28px;">support_agent</span>
      </button>
      <div v-if="!assistantBtnVisible"
           @contextmenu.prevent="openAssistantCtxMenu($event)"
           class="w-5 h-5 rounded-full bg-purple-300 opacity-40 hover:opacity-80 cursor-pointer transition border border-purple-400"
           title="右クリックでAIアシスタントを表示"></div>
    </div>

    <!-- AIアシスタント右クリックメニュー -->
    <teleport to="body">
      <div v-if="assistantCtxMenu.show" class="fixed inset-0 z-[10001]" @click="assistantCtxMenu.show=false" @contextmenu.prevent="assistantCtxMenu.show=false">
        <div class="absolute bg-white border border-gray-300 rounded-lg shadow-xl py-1 min-w-[160px] text-sm"
             :style="{ left: assistantCtxMenu.x + 'px', top: assistantCtxMenu.y + 'px' }">
          <div @click="setAssistantBtnVisible(true)" class="px-4 py-2 hover:bg-purple-50 cursor-pointer flex items-center gap-2"
               :class="assistantBtnVisible ? 'text-purple-700 font-bold' : 'text-gray-600'">
            <span class="material-icons text-sm">{{ assistantBtnVisible ? 'radio_button_checked' : 'radio_button_unchecked' }}</span>
            表示
          </div>
          <div @click="setAssistantBtnVisible(false)" class="px-4 py-2 hover:bg-purple-50 cursor-pointer flex items-center gap-2"
               :class="!assistantBtnVisible ? 'text-purple-700 font-bold' : 'text-gray-600'">
            <span class="material-icons text-sm">{{ !assistantBtnVisible ? 'radio_button_checked' : 'radio_button_unchecked' }}</span>
            非表示
          </div>
        </div>
      </div>
    </teleport>

    <!-- フローティング見積プレビューパネル -->
    <div v-if="floatingPanel.show"
         class="floating-panel-container"
         :class="{ 'is-dragging': isFloatingPanelDragging }"
         :style="{ left: floatingPanelPosX + 'px', top: floatingPanelPosY + 'px' }">
      <div class="bg-white border-2 border-indigo-400 shadow-2xl rounded-lg flex flex-col"
           style="width: 850px; max-width: calc(100vw - 40px); height: 600px; max-height: calc(100vh - 80px); overflow: hidden;">

        <!-- ヘッダー / ドラッグハンドル -->
        <div class="bg-indigo-700 text-white px-4 py-3 flex justify-between items-center shadow-sm floating-panel-drag-handle"
             @mousedown.prevent="onFloatingPanelDragStart($event)"
             @touchstart="onFloatingPanelDragStart($event)">
          <div class="flex items-center gap-3 min-w-0 flex-1">
            <span class="material-icons text-base">{{ floatingPanel.sourceType === 'estimate' ? 'description' : 'shopping_cart' }}</span>
            <template v-if="floatingPanel.mode === 'list'">
              <span class="text-base font-bold">{{ floatingPanel.sourceType === 'estimate' ? '見積履歴' : '発注履歴' }}</span>
            </template>
            <template v-else>
              <span class="text-base font-bold truncate">
                {{ floatingPanel.header?.client || floatingPanel.header?.vendor || '' }} - {{ floatingPanel.header?.project || '(無題)' }}
              </span>
              <span class="text-sm bg-white/20 px-2 py-1 rounded">{{ floatingPanel.header?.date }}</span>
            </template>
          </div>
          <button @click="closeFloatingPanel"
                  class="text-white hover:text-indigo-200 font-bold text-2xl w-10 h-10 flex items-center justify-center rounded hover:bg-white/20 transition-colors ml-2"
                  title="閉じる">&times;</button>
        </div>

        <!-- ローディング -->
        <div v-if="floatingPanel.loading" class="flex-1 flex items-center justify-center">
          <div class="loader mx-auto w-8 h-8 border-2"></div>
        </div>

        <!-- ===== リストモード ===== -->
        <template v-else-if="floatingPanel.mode === 'list'">
          <div class="px-4 py-2.5 bg-gray-50 border-b flex-shrink-0">
            <input v-model="floatingPanel.listFilter" class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm" placeholder="顧客名・工事名・発注先で絞り込み...">
          </div>
          <div class="flex-1 overflow-auto min-h-0">
            <!-- 見積リスト -->
            <template v-if="floatingPanel.sourceType === 'estimate'">
              <div class="divide-y divide-gray-200">
                <div v-for="p in floatingPanelFilteredList" :key="p.id"
                     @click="selectFloatingPanelItem(p.id)"
                     class="px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-base text-gray-800">{{ p.client }}</span>
                    <span class="text-sm px-1.5 py-0.5 rounded flex-shrink-0 ml-2" :class="{'bg-green-100 text-green-700': p.status==='成約', 'bg-yellow-100 text-yellow-700': p.status==='見積提出', 'bg-gray-100 text-gray-600': true}">{{ p.status }}</span>
                  </div>
                  <div class="text-sm text-gray-800 font-bold truncate mb-0.5">{{ p.project || '-' }}</div>
                  <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs text-gray-700">
                    <span><span class="font-bold">日付:</span> {{ p.date }}</span>
                    <span v-if="p.location"><span class="font-bold">場所:</span> {{ p.location }}</span>
                    <span v-if="p.period"><span class="font-bold">工期:</span> {{ p.period }}</span>
                  </div>
                  <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs text-gray-700 mb-1">
                    <span v-if="p.payment"><span class="font-bold">支払:</span> {{ p.payment }}</span>
                    <span v-if="p.expiry"><span class="font-bold">期限:</span> {{ p.expiry }}</span>
                    <span v-if="p.taxMode"><span class="font-bold">税:</span> {{ p.taxMode }}</span>
                  </div>
                  <div class="text-right font-mono text-base font-bold text-blue-900">{{ formatCurrency(p.totalAmount) }}</div>
                </div>
              </div>
            </template>
            <!-- 発注リスト -->
            <template v-else>
              <div class="divide-y divide-gray-200">
                <div v-for="o in floatingPanelFilteredList" :key="o.id"
                     @click="selectFloatingPanelItem(o.id)"
                     class="px-4 py-3 cursor-pointer hover:bg-orange-50 transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-base text-orange-800">{{ o.vendor }}</span>
                    <span class="text-sm px-1.5 py-0.5 rounded bg-gray-100 text-gray-600 flex-shrink-0 ml-2">{{ o.status }}</span>
                  </div>
                  <div class="text-sm text-gray-800 font-bold truncate mb-0.5">{{ o.project || '-' }}</div>
                  <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs text-gray-700">
                    <span><span class="font-bold">日付:</span> {{ o.date }}</span>
                    <span v-if="o.client"><span class="font-bold">顧客:</span> {{ o.client }}</span>
                    <span v-if="o.location"><span class="font-bold">場所:</span> {{ o.location }}</span>
                    <span v-if="o.period"><span class="font-bold">工期:</span> {{ o.period }}</span>
                  </div>
                  <div class="flex flex-wrap gap-x-3 gap-y-0.5 text-xs text-gray-700 mb-1">
                    <span v-if="o.payment"><span class="font-bold">支払:</span> {{ o.payment }}</span>
                    <span v-if="o.expiry"><span class="font-bold">期限:</span> {{ o.expiry }}</span>
                    <span v-if="o.taxMode"><span class="font-bold">税:</span> {{ o.taxMode }}</span>
                  </div>
                  <div class="text-right font-mono text-base font-bold text-orange-900">{{ formatCurrency(o.totalAmount) }}</div>
                </div>
              </div>
            </template>
            <div v-if="floatingPanelFilteredList.length === 0" class="p-8 text-center text-gray-500">データがありません</div>
          </div>
          <div class="px-4 py-2 border-t bg-gray-50 text-sm text-gray-500 flex-shrink-0">
            全 {{ floatingPanelFilteredList.length }} 件
          </div>
        </template>

        <!-- ===== 詳細モード ===== -->
        <template v-else>
          <!-- ツールバー -->
          <div class="flex items-center justify-between px-4 py-2.5 bg-gray-50 border-b text-sm flex-shrink-0">
            <div class="flex items-center gap-3">
              <button v-if="floatingPanel.listItems.length > 0" @click="floatingPanelBack"
                      class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm">
                <span class="material-icons text-base">arrow_back</span>一覧に戻る
              </button>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" class="w-4 h-4" v-model="floatingPanel.selectAll" @change="toggleFloatingPanelSelectAll">
                <span class="font-bold">全選択</span>
              </label>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-gray-500">選択: {{ floatingPanelCheckedCount }}件</span>
              <button @click="addFloatingPanelItems"
                      :disabled="floatingPanelCheckedCount === 0"
                      class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed transition flex items-center gap-1">
                <span class="material-icons text-base">add</span>選択を追加
              </button>
            </div>
          </div>

          <!-- ヘッダー情報 -->
          <div v-if="floatingPanel.header" class="px-4 py-2 bg-white border-b border-gray-200 flex-shrink-0">
            <div class="grid grid-cols-3 gap-x-4 gap-y-1 text-sm">
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">日付:</span>
                <span class="text-gray-800">{{ floatingPanel.header.date || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">顧客名:</span>
                <span class="text-gray-800 font-bold truncate">{{ floatingPanel.header.client || floatingPanel.header.vendor || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">状態:</span>
                <span class="text-gray-800">{{ floatingPanel.header.status || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">工事名:</span>
                <span class="text-gray-800 truncate">{{ floatingPanel.header.project || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">工事場所:</span>
                <span class="text-gray-800 truncate">{{ floatingPanel.header.location || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">工期:</span>
                <span class="text-gray-800">{{ floatingPanel.header.period || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">支払条件:</span>
                <span class="text-gray-800">{{ floatingPanel.header.payment || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">有効期限:</span>
                <span class="text-gray-800">{{ floatingPanel.header.expiry || '-' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-gray-400 font-bold w-14 flex-shrink-0">税区分:</span>
                <span class="text-gray-800">{{ floatingPanel.header.taxMode || '-' }}</span>
              </div>
            </div>
          </div>

          <!-- 明細テーブル -->
          <div class="flex-1 overflow-auto min-h-0">
            <table class="grid-legacy w-full text-sm" style="min-width: 700px;">
              <thead style="position: sticky; top: 0; z-index: 5;">
                <tr>
                  <th class="w-10"></th>
                  <th>工種</th>
                  <th>品名</th>
                  <th>仕様</th>
                  <th class="w-20 text-right">数量</th>
                  <th class="w-14">単位</th>
                  <th class="w-24 text-right">単価</th>
                  <th class="w-24 text-right">原価</th>
                  <th class="w-28 text-right">金額</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(it, idx) in floatingPanel.items" :key="idx"
                    @click="it._checked = !it._checked"
                    class="cursor-pointer hover:bg-blue-50 transition-colors"
                    :class="{ 'bg-blue-100': it._checked }">
                  <td class="text-center" @click.stop>
                    <input type="checkbox" class="w-4 h-4" v-model="it._checked">
                  </td>
                  <td class="py-2 px-2">{{ it.category || '' }}</td>
                  <td class="py-2 px-2 font-bold">{{ it.product || '' }}</td>
                  <td class="py-2 px-2 text-gray-600">{{ it.spec || '' }}</td>
                  <td class="py-2 px-2 text-right font-mono">{{ formatCurrency(it.qty) }}</td>
                  <td class="py-2 px-2 text-center">{{ it.unit || '' }}</td>
                  <td class="py-2 px-2 text-right font-mono">{{ formatCurrency(it.price) }}</td>
                  <td class="py-2 px-2 text-right font-mono">{{ formatCurrency(it.cost) }}</td>
                  <td class="py-2 px-2 text-right font-mono">{{ formatCurrency(it.amount) }}</td>
                </tr>
              </tbody>
            </table>
            <div v-if="floatingPanel.items.length === 0" class="p-8 text-center text-gray-500">明細がありません</div>
          </div>

          <!-- フッター -->
          <div class="flex items-center justify-between px-4 py-2.5 border-t bg-gray-50 text-sm text-gray-600 flex-shrink-0">
            <span>全 {{ floatingPanel.items.length }} 行</span>
            <span class="font-bold">合計:
              <span class="font-mono text-gray-800">
                {{ formatCurrency(floatingPanel.items.reduce((s, i) => s + (Number(i.amount) || 0), 0)) }}
              </span>
            </span>
          </div>
        </template>
      </div>
    </div>

    <div v-if="currentTab === 'edit'" class="function-bar">
      <div class="f-btn" @click="createPdf"><span class="material-icons f-icon text-blue-600">print</span>見積PDF</div>
      
      <!-- Phase 1: ボタン変更 -->
      <div class="f-btn" @click="saveEstimate('public')" v-if="!isReviewMode"><span class="material-icons f-icon text-green-600">save</span>保存</div>
      <div class="f-btn" @click="saveEstimate('admin')" v-if="!isReviewMode"><span class="material-icons f-icon text-orange-600">send</span>管理者提出</div>
      <!-- 下書きボタン削除 -->
      <div class="f-btn" @click="openLeftPanel('set')"><span class="material-icons f-icon">playlist_add</span>元請見積履歴</div>
      <div class="f-btn" @click="openLeftPanel('material')"><span class="material-icons f-icon text-teal-600">inventory</span>材料費単価</div>
      <div class="f-btn" @click="openOcrModal"><span class="material-icons f-icon">document_scanner</span>見積読込</div>
      <div class="f-btn" @click="copyDocument"><span class="material-icons f-icon text-purple-600">content_copy</span>コピー</div>
      <div class="f-btn" @click="pasteDocument" v-if="clipboardData"><span class="material-icons f-icon text-purple-600">content_paste</span>貼り付け</div>
    </div>

    <div v-if="currentTab === 'dedicated_order'" class="function-bar">
      <div class="f-btn" @click="saveDedicatedOrder"><span class="material-icons f-icon text-green-600">save</span>{{ dedicatedOrderForm.header.id ? '更新' : '保存' }}</div>
      <div class="f-btn" @click="createDedicatedOrderPdf"><span class="material-icons f-icon text-blue-600">print</span>PDF発行</div>
      <div class="f-btn" @click="openLeftPanel('set', null, 'dedicated_order')"><span class="material-icons f-icon">playlist_add</span>元請見積履歴</div>
      <div class="f-btn" @click="openLeftPanel('material', null, 'dedicated_order')"><span class="material-icons f-icon text-teal-600">inventory</span>材料費単価</div>
      <div class="f-btn" @click="openOcrModal"><span class="material-icons f-icon">document_scanner</span>見積読込</div>
      <div class="f-btn" @click="copyDocument"><span class="material-icons f-icon text-purple-600">content_copy</span>コピー</div>
      <div class="f-btn" @click="pasteDocument" v-if="clipboardData"><span class="material-icons f-icon text-purple-600">content_paste</span>貼り付け</div>
    </div>

    <!-- モーダル群 -->
    <transition name="modal">
      <div v-if="showOcrModal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content w-full max-w-2xl" style="max-height: 85vh;">
          <div class="modal-header"><span>OCR読取 - 見積明細</span><button @click="showOcrModal=false">×</button></div>
          <div class="modal-body p-4">
            <!-- タブ切替 -->
            <div class="flex border-b mb-4">
              <button @click="ocrTab='upload'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition', ocrTab==='upload' ? 'border-blue-600 text-blue-700' : 'border-transparent text-gray-500 hover:text-gray-700']">
                <span class="material-icons text-sm align-middle mr-1">upload_file</span>ファイルアップロード
              </button>
              <button @click="ocrTab='drive'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition', ocrTab==='drive' ? 'border-blue-600 text-blue-700' : 'border-transparent text-gray-500 hover:text-gray-700']">
                <span class="material-icons text-sm align-middle mr-1">folder</span>Driveフォルダ
              </button>
            </div>

            <!-- アップロードタブ -->
            <div v-if="ocrTab==='upload'">
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition cursor-pointer"
                @click="$refs.ocrFileInput.click()" @dragover.prevent @drop.prevent="handleOcrDrop($event)">
                <span class="material-icons text-4xl text-gray-400 mb-2">cloud_upload</span>
                <p class="text-sm text-gray-600">クリックまたはドラッグ&ドロップ</p>
                <p class="text-xs text-gray-400 mt-1">対応形式: JPG, PNG, PDF (最大10MB)</p>
              </div>
              <input ref="ocrFileInput" type="file" class="hidden" accept="image/*,.pdf" multiple @change="handleOcrFileSelect($event)">
              <ul v-if="ocrUploadFiles.length > 0" class="mt-3 text-sm border rounded">
                <li v-for="(f, idx) in ocrUploadFiles" :key="idx" class="p-2 border-b flex items-center justify-between">
                  <span class="material-icons text-gray-400 text-sm mr-2">{{ f.mime.includes('pdf') ? 'picture_as_pdf' : 'image' }}</span>
                  <span class="truncate flex-1">{{ f.name }}</span>
                  <span class="text-xs text-gray-400 mr-2">{{ (f.size / 1024).toFixed(0) }}KB</span>
                  <button @click="ocrUploadFiles.splice(idx, 1)" class="text-red-400 hover:text-red-600"><span class="material-icons text-sm">close</span></button>
                </li>
              </ul>
            </div>

            <!-- Driveタブ -->
            <div v-if="ocrTab==='drive'">
              <div v-if="isOcrLoading" class="loader mx-auto my-8"></div>
              <div v-else-if="ocrFiles.length === 0" class="text-center text-gray-500 py-8">Driveフォルダにファイルがありません</div>
              <ul v-else class="text-sm max-h-60 overflow-auto border rounded">
                <li v-for="f in ocrFiles" :key="f.id" @click="toggleFileSelection(f)"
                  :class="['p-3 border-b cursor-pointer flex items-center gap-2 transition', selectedOcrFiles.includes(f.id) ? 'bg-blue-100 border-blue-300' : 'hover:bg-gray-50']">
                  <span class="material-icons text-gray-400 text-sm">{{ f.mime && f.mime.includes('pdf') ? 'picture_as_pdf' : 'image' }}</span>
                  <span class="flex-1 truncate">{{ f.name }}</span>
                  <span class="text-xs text-gray-400">{{ f.updated }}</span>
                  <span v-if="selectedOcrFiles.includes(f.id)" class="material-icons text-blue-600 text-sm">check_circle</span>
                </li>
              </ul>
              <div v-if="!isOcrLoading && ocrFiles.length > 0" class="mt-2 text-xs text-gray-500">{{ selectedOcrFiles.length }}件選択中</div>
            </div>

            <!-- OCR結果プレビュー -->
            <div v-if="showOcrPreview && ocrResults.length > 0" class="mt-4">
              <div class="text-sm font-bold mb-2 text-green-700">
                <span class="material-icons text-sm align-middle">check</span> {{ ocrResults.length }}件の明細を検出しました
              </div>
              <div class="max-h-48 overflow-auto border rounded">
                <table class="w-full text-xs">
                  <thead class="bg-gray-100 sticky top-0"><tr>
                    <th class="p-1 text-left">工種</th><th class="p-1 text-left">品名</th><th class="p-1 text-left">仕様</th>
                    <th class="p-1 text-right">数量</th><th class="p-1">単位</th><th class="p-1 text-right">単価</th><th class="p-1 text-right">金額</th>
                  </tr></thead>
                  <tbody><tr v-for="(item, idx) in ocrResults" :key="idx" class="border-b">
                    <td class="p-1">{{ item.category }}</td><td class="p-1 font-bold">{{ item.product }}</td>
                    <td class="p-1 text-gray-600">{{ item.spec }}</td><td class="p-1 text-right">{{ formatCurrency(item.qty) }}</td>
                    <td class="p-1 text-center">{{ item.unit }}</td><td class="p-1 text-right">{{ formatCurrency(item.price) }}</td>
                    <td class="p-1 text-right">{{ formatCurrency(item.amount || Math.round((Number(item.qty)||0) * (Number(item.price)||0))) }}</td>
                  </tr></tbody>
                </table>
              </div>
            </div>

            <!-- アクションボタン -->
            <div class="mt-4 flex gap-2">
              <template v-if="!showOcrPreview">
                <button @click="executeOcrScan" :disabled="ocrProcessing || (ocrTab==='drive' && selectedOcrFiles.length===0) || (ocrTab==='upload' && ocrUploadFiles.length===0)"
                  class="flex-1 bg-blue-600 text-white p-2 rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                  {{ ocrProcessing ? 'AI解析中...' : '解析開始' }}
                </button>
              </template>
              <template v-else>
                <button @click="applyOcrResults('append')" class="flex-1 bg-green-600 text-white p-2 rounded font-bold">既存行に追加</button>
                <button @click="applyOcrResults('replace')" class="flex-1 bg-orange-600 text-white p-2 rounded font-bold">既存行を置換</button>
                <button @click="showOcrPreview=false; ocrResults=[]" class="px-4 bg-gray-300 text-gray-700 p-2 rounded">戻る</button>
              </template>
            </div>
          </div>
        </div>
      </div>
    </transition>
    
    <!-- 下書き一覧モーダル -->
    <transition name="modal"><div v-if="showDraftModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><span>下書き一覧</span><button @click="showDraftModal=false">×</button></div><div class="modal-body">
      <div v-if="isDraftLoading" class="loader mx-auto"></div>
      <div v-else>
        <div class="grid grid-cols-12 gap-2 text-xs font-bold border-b border-gray-400 pb-1 mb-1 px-2">
           <div class="col-span-3">最終更新日時</div>
           <div class="col-span-6">件名 (顧客 - 工事)</div>
           <div class="col-span-3 text-right">金額</div>
        </div>
        <ul class="text-sm">
          <li v-for="d in drafts" :key="d.id" @click="selectDraft(d.id)" class="grid grid-cols-12 gap-2 p-2 border-b cursor-pointer hover:bg-gray-100 items-center">
            <span class="col-span-3 text-xs text-gray-600">{{ d.date }}</span>
            <span class="col-span-6 truncate font-bold">{{ d.client }} - {{ d.project }}</span>
            <span class="col-span-3 text-right font-mono">{{ formatCurrency(d.totalAmount) }}</span>
          </li>
        </ul>
      </div>
    </div></div></div></transition>

    <!-- 右クリック行追加メニュー -->
    <div v-if="contextMenu.show" style="position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%;" @click="contextMenu.show=false" @contextmenu.prevent="contextMenu.show=false">
      <div :style="{position:'fixed', left: contextMenu.x + 'px', top: contextMenu.y + 'px'}" class="bg-white border border-gray-300 rounded shadow-lg py-1 min-w-[160px]" @click.stop>
        <button @click="insertRow('above')" class="w-full text-left px-4 py-2 text-sm hover:bg-blue-50 flex items-center gap-2">
          <span class="material-icons text-sm text-gray-500">arrow_upward</span> 上に行を追加
        </button>
        <button @click="insertRow('below')" class="w-full text-left px-4 py-2 text-sm hover:bg-blue-50 flex items-center gap-2">
          <span class="material-icons text-sm text-gray-500">arrow_downward</span> 下に行を追加
        </button>
      </div>
    </div>

    <!-- 一括選択モーダル（業者別・工種別） -->
    <transition name="modal">
      <div v-if="showBatchSelectModal" class="modal-overlay">
        <div class="modal-content w-full max-w-md">
          <div class="modal-header">
            <span>{{ batchSelectType === 'vendor' ? '発注先を選択' : batchSelectType === 'product' ? '品名を選択' : '工種を選択' }}</span>
            <button @click="showBatchSelectModal=false">×</button>
          </div>
          <div class="modal-body p-4">
            <div class="space-y-2">
              <div v-for="(opt, idx) in batchSelectOptions" :key="idx" 
                   @click="selectBatchOption(opt)" 
                   class="p-3 border border-gray-300 rounded cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition flex justify-between items-center">
                <span class="font-bold text-sm">{{ opt }}</span>
                <span class="material-icons text-blue-600">chevron_right</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </transition>

  </div>

  <script>
window.__script2Ran = true;
    window.addEventListener('error', function(e) {
      var lb = document.getElementById('loading-fallback');
      var ce = document.getElementById('critical-error');
      if (lb) lb.style.display = 'none';
      if (ce) { ce.style.display = 'block'; ce.innerHTML = '<h3>スクリプトエラー</h3><pre>' + window._escHtml((e.message || e) + '\n' + (e.filename || '') + ':' + (e.lineno || '')) + '</pre>'; }
    });
    window.addEventListener('unhandledrejection', function(e) {
      var lb = document.getElementById('loading-fallback');
      var ce = document.getElementById('critical-error');
      if (lb) lb.style.display = 'none';
      if (ce) { ce.style.display = 'block'; ce.innerHTML = '<h3>非同期エラー</h3><pre>' + window._escHtml(e.reason && e.reason.message ? e.reason.message : String(e.reason)) + '</pre>'; }
    });
    const gas = (funcName, ...args) => new Promise((resolve, reject) => {
        if (typeof google === 'undefined' || !google.script) {
            console.warn("GAS環境ではありません。モックを返します。");
            if(funcName === 'apiGetAuthStatus') resolve(JSON.stringify({ isAdmin: true, email: 'test@example.com' }));
            else if(funcName === 'apiGetProjects') resolve('[]');
            else if(funcName === 'apiGetOrders') resolve('[]');
            else if(funcName === 'apiGetOrderDetails') resolve(JSON.stringify({ error: "モック環境" })); 
            else if(funcName === 'apiFindOrderByEstimateAndVendor') resolve('null');
            else if(funcName === 'apiGetMasters') resolve(JSON.stringify({clients:['テスト建設','サンプル工務店'], sets:['外壁セット','内装セット'], vendors:[{name:'山田建材',honorific:'御中',displayName:'山田建材 御中',account:''},{name:'佐藤電気',honorific:'御中',displayName:'佐藤電気 御中',account:''},{name:'鈴木工業',honorific:'様',displayName:'鈴木工業 様',account:''}]}));
            else if(funcName === 'apiGetUnifiedProducts') resolve(JSON.stringify([{category:'仮設',product:'足場',spec:'枠組',unit:'m2',price:1200,source:'基本'},{category:'塗装',product:'外壁塗装',spec:'シリコン',unit:'m2',price:2500,source:'基本'},{category:'内装',product:'クロス張替',spec:'量産品',unit:'m2',price:1100,source:'基本'},{category:'電気',product:'照明器具',spec:'LED',unit:'個',price:8000,source:'基本'},{category:'設備',product:'給排水工事',spec:'',unit:'式',price:50000,source:'基本'}])); // Mock
            else if(funcName === 'apiSearchSets') resolve('[]'); // Mock
            else if(funcName === 'apiGetInvoices') resolve('[]'); // Mock (fetchInvoices on mount)
            else if(funcName === 'apiGetAnalysisData') resolve(JSON.stringify({ monthly: Array(12).fill(0).map(()=>({sales:0,cost:0,profit:0})), ranking: [] }));
            else if(funcName === 'apiGetDeposits') resolve('[]');
            else if(funcName === 'apiGetPayments') resolve('[]');
            else if(funcName === 'apiGetReminders') resolve('[]');
            else if(funcName === 'apiGetReminderTriggerStatus') resolve(JSON.stringify({ active: false }));
            else if(funcName === 'setupReminderTrigger') resolve(JSON.stringify({ success: true, message: 'モック: トリガー設定' }));
            else if(funcName === 'removeReminderTrigger') resolve(JSON.stringify({ success: true, message: 'モック: トリガー解除' }));
            else if(funcName === 'apiGetLineSettings') resolve(JSON.stringify({ hasToken: false, tokenPreview: '', userIds: [] }));
            else if(funcName === 'apiSaveLineToken') resolve(JSON.stringify({ success: true, message: 'モック: トークン保存' }));
            else if(funcName === 'apiAddLineUser') resolve(JSON.stringify({ success: true, message: 'モック: ユーザー追加' }));
            else if(funcName === 'apiRemoveLineUser') resolve(JSON.stringify({ success: true, message: 'モック: ユーザー削除' }));
            else if(funcName === 'apiGetMaterialPrices') resolve(JSON.stringify([{product:'セメント',spec:'普通',unit:'袋',price:500,updatedAt:''},{product:'砂利',spec:'5mm',unit:'m3',price:3000,updatedAt:''}]));
            else if(funcName === 'apiUpsertMaterialPrices') resolve(JSON.stringify({ success: true, updated: 0, added: 1 }));
            else if(funcName === 'apiDeleteMaterialPrice') resolve(JSON.stringify({ success: true }));
            else if(funcName === 'apiOcrEstimateFromDrive') resolve(JSON.stringify({ items: [{ category: "仮設", product: "テスト品目", spec: "テスト仕様", qty: 1, unit: "式", price: 10000 }] }));
            else if(funcName === 'apiOcrEstimateFromBase64') resolve(JSON.stringify({ items: [{ category: "仮設", product: "テスト品目", spec: "テスト仕様", qty: 1, unit: "式", price: 10000 }] }));
            else if(funcName === 'apiTestLineSend') resolve(JSON.stringify({ success: false, message: 'モック環境ではテスト送信できません' }));
            else if(funcName === 'apiAiAssistantAction') resolve(JSON.stringify({ actions: [{ type: "update_item", filter: { operator: "all" }, changes: { vendor: "テスト建材" } }], summary: "全件の発注先を「テスト建材」に変更します", confidence: 0.9 }));
            else reject('GAS Environment not found');
            return;
        }
        google.script.run.withSuccessHandler(resolve).withFailureHandler(err => reject(new Error(err)))[funcName](...args);
    });

    // 日付文字列をinput[type=date]用のyyyy-MM-dd形式に変換
    function toDateInputValue(dateStr) {
        if (!dateStr) return '';
        const s = String(dateStr).trim();
        // すでにyyyy-MM-dd形式
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        // yyyy/MM/dd (HH:mm)形式
        const slashMatch = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
        if (slashMatch) return slashMatch[1] + '-' + slashMatch[2].padStart(2,'0') + '-' + slashMatch[3].padStart(2,'0');
        // 令和X年Y月Z日 / X年Y月Z日 形式
        const jpMatch = s.match(/(?:令和(\d+|元)|(\d{4}))年(\d{1,2})月(\d{1,2})日/);
        if (jpMatch) {
            const year = jpMatch[2] ? parseInt(jpMatch[2]) : (jpMatch[1] === '元' ? 2019 : 2018 + parseInt(jpMatch[1]));
            return year + '-' + String(jpMatch[3]).padStart(2,'0') + '-' + String(jpMatch[4]).padStart(2,'0');
        }
        // Date()で解析を試みる
        try { const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0,10); } catch(e) {}
        return '';
    }
    function getTodayISO() { return new Date().toISOString().slice(0,10); }

    // Helper for date (Phase 4)
    function getJapaneseDateStr(date) {
        try {
            const d = date || new Date();
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const day = d.getDate();
            if (year > 2019 || (year === 2019 && month >= 5)) {
                const reiwaYear = year - 2018;
                return `令和${reiwaYear === 1 ? '元' : reiwaYear}年${month}月${day}日`;
            }
            return `${year}年${month}月${day}日`;
        } catch (e) { return ""; }
    }

    function mountMinimalFallback() {
        var lb = document.getElementById('loading-fallback');
        if (lb) lb.style.display = 'none';
        try {
            var minimal = Vue.createApp({ template: '<div style="padding:20px;font-size:18px;">簡易表示: Vue動作確認OK。本アプリの初期化で問題が発生しています。</div>', data: function() { return {}; } });
            minimal.mount('#app');
        } catch (e) {
            document.getElementById('critical-error').innerHTML = '<h3>マウントエラー</h3><pre>' + (e.message||e) + '</pre>';
            document.getElementById('critical-error').style.display = 'block';
        }
    }
    try {
        if (typeof Vue === 'undefined' || !Vue.createApp) {
            var ce = document.getElementById('critical-error');
            var lb = document.getElementById('loading-fallback');
            if (lb) lb.style.display = 'none';
            if (ce) { ce.style.display = 'block'; ce.innerHTML = '<h3>Vue.js 読み込みエラー</h3><p>Vue.js が読み込まれていません。CDN（cdn.jsdelivr.net）がブロックされていないか確認してください。</p><p>ファイアウォールやプロキシの設定もご確認ください。</p>'; }
            throw new Error('Vue is not loaded');
        }
        const { createApp, ref, reactive, onMounted, computed, nextTick, watch } = Vue;
        
        const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        // 改善3-3: 一意ID生成ヘルパー
        let _uidCounter = 0;
        const genUid = () => 'uid_' + Date.now().toString(36) + '_' + (++_uidCounter);
        // Auto-resize directive
        const vAutoResize = {
            mounted: (el) => {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
                el.addEventListener('input', () => {
                    el.style.height = 'auto';
                    el.style.height = el.scrollHeight + 'px';
                });
            },
            updated: (el) => {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            }
        };

        const app = createApp({
          directives: {
              autoResize: vAutoResize
          },
          setup() {
            const loading = ref(true); 
            const loadingMessage = ref("読込中"); 
            const currentTab = ref("menu"); 
            const userEmail = ref(""); 
            const auth = reactive({ isAdmin: false }); 
            const masters = reactive({ clients: [], sets: [], vendors: [] });
            const projects = ref([]); 
            const orders = ref([]); 
            const adminInvoices = ref([]); 
            const isReviewMode = ref(false);
            const isOrderPanelLoading = ref(false); // 発注書履歴パネルのローディング状態
            const showBackButton = ref(false);
            const isDirty = ref(false);
            const clipboardData = ref(null);
            const formSnapshot = ref(null);

            // 顧客名ドロップダウン用
            const allCompanies = computed(() => {
              const set = new Set();
              const list = [];
              (masters.clients || []).forEach(c => {
                if (c && !set.has(c)) { set.add(c); list.push({ name: c, type: '元請' }); }
              });
              (masters.vendors || []).forEach(v => {
                const n = v.name || v.displayName;
                if (n && !set.has(n)) { set.add(n); list.push({ name: n, type: '発注先' }); }
              });
              return list;
            });
            const clientDropdown = reactive({ show: false, filter: '' });
            const filteredCompanies = computed(() => {
              const q = (clientDropdown.filter || '').trim().toLowerCase();
              if (!q) return allCompanies.value;
              return allCompanies.value.filter(c => c.name.toLowerCase().includes(q));
            });

            // 一括単価変更
            const bulkPriceTarget = ref('price');
            const bulkPricePercent = ref(10);

            // Phase 2: マスタデータ
            const unifiedProducts = ref([]);
            const unitOptions = computed(() => {
                const units = new Set();
                unifiedProducts.value.forEach(p => { if (p.unit) units.add(p.unit); });
                return [...units].sort();
            });
            const setMasters = ref([]); // セット検索用
            const searchMasterKeyword = ref("");
            const searchSetKeyword = ref("");
            const materialPrices = ref([]);
            const searchMaterialKeyword = ref("");
            const materialEditIdx = ref(null); // null=none, 'new'=adding, number=editing
            const materialEditData = reactive({ product: '', spec: '', unit: '', price: 0 });
            const leftPanelMode = ref(null); // 'price' | 'set' | 'material' | null
            const activeLeftPanelRow = ref(null);
            const leftPanelContext = ref('estimate'); // 'estimate' | 'dedicated_order'

            // 選択モード（Toggle Mode）
            const isSelectionMode = ref(false);
            const lastSelectedIndex = ref(null); // Shift範囲選択用

            // 右クリックメニュー & セルナビゲーション
            const contextMenu = reactive({ show: false, x: 0, y: 0, rowIndex: -1, target: '' });
            const onRowContextMenu = (event, index, target) => {
                contextMenu.show = true;
                contextMenu.x = Math.min(event.clientX, window.innerWidth - 180);
                contextMenu.y = Math.min(event.clientY, window.innerHeight - 100);
                contextMenu.rowIndex = index;
                contextMenu.target = target;
            };
            const insertRow = (position) => {
                const idx = position === 'above' ? contextMenu.rowIndex : contextMenu.rowIndex + 1;
                if (contextMenu.target === 'estimate') {
                    form.items.splice(idx, 0, { _uid: genUid(), category: "", product: "", spec: "", qty: "", unit: "", price: "", cost: "", amount: 0, orderedQty: "", orderedAmount: 0, selected: false });
                } else {
                    dedicatedOrderForm.items.splice(idx, 0, { product: "", spec: "", vendor: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0, selected: false });
                }
                contextMenu.show = false;
            };
            const cellNav = (event) => {
                const el = event.target;
                const row = Number(el.dataset.row);
                const col = Number(el.dataset.col);
                if (isNaN(row) || isNaN(col)) return;
                const table = el.closest('table');
                if (!table) return;

                let newRow = row, newCol = col, shouldMove = false;
                const val = el.value || '';
                const isEmpty = val.length === 0;
                let atStart = true, atEnd = true;
                try { atStart = el.selectionStart === 0; atEnd = el.selectionStart === val.length; } catch(e) { /* type="number" does not support selectionStart */ }

                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    newRow = row + 1;
                    shouldMove = true;
                } else if (event.key === 'ArrowDown' && (isEmpty || atEnd)) {
                    event.preventDefault();
                    newRow = row + 1;
                    shouldMove = true;
                } else if (event.key === 'ArrowUp' && (isEmpty || atStart)) {
                    event.preventDefault();
                    newRow = row - 1;
                    shouldMove = true;
                } else if (event.key === 'ArrowRight' && (isEmpty || atEnd)) {
                    event.preventDefault();
                    newCol = col + 1;
                    shouldMove = true;
                } else if (event.key === 'ArrowLeft' && (isEmpty || atStart)) {
                    event.preventDefault();
                    newCol = col - 1;
                    shouldMove = true;
                } else if (event.key === 'Tab' && !event.shiftKey) {
                    event.preventDefault();
                    newCol = col + 1;
                    shouldMove = true;
                } else if (event.key === 'Tab' && event.shiftKey) {
                    event.preventDefault();
                    newCol = col - 1;
                    shouldMove = true;
                }

                if (shouldMove) {
                    let target = table.querySelector('[data-row="' + newRow + '"][data-col="' + newCol + '"]');
                    if (!target && (event.key === 'Tab' || event.key === 'Enter')) {
                        if (newCol > col) {
                            target = table.querySelector('[data-row="' + (newRow + 1) + '"][data-col="0"]');
                        } else if (newCol < 0) {
                            const maxCol = table.querySelectorAll('[data-row="' + (newRow - 1) + '"][data-col]');
                            if (maxCol.length) target = maxCol[maxCol.length - 1];
                        }
                    }
                    if (target) target.focus();
                }
            };

            // Phase 4: 専用発注画面データ
            const dedicatedOrderForm = reactive({
                header: { id: "", client: "", date: getTodayISO(), relEstId: "", location: "", project: "", period: "", payment: "", expiry: "", status: "発注書作成", visibility: "public", taxMode: "税別" },
                items: [{ product: "", spec: "", vendor: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0 }]
            });

            // 関連見積ID候補
            const estSuggestions = ref([]);
            const showEstSuggestions = ref(false);

            // 請求書受取用データ
            const invoiceFiles = ref([]);
            const selectedInvoiceFile = ref(null);
            const uploadedInvoiceFile = ref(null);
            const isAnalyzing = ref(false);
            const invoiceForm = reactive({ id: "", constructionId: "", project: "", date: "", person: "", contractor: "", amount: 0, offset: 0, content: "", location: "", fileId: "", status: "着工", initial: "", detectedKanryo: false });
            const activeProjects = ref([]);
            const orderBalance = ref(null);

            // 会計連携用データ
            const journalYear = ref(new Date().getFullYear());
            const journalMonth = ref(new Date().getMonth() + 1);
            const journalYears = ref([new Date().getFullYear()]);
            const showPreviewModal = ref(false);
            const previewData = reactive({ headers: [], rows: [] });
            const journalIncludeSales = ref(false); 
            const journalIncludePurchases = ref(true);
            
            // 入出金管理用
            const deposits = ref([]);
            const payments = ref([]);
            const depositForm = reactive({ id: "", date: "", estimateId: "", client: "", project: "", type: "振込", amount: 0, fee: 0, offset: 0, remarks: "", status: "確認済" });
            const paymentForm = reactive({ id: "", date: "", orderId: "", invoiceId: "", supplier: "", project: "", type: "振込", amount: 0, fee: 0, offset: 0, remarks: "", status: "確認済" });
            const showDepositModal = ref(false);
            const showPaymentModal = ref(false);
            
            // サジェスト用 (旧)
            const activeSuggestionIdx = ref(null);
            const filteredSuggestions = ref([]);
            const showSidePanel = ref(false); const clientHistory = ref([]);
            
            // 工事台帳用
            const showLedgerModal = ref(false);
            const ledgerData = ref(null);

            // 管理者サブタブ
            const adminSubTab = ref("approval");
            const analysisYear = ref(new Date().getFullYear());
            const analysisData = reactive({ monthly: [], ranking: [] });
            const analysisTotalSales = computed(() => analysisData.monthly.reduce((s, m) => s + m.sales, 0));
            const analysisTotalProfit = computed(() => analysisData.monthly.reduce((s, m) => s + m.profit, 0));
            let salesChartInstance = null;
            
            // リマインド機能
            const reminders = ref([]);
            const remindersLoading = ref(false);
            const fetchReminders = async () => {
                remindersLoading.value = true;
                try {
                    const json = await gas('apiGetReminders');
                    reminders.value = JSON.parse(json);
                } catch (e) {
                    console.warn('fetchReminders failed:', e);
                    reminders.value = [];
                } finally {
                    remindersLoading.value = false;
                }
            };
            // リマインドトリガー設定
            const reminderTriggerActive = ref(false);
            const reminderTriggerLoading = ref(false);
            const fetchReminderTriggerStatus = async () => {
                reminderTriggerLoading.value = true;
                try {
                    const json = await gas('apiGetReminderTriggerStatus');
                    const res = JSON.parse(json);
                    reminderTriggerActive.value = !!res.active;
                } catch (e) {
                    console.warn('fetchReminderTriggerStatus failed:', e);
                } finally {
                    reminderTriggerLoading.value = false;
                }
            };
            const toggleReminderTrigger = async (enable) => {
                reminderTriggerLoading.value = true;
                try {
                    const funcName = enable ? 'setupReminderTrigger' : 'removeReminderTrigger';
                    const json = await gas(funcName);
                    const res = JSON.parse(json);
                    if (res.success) {
                        reminderTriggerActive.value = enable;
                        notify(res.message, 'success');
                    } else {
                        notify(res.message || 'エラーが発生しました', 'error');
                    }
                } catch (e) {
                    notify('トリガー設定に失敗しました: ' + e.message, 'error');
                } finally {
                    reminderTriggerLoading.value = false;
                }
            };
            // LINE設定
            const lineSettings = reactive({ token: '', newUserId: '', hasToken: false, tokenPreview: '', userIds: [], channelSecret: '' });
            const lineSettingsLoading = ref(false);
            const fetchLineSettings = async () => {
                try {
                    const json = await gas('apiGetLineSettings');
                    const res = JSON.parse(json);
                    lineSettings.hasToken = res.hasToken;
                    lineSettings.tokenPreview = res.tokenPreview;
                    lineSettings.userIds = res.userIds || [];
                } catch (e) { console.warn('fetchLineSettings failed:', e); }
            };
            const saveLineToken = async () => {
                if (!lineSettings.token) return;
                lineSettingsLoading.value = true;
                try {
                    const json = await gas('apiSaveLineToken', lineSettings.token);
                    const res = JSON.parse(json);
                    if (res.success) { notify(res.message, 'success'); lineSettings.token = ''; await fetchLineSettings(); }
                    else { notify(res.message, 'error'); }
                } catch (e) { notify('トークン保存に失敗: ' + e.message, 'error'); }
                finally { lineSettingsLoading.value = false; }
            };
            const addLineUser = async () => {
                if (!lineSettings.newUserId || !lineSettings.newUserId.trim()) return;
                lineSettingsLoading.value = true;
                try {
                    const json = await gas('apiAddLineUser', lineSettings.newUserId.trim());
                    const res = JSON.parse(json);
                    if (res.success) { notify(res.message, 'success'); lineSettings.newUserId = ''; await fetchLineSettings(); }
                    else { notify(res.message, 'error'); }
                } catch (e) { notify('追加に失敗: ' + e.message, 'error'); }
                finally { lineSettingsLoading.value = false; }
            };
            const removeLineUser = async (userId) => {
                lineSettingsLoading.value = true;
                try {
                    const json = await gas('apiRemoveLineUser', userId);
                    const res = JSON.parse(json);
                    if (res.success) { notify(res.message, 'success'); await fetchLineSettings(); }
                    else { notify(res.message, 'error'); }
                } catch (e) { notify('削除に失敗: ' + e.message, 'error'); }
                finally { lineSettingsLoading.value = false; }
            };
            const testLineSend = async () => {
                lineSettingsLoading.value = true;
                try {
                    const json = await gas('apiTestLineSend');
                    const res = JSON.parse(json);
                    notify(res.message, res.success ? 'success' : 'error');
                } catch (e) { notify('テスト送信に失敗: ' + e.message, 'error'); }
                finally { lineSettingsLoading.value = false; }
            };

            // LINE Bot Webhook
            const webhookUrl = ref('');
            const fetchWebhookUrl = async () => {
                try {
                    const json = await gas('apiGetWebhookUrl');
                    const res = JSON.parse(json);
                    if (res.success) webhookUrl.value = res.url;
                    else notify(res.message, 'error');
                } catch (e) { notify('Webhook URL取得に失敗: ' + e.message, 'error'); }
            };
            const copyWebhookUrl = () => {
                if (!webhookUrl.value) return;
                navigator.clipboard.writeText(webhookUrl.value).then(() => {
                    notify('Webhook URLをコピーしました', 'success');
                }).catch(() => {
                    // fallback
                    const el = document.createElement('textarea');
                    el.value = webhookUrl.value;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    notify('Webhook URLをコピーしました', 'success');
                });
            };
            const saveLineChannelSecret = async () => {
                if (!lineSettings.channelSecret) return;
                lineSettingsLoading.value = true;
                try {
                    const json = await gas('apiSaveLineChannelSecret', lineSettings.channelSecret);
                    const res = JSON.parse(json);
                    if (res.success) {
                        notify(res.message, 'success');
                        lineSettings.channelSecret = '';
                        webhookUrl.value = '';
                    } else { notify(res.message, 'error'); }
                } catch (e) { notify('シークレット保存に失敗: ' + e.message, 'error'); }
                finally { lineSettingsLoading.value = false; }
            };
            // Notification State & Helper
            const notifications = ref([]);
            let _notifyId = 0;
            const notify = (msg, type='success') => {
                const id = ++_notifyId;
                notifications.value.push({ id, message: msg, type });
                setTimeout(() => {
                    const idx = notifications.value.findIndex(n => n.id === id);
                    if(idx !== -1) notifications.value.splice(idx, 1);
                }, 3000);
            };

            // Custom Confirm State & Helper
            const confirmState = reactive({ show: false, message: "", resolve: null });
            const confirmAction = (msg) => {
                confirmState.message = msg;
                confirmState.show = true;
                return new Promise((resolve) => {
                    confirmState.resolve = resolve;
                });
            };
            const handleConfirm = (result) => {
                confirmState.show = false;
                if (confirmState.resolve) {
                    confirmState.resolve(result);
                    confirmState.resolve = null;
                }
            };

            // Save Confirmation State
            const saveConfirmState = reactive({ show: false, nextAction: null, saving: false });
            
            // Navigation Helper with Save Check
            const checkUnsavedChanges = (nextAction) => {
                const isFormEmpty = () => {
                    if (currentTab.value === 'dedicated_order') {
                        return dedicatedOrderForm.items.length === 0 ||
                            (dedicatedOrderForm.items.length === 1 && !String(dedicatedOrderForm.items[0].product || '').trim());
                    }
                    if (currentTab.value === 'edit') {
                        if (sidePanelMode.value === 'order' && orderInPanel.items.length > 0) return false;
                        const hasClient = String(form.header.client || '').trim();
                        const hasProject = String(form.header.project || '').trim();
                        const hasItems = form.items.some(i => String(i.product || '').trim() || String(i.category || '').trim());
                        return !form.header.id && !hasClient && !hasProject && !hasItems;
                    }
                    return true;
                };
                if (isDirty.value && !isFormEmpty()) {
                    saveConfirmState.nextAction = nextAction;
                    saveConfirmState.show = true;
                } else {
                    if (isFormEmpty()) isDirty.value = false;
                    nextAction();
                }
            };

            const handleSaveAndMove = (shouldSave) => {
                if (shouldSave) {
                    if (saveConfirmState.saving) return;
                    saveConfirmState.saving = true;
                    const saveTarget = isReviewMode.value ? 'admin' : 'public';
                    const doSave = async () => {
                        if (currentTab.value === 'dedicated_order') {
                            const mappedItems = dedicatedOrderForm.items.filter(i => String(i.product || '').trim()).map(i => {
                                const qty = Number(i.exeQty) || 0;
                                const cost = Number(i.exePrice) || 0;
                                const amount = Math.round(qty * cost);
                                return { ...i, qty, unit: i.exeUnit || i.estUnit || '', cost, amount, vendor: (i.vendor || '').trim() };
                            });
                            return gas('apiSaveOrderOnly', JSON.stringify({ header: { ...dedicatedOrderForm.header, vendor: "" }, items: mappedItems }));
                        }
                        if (currentTab.value === 'edit' && sidePanelMode.value === 'order' && orderInPanel.items.length > 0) {
                            saveOrderPanelToEstimate();
                            orderInPanel.items = [];
                            try { localStorage.removeItem('orderPanelDraft'); } catch(e) {}
                            const saved = await saveEstimate('public', true);
                            if (!saved) return JSON.stringify({ success: false, message: "見積の保存に失敗しました" });
                            return JSON.stringify({ success: true, id: form.header.id });
                        }
                        if (currentTab.value === 'edit') {
                            if (saveTarget === 'admin') { form.header.status = '管理者確認中'; form.header.visibility = 'admin'; }
                            else { form.header.visibility = 'public'; }
                            return gas('apiSaveUnifiedData', JSON.stringify({ estimate: form }));
                        }
                        return JSON.stringify({ success: true });
                    };
                    doSave()
                        .then((res) => {
                            const r = JSON.parse(res);
                            if (!r.success) {
                                notify("保存失敗: " + (r.message || "不明なエラー"), "error");
                                saveConfirmState.saving = false;
                                return;
                            }
                            if (currentTab.value === 'edit') { form.header.id = r.id; }
                            isDirty.value = false;
                            saveConfirmState.show = false;
                            const fn = saveConfirmState.nextAction;
                            saveConfirmState.nextAction = null;
                            saveConfirmState.saving = false;
                            notify("保存しました");
                            // 自動発注生成されるため発注キャッシュを更新
                            fetchOrders(true).catch(() => {});
                            if (fn) fn();
                        })
                        .catch((e) => {
                            notify("保存中にエラーが発生しました: " + (e?.message || e), "error");
                            saveConfirmState.saving = false;
                        });
                } else {
                    saveConfirmState.show = false;
                    isDirty.value = false;
                    if (sidePanelMode.value === 'order') orderInPanel.items = []; // 破棄時は発注パネルもクリア
                    const fn = saveConfirmState.nextAction;
                    saveConfirmState.nextAction = null;
                    if (fn) fn();
                }
            };

            // 定義 (form, orderForm)
            const form = reactive({ header: { id: "", date: "", client: "", project: "", location: "", period: "", payment: "", expiry: "", status: "見積提出", visibility: "public", defaultVendor: "", taxMode: "税別" }, items: [] });
            const filter = reactive({ year: "", month: "", client: "" });
            const listSubTab = ref('estimate'); // 'estimate' | 'order'
            const orderListFilter = reactive({ vendor: '', year: '', month: '' });
            
            const showOcrModal = ref(false); const ocrFiles = ref([]); const isOcrLoading = ref(false); const selectedOcrFiles = ref([]);
            const ocrTab = ref('upload'); const ocrUploadFiles = ref([]); const ocrResults = ref([]); const showOcrPreview = ref(false); const ocrProcessing = ref(false);
            const showDraftModal = ref(false); const drafts = ref([]); const isDraftLoading = ref(false);
            const estimateCandidates = ref([]); // 追加
            
            // 業者選択モーダル用
            const showVendorSelectModal = ref(false);
            const vendorCandidates = ref([]);
            
            // 一括選択モーダル用（業者別・工種別）
            const showBatchSelectModal = ref(false);
            const batchSelectOptions = ref([]);
            const batchSelectType = ref(''); // 'vendor' | 'category'
            
            // 改善7: 業者別プレビュー用
            const vendorSplitPreview = ref(null); // { vendors: { name, items, total }, totalAmount, action: 'save'|'pdf' }
            
            // --- AIアシスタントボタン表示/非表示 ---
            const assistantBtnVisible = ref(localStorage.getItem('assistantBtnVisible') !== 'false');
            const assistantCtxMenu = reactive({ show: false, x: 0, y: 0 });
            const openAssistantCtxMenu = (e) => {
                const menuW = 170, menuH = 80;
                assistantCtxMenu.x = Math.min(e.clientX, window.innerWidth - menuW);
                assistantCtxMenu.y = Math.min(e.clientY, window.innerHeight - menuH);
                assistantCtxMenu.show = true;
            };
            const setAssistantBtnVisible = (val) => {
                assistantBtnVisible.value = val;
                localStorage.setItem('assistantBtnVisible', val);
                assistantCtxMenu.show = false;
                if (!val && showChatBot.value) showChatBot.value = false;
            };

            // --- AIチャットボット用データ ---
            const showChatBot = ref(false);
            const chatInput = ref("");
            const chatMessages = ref([
                { role: 'ai', text: 'こんにちは!\nシステムの操作方法や、コードの仕組みについて何でも聞いてください。' }
            ]);
            const isChatThinking = ref(false);

            // --- AI操作アシスタント用データ ---
            const chatMode = ref('help'); // 'help' | 'action'
            const aiAssistantMessages = ref([
                { role: 'ai', text: '見積データを自然言語で操作できます。\n例: 「発注先を全て○○にして」「単価を10%上げて」' }
            ]);
            const aiAssistantInput = ref('');
            const isAiAssistantThinking = ref(false);
            const aiPendingActions = ref(null); // { actions, summary, confidence }

            // --- チャットボット ドラッグ位置管理 ---
            const chatPosX = ref(null);
            const chatPosY = ref(null);
            const isDragging = ref(false);
            const dragStarted = ref(false);

            const chatDragState = { startX: 0, startY: 0, startPosX: 0, startPosY: 0 };
            const DRAG_THRESHOLD = 5;

            const initChatPosition = () => {
                if (chatPosX.value === null) {
                    chatPosX.value = window.innerWidth - 20 - 56;
                    chatPosY.value = window.innerHeight - 20 - 56;
                }
            };

            const onChatDragStart = (e) => {
                const point = e.touches ? e.touches[0] : e;
                chatDragState.startX = point.clientX;
                chatDragState.startY = point.clientY;
                chatDragState.startPosX = chatPosX.value;
                chatDragState.startPosY = chatPosY.value;
                isDragging.value = true;
                dragStarted.value = false;

                document.addEventListener('mousemove', onChatDragMove);
                document.addEventListener('mouseup', onChatDragEnd);
                document.addEventListener('touchmove', onChatDragMove, { passive: false });
                document.addEventListener('touchend', onChatDragEnd);
            };

            const onChatDragMove = (e) => {
                if (!isDragging.value) return;
                const point = e.touches ? e.touches[0] : e;
                const dx = point.clientX - chatDragState.startX;
                const dy = point.clientY - chatDragState.startY;

                if (!dragStarted.value) {
                    if (Math.abs(dx) < DRAG_THRESHOLD && Math.abs(dy) < DRAG_THRESHOLD) return;
                    dragStarted.value = true;
                    document.body.classList.add('chatbot-dragging');
                }

                e.preventDefault();
                const btnSize = 56;
                const panelW = 500;
                const panelH = 650 + btnSize + 16;
                const elW = showChatBot.value ? panelW : btnSize;
                const elH = showChatBot.value ? panelH : btnSize;

                chatPosX.value = Math.max(0, Math.min(chatDragState.startPosX + dx, window.innerWidth - elW));
                chatPosY.value = Math.max(0, Math.min(chatDragState.startPosY + dy, window.innerHeight - elH));
            };

            const onChatDragEnd = () => {
                document.removeEventListener('mousemove', onChatDragMove);
                document.removeEventListener('mouseup', onChatDragEnd);
                document.removeEventListener('touchmove', onChatDragMove);
                document.removeEventListener('touchend', onChatDragEnd);
                isDragging.value = false;
                document.body.classList.remove('chatbot-dragging');
            };

            const onChatBtnClick = () => {
                if (dragStarted.value) { dragStarted.value = false; return; }
                showChatBot.value = !showChatBot.value;
            };

            // --- フローティングパネル ドラッグ処理 ---
            const onFloatingPanelDragStart = (e) => {
                const point = e.touches ? e.touches[0] : e;
                floatingPanelDragState.startX = point.clientX;
                floatingPanelDragState.startY = point.clientY;
                floatingPanelDragState.startPosX = floatingPanelPosX.value;
                floatingPanelDragState.startPosY = floatingPanelPosY.value;
                isFloatingPanelDragging.value = true;
                floatingPanelDragStarted.value = false;
                document.addEventListener('mousemove', onFloatingPanelDragMove);
                document.addEventListener('mouseup', onFloatingPanelDragEnd);
                document.addEventListener('touchmove', onFloatingPanelDragMove, { passive: false });
                document.addEventListener('touchend', onFloatingPanelDragEnd);
            };
            const onFloatingPanelDragMove = (e) => {
                if (!isFloatingPanelDragging.value) return;
                const point = e.touches ? e.touches[0] : e;
                const dx = point.clientX - floatingPanelDragState.startX;
                const dy = point.clientY - floatingPanelDragState.startY;
                if (!floatingPanelDragStarted.value) {
                    if (Math.abs(dx) < DRAG_THRESHOLD && Math.abs(dy) < DRAG_THRESHOLD) return;
                    floatingPanelDragStarted.value = true;
                    document.body.classList.add('floating-panel-dragging');
                }
                e.preventDefault();
                floatingPanelPosX.value = Math.max(0, Math.min(floatingPanelDragState.startPosX + dx, window.innerWidth - 850));
                floatingPanelPosY.value = Math.max(0, Math.min(floatingPanelDragState.startPosY + dy, window.innerHeight - 100));
            };
            const onFloatingPanelDragEnd = () => {
                document.removeEventListener('mousemove', onFloatingPanelDragMove);
                document.removeEventListener('mouseup', onFloatingPanelDragEnd);
                document.removeEventListener('touchmove', onFloatingPanelDragMove);
                document.removeEventListener('touchend', onFloatingPanelDragEnd);
                isFloatingPanelDragging.value = false;
                document.body.classList.remove('floating-panel-dragging');
            };

            // パネル開閉時にビューポート内に収める
            watch(showChatBot, (isOpen) => {
                nextTick(() => {
                    if (isOpen) {
                        const panelW = 500;
                        const panelH = 650 + 56 + 16;
                        chatPosX.value = Math.max(0, Math.min(chatPosX.value, window.innerWidth - panelW));
                        chatPosY.value = Math.max(0, Math.min(chatPosY.value, window.innerHeight - panelH));
                    }
                });
            });

            // サイドパネル用
            const sidePanelMode = ref(null); // 'history' | 'order' | null
            const historyList = ref([]);
            const orderInPanel = reactive({ 
                vendor: '',
                items: [] 
            });
            const orderPanelTab = ref('create'); // 'create' | 'list'
            const batchVendorSelect = ref('');
            const tempBatchVendor = ref(''); // 発注パネル用の一括発注先
            const orderHistoryPanelFilter = ref(''); // 発注書履歴のフィルタ用

            // --- フローティングプレビューパネル ---
            const floatingPanel = reactive({
                show: false,
                loading: false,
                mode: 'detail',           // 'list' | 'detail'
                sourceType: 'estimate',   // 'estimate' | 'order'
                targetContext: 'estimate', // 'estimate' | 'order' (追加先)
                listItems: [],            // リストモード用
                listFilter: '',           // リストモード絞り込み
                header: null,
                items: [],
                selectAll: false
            });
            const floatingPanelPosX = ref(200);
            const floatingPanelPosY = ref(100);
            const isFloatingPanelDragging = ref(false);
            const floatingPanelDragStarted = ref(false);
            const floatingPanelDragState = { startX: 0, startY: 0, startPosX: 0, startPosY: 0 };
            
            const currentEstimateOrders = computed(() => {
                if (!form.header.id) return [];
                return orders.value.filter(o => o.relEstId === form.header.id);
            });

            // 発注書履歴パネル用のフィルタ computed
            const filteredCurrentEstimateOrders = computed(() => {
                const currentOrders = currentEstimateOrders.value;
                if (!orderHistoryPanelFilter.value) return currentOrders;
                return currentOrders.filter(o => o.vendor === orderHistoryPanelFilter.value);
            });

            const currentEstimateOrdersVendors = computed(() => {
                const vendors = [...new Set(currentEstimateOrders.value.map(o => o.vendor).filter(Boolean))];
                return vendors.sort();
            });

            // Phase 2: 左パネル用 computed (修正: 表示上限の緩和)
            const filteredMasters = computed(() => {
                const kw = searchMasterKeyword.value.toLowerCase().trim();
                // 修正: 制限を1000件に緩和して全件表示を可能に
                if (!kw) return unifiedProducts.value.slice(0, 1000);
                try {
                    const keywords = kw.split(/\s+/).filter(k => k);
                    const result = unifiedProducts.value.filter(m => {
                        const p = String(m.product || '').toLowerCase();
                        const s = String(m.spec || '').toLowerCase();
                        const c = String(m.category || '').toLowerCase();
                        const src = String(m.source || '').toLowerCase();
                        return keywords.every(k => p.includes(k) || s.includes(k) || c.includes(k) || src.includes(k));
                    }).slice(0, 1000);
                    return result;
                } catch(e) {
                    return [];
                }
            });

            const filteredMaterialPrices = computed(() => {
                const kw = searchMaterialKeyword.value.toLowerCase().trim();
                if (!kw) return materialPrices.value.slice(0, 1000);
                try {
                    const keywords = kw.split(/\s+/).filter(k => k);
                    return materialPrices.value.filter(m => {
                        const p = String(m.product || '').toLowerCase();
                        const s = String(m.spec || '').toLowerCase();
                        const u = String(m.unit || '').toLowerCase();
                        return keywords.every(k => p.includes(k) || s.includes(k) || u.includes(k));
                    }).slice(0, 1000);
                } catch(e) { return []; }
            });

            const openMaterialAdd = () => {
                Object.assign(materialEditData, { product: '', spec: '', unit: '', price: 0 });
                materialEditIdx.value = 'new';
            };
            const openMaterialEdit = (m, idx) => {
                Object.assign(materialEditData, { product: m.product, spec: m.spec || '', unit: m.unit || '', price: m.price || 0 });
                materialEditIdx.value = idx;
            };
            const cancelMaterialEdit = () => { materialEditIdx.value = null; };
            const saveMaterialItem = async () => {
                if (!materialEditData.product.trim()) return notify("品名は必須です", "error");
                const item = {
                    product: materialEditData.product.trim(),
                    spec: materialEditData.spec.trim(),
                    unit: materialEditData.unit.trim(),
                    price: Number(materialEditData.price) || 0
                };
                const isNew = materialEditIdx.value === 'new';
                // 楽観的更新: ローカル配列を即座に反映
                if (isNew) {
                    materialPrices.value.unshift({ ...item, updatedAt: '' });
                } else {
                    const idx = materialEditIdx.value;
                    if (idx != null && materialPrices.value[idx]) {
                        Object.assign(materialPrices.value[idx], item);
                    }
                }
                materialEditIdx.value = null;
                notify(isNew ? "追加しました" : "更新しました");
                // バックグラウンドでAPI保存
                gas('apiUpsertMaterialPrices', JSON.stringify([item]))
                    .catch(e => notify("保存失敗: " + e.message, "error"));
            };
            const deleteMaterialItem = async (m) => {
                if (!confirm(`「${m.product}」を削除しますか？`)) return;
                // 楽観的更新: ローカル配列から即座に削除
                const idx = materialPrices.value.findIndex(p => p.product === m.product && (p.spec || '') === (m.spec || ''));
                if (idx !== -1) materialPrices.value.splice(idx, 1);
                materialEditIdx.value = null;
                notify("削除しました");
                // バックグラウンドでAPI削除
                gas('apiDeleteMaterialPrice', m.product, m.spec || '')
                    .then(res => { const r = JSON.parse(res); if (!r.success) notify(r.message || "削除失敗", "error"); })
                    .catch(e => notify("削除エラー: " + e.message, "error"));
            };

            const filteredSets = computed(() => {
                const kw = searchSetKeyword.value.toLowerCase().trim();
                let filtered = setMasters.value.filter(s => s.count > 0 && (s.totalPrice || 0) > 0);
                if (!kw) return filtered.slice(0, 50);
                return filtered.filter(s => s.name.toLowerCase().includes(kw)).slice(0, 50);
            });

            const floatingPanelCheckedCount = computed(() => floatingPanel.items.filter(it => it._checked).length);
            const floatingPanelFilteredList = computed(() => {
                if (!floatingPanel.listFilter) return floatingPanel.listItems;
                const kw = floatingPanel.listFilter;
                return floatingPanel.listItems.filter(it =>
                    (it.client || '').includes(kw) || (it.project || '').includes(kw) || (it.vendor || '').includes(kw) || (it.location || '').includes(kw) || (it.period || '').includes(kw)
                );
            });

            // 発注案件一覧用 computed
            const orderListVendors = computed(() => {
                const vendors = [...new Set(orders.value.map(o => o.vendor).filter(Boolean))];
                return vendors.sort();
            });
            const orderListYears = computed(() => {
                const ys = new Set(orders.value.map(o => {
                    try { return new Date(o.date).getFullYear(); } catch(e) { return null; }
                }).filter(y => y && !isNaN(y)));
                return Array.from(ys).sort((a, b) => b - a);
            });
            const filteredOrderList = computed(() => {
                let list = orders.value.filter(o => o.visibility !== 'admin');
                if (orderListFilter.vendor) list = list.filter(o => o.vendor === orderListFilter.vendor);
                if (orderListFilter.year) list = list.filter(o => new Date(o.date).getFullYear() == orderListFilter.year);
                if (orderListFilter.month) list = list.filter(o => new Date(o.date).getMonth() + 1 == orderListFilter.month);
                return list;
            });

            // Phase 4: 専用発注画面ロジック
            const createNewDedicatedOrder = () => {
                const hasData = dedicatedOrderForm.header.id || dedicatedOrderForm.header.client ||
                                dedicatedOrderForm.items.some(i => String(i.product || '').trim());
                if (hasData) {
                    formSnapshot.value = { source: 'dedicated_order', header: JSON.parse(JSON.stringify(dedicatedOrderForm.header)), items: JSON.parse(JSON.stringify(dedicatedOrderForm.items)) };
                }
                dedicatedOrderForm.header = { id: "", client: "", date: getTodayISO(), relEstId: "", location: "", project: "", period: "", payment: "", expiry: "", status: "発注書作成", visibility: "public" };
                dedicatedOrderForm.items = [{ product: "", spec: "", vendor: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0, selected: false }];
                estSuggestions.value = [];
                showEstSuggestions.value = false;
                isDirty.value = false;
            };
            const restoreSnapshot = () => {
                if (!formSnapshot.value) return;
                const snap = formSnapshot.value;
                if (snap.source === 'edit') {
                    Object.assign(form.header, snap.header);
                    form.items = snap.items;
                } else if (snap.source === 'dedicated_order') {
                    Object.assign(dedicatedOrderForm.header, snap.header);
                    dedicatedOrderForm.items = snap.items;
                } else if (snap.source === 'invoice') {
                    Object.assign(invoiceForm, snap.data);
                }
                formSnapshot.value = null;
                isDirty.value = true;
                notify("元に戻しました");
            };
            const calcDedicatedLine = (item) => {
                item.estAmount = Math.round((Number(item.estQty)||0) * (Number(item.estPrice)||0));
                item.exeAmount = Math.round((Number(item.exeQty)||0) * (Number(item.exePrice)||0));
            };
            const totalDedicatedEstimate = computed(() => dedicatedOrderForm.items.reduce((s, i) => s + (Number(i.estAmount)||0), 0));
            const totalDedicatedAmount = computed(() => dedicatedOrderForm.items.reduce((s, i) => s + (Number(i.exeAmount)||0), 0));

            // 関連見積ID自動入力: 顧客名で見積を絞り込み
            const matchingEstimates = computed(() => {
                const client = (dedicatedOrderForm.header.client || '').trim();
                if (!client || !Array.isArray(projects.value)) return [];
                let matches = projects.value.filter(p => p.client === client && p.visibility !== 'admin');
                const proj = (dedicatedOrderForm.header.project || '').trim();
                if (proj) matches = matches.filter(p => (p.project || '').includes(proj));
                return matches;
            });

            const applyEstimateToOrderHeader = async (estId) => {
                try {
                    const res = await gas('apiGetEstimateDetails', estId);
                    const data = JSON.parse(res);
                    if (!data || data.error) return;
                    dedicatedOrderForm.header.relEstId = estId;
                    dedicatedOrderForm.header.project = data.header.project || dedicatedOrderForm.header.project;
                    dedicatedOrderForm.header.location = data.header.location || dedicatedOrderForm.header.location;
                    dedicatedOrderForm.header.period = data.header.period || dedicatedOrderForm.header.period;
                    dedicatedOrderForm.header.payment = data.header.payment || dedicatedOrderForm.header.payment;
                    dedicatedOrderForm.header.expiry = data.header.expiry || dedicatedOrderForm.header.expiry;
                } catch(e) { console.warn('見積ヘッダー補完失敗:', e); }
            };

            const onDedicatedClientSelect = (clientName) => {
                dedicatedOrderForm.header.client = clientName;
                clientDropdown.show = false;
                const matches = projects.value.filter(p => p.client === clientName && p.visibility !== 'admin');
                if (matches.length === 1) {
                    applyEstimateToOrderHeader(matches[0].id);
                    estSuggestions.value = [];
                    showEstSuggestions.value = false;
                } else if (matches.length > 1) {
                    estSuggestions.value = matches;
                    showEstSuggestions.value = true;
                } else {
                    estSuggestions.value = [];
                    showEstSuggestions.value = false;
                }
            };

            const selectEstimateSuggestion = (est) => {
                applyEstimateToOrderHeader(est.id);
                showEstSuggestions.value = false;
            };

            // コピー＆ペースト機能
            const copyDocument = () => {
                const src = currentTab.value;
                if (src === 'edit') {
                    clipboardData.value = {
                        source: 'edit',
                        header: JSON.parse(JSON.stringify(form.header)),
                        items: JSON.parse(JSON.stringify(form.items))
                    };
                } else if (src === 'dedicated_order') {
                    clipboardData.value = {
                        source: 'dedicated_order',
                        header: JSON.parse(JSON.stringify(dedicatedOrderForm.header)),
                        items: JSON.parse(JSON.stringify(dedicatedOrderForm.items))
                    };
                }
                notify("書類をコピーしました");
            };
            const pasteDocument = () => {
                if (!clipboardData.value) return notify("コピーされたデータがありません", "error");
                const dst = currentTab.value;
                const src = clipboardData.value.source;
                const h = clipboardData.value.header;
                const items = clipboardData.value.items;

                if (dst === 'edit') {
                    form.header.client = h.client || "";
                    form.header.project = h.project || "";
                    form.header.location = h.location || "";
                    form.header.period = h.period || "";
                    form.header.payment = h.payment || "";
                    form.header.expiry = h.expiry || "";
                    if (src === 'edit') {
                        form.items = items.map(i => ({ ...i, _uid: genUid(), selected: false }));
                        form.items.forEach(i => calcLine(i));
                    } else {
                        form.items = items.map(i => ({
                            category: "", product: i.product || "", spec: i.spec || "",
                            qty: Number(i.estQty) || 0, unit: i.estUnit || "", price: Number(i.estPrice) || 0,
                            amount: Number(i.estAmount) || 0, cost: Number(i.exePrice) || 0,
                            vendor: i.vendor || "", exeUnit: i.exeUnit || "", remarks: "", selected: false
                        }));
                        form.items.forEach(i => calcLine(i));
                    }
                } else if (dst === 'dedicated_order') {
                    dedicatedOrderForm.header.client = h.client || "";
                    dedicatedOrderForm.header.project = h.project || "";
                    dedicatedOrderForm.header.location = h.location || "";
                    dedicatedOrderForm.header.period = h.period || "";
                    dedicatedOrderForm.header.payment = h.payment || "";
                    dedicatedOrderForm.header.expiry = h.expiry || "";
                    if (src === 'edit') dedicatedOrderForm.header.relEstId = h.id || "";
                    if (src === 'dedicated_order') {
                        dedicatedOrderForm.items = items.map(i => ({ ...i }));
                        dedicatedOrderForm.items.forEach(i => calcDedicatedLine(i));
                    } else {
                        dedicatedOrderForm.items = items.map(i => ({
                            product: i.product || "", spec: i.spec || "", vendor: i.vendor || "",
                            estQty: Number(i.qty) || 0, estUnit: i.unit || "",
                            estPrice: Number(i.price) || 0, estAmount: Number(i.amount) || 0,
                            exeQty: Number(i.qty) || 0, exeUnit: i.exeUnit || i.unit || "",
                            exePrice: Number(i.cost) || 0, exeAmount: Math.round((Number(i.qty)||0) * (Number(i.cost)||0)),
                            selected: false
                        }));
                        dedicatedOrderForm.items.forEach(i => calcDedicatedLine(i));
                    }
                }
                isDirty.value = true;
                notify("書類を貼り付けました");
            };

            const saveDedicatedOrder = async () => {
                if(dedicatedOrderForm.items.length === 0) return notify("明細がありません", "error");
                const hasVendor = dedicatedOrderForm.items.some(i => String(i.vendor || '').trim());
                if (!hasVendor) return notify("発注先が入力されている明細がありません", "error");

                loadingMessage.value = '保存中...';
                loading.value = true;
                try {
                    // header.vendor は空にして、各 item.vendor を使用させる
                    // バックエンドが期待するフィールド名(qty/unit/cost/amount)にマッピング
                    const mappedItems = dedicatedOrderForm.items.filter(i => String(i.product || '').trim()).map(i => {
                        const qty = Number(i.exeQty) || 0;
                        const cost = Number(i.exePrice) || 0;
                        const amount = Math.round(qty * cost);
                        return { ...i, qty, unit: i.exeUnit || i.estUnit || '', cost, amount, vendor: (i.vendor || '').trim() };
                    });
                    const payload = JSON.stringify({ header: { ...dedicatedOrderForm.header, vendor: "" }, items: mappedItems });
                    const res = await gas('apiSaveOrderOnly', payload);
                    const r = JSON.parse(res);
                    if(r.success) {
                        notify("保存しました");
                        if (r.id) dedicatedOrderForm.header.id = r.id;
                        await fetchOrders(true); // 保存後は強制的に再取得
                        isDirty.value = false;
                    } else {
                        notify("保存失敗: " + r.message, "error");
                    }
                } catch(e) {
                    notify("通信エラー: " + e.message, "error");
                } finally {
                    loading.value = false;
                }
            };

            const dedicatedOrderPdfMode = ref(false);

            const createDedicatedOrderPdf = () => {
                const vendors = new Set();
                dedicatedOrderForm.items.forEach(item => {
                    if (String(item.vendor || '').trim()) vendors.add(item.vendor.trim());
                });
                const vendorList = Array.from(vendors);
                if (vendorList.length === 0) {
                    return notify("発注先が入力されている明細がありません", "error");
                }
                if (vendorList.length === 1) {
                    selectDedicatedVendorAndPrint(vendorList[0]);
                } else {
                    dedicatedOrderPdfMode.value = true;
                    vendorCandidates.value = vendorList;
                    showVendorSelectModal.value = true;
                }
            };

            const selectDedicatedVendorAndPrint = async (vendor) => {
                showVendorSelectModal.value = false;
                dedicatedOrderPdfMode.value = false;
                loadingMessage.value = '発注書作成中...';
                loading.value = true;
                try {
                    const validItems = dedicatedOrderForm.items.filter(i => String(i.product || '').trim());
                    const itemsWithAmount = validItems.map(i => {
                        const qty = Number(i.exeQty) || 0;
                        const cost = Number(i.exePrice) || 0;
                        const amount = Math.round(qty * cost);
                        return { ...i, qty, cost, amount, vendor: (i.vendor || '').trim() };
                    });
                    const payload = {
                        header: { ...dedicatedOrderForm.header, vendor },
                        items: itemsWithAmount
                    };
                    const res = await gas('apiCreateOrderPdf', JSON.stringify(payload), vendor);
                    const r = JSON.parse(res);
                    if (r.success) {
                        openUrl(r.url);
                        notify("発注書を作成しました");
                    } else {
                        notify(r.message, "error");
                    }
                } catch(e) {
                    notify("エラー: " + e.message, "error");
                } finally {
                    loading.value = false;
                }
            };

            const loadOrderFromHistory = async (orderId) => {
                loadingMessage.value = '読込中';
                loading.value = true;
                try {
                    const res = await gas('apiGetOrderDetails', orderId);
                    const data = JSON.parse(res);
                    if (data.error) {
                        notify(data.error, "error");
                        return;
                    }
                    dedicatedOrderForm.header = {
                        id: data.header.id || "",
                        client: data.header.client || "",
                        date: toDateInputValue(data.header.date) || getTodayISO(),
                        relEstId: data.header.relEstId || "",
                        location: data.header.location || "",
                        project: data.header.project || "",
                        period: data.header.period || "",
                        payment: data.header.payment || "",
                        expiry: data.header.expiry || "",
                        status: "発注書作成",
                        visibility: "public"
                    };
                    dedicatedOrderForm.items = (data.items || []).map(it => ({
                        product: it.product || "",
                        spec: it.spec || "",
                        vendor: it.vendor || "",
                        estQty: it.estQty || it.qty || 0,
                        estUnit: it.estUnit || it.unit || "",
                        estPrice: it.estPrice || it.price || 0,
                        estAmount: it.estAmount || it.amount || 0,
                        exeQty: it.exeQty || it.qty || 0,
                        exeUnit: it.exeUnit || it.unit || "",
                        exePrice: it.exePrice || it.cost || 0,
                        exeAmount: it.exeAmount || it.amount || 0,
                        selected: false
                    }));
                    if (dedicatedOrderForm.items.length === 0) {
                        dedicatedOrderForm.items = [{ product: "", spec: "", vendor: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0, selected: false }];
                    }
                    currentTab.value = 'dedicated_order';
                    notify("発注データをフォームに読み込みました");
                } catch(e) {
                    notify("読込失敗: " + (e?.message || e), "error");
                } finally {
                    loading.value = false;
                }
            };

            const loadEstimateToOrder = async (estId) => {
                loadingMessage.value = '見積データ読込中';
                loading.value = true;
                try {
                    const res = await gas('apiGetEstimateDetails', estId);
                    const data = JSON.parse(res);
                    if (!data || data.error) {
                        notify(data?.error || "見積データが見つかりません", "error");
                        return;
                    }
                    dedicatedOrderForm.header = {
                        id: "",
                        client: data.header.client || "",
                        date: getTodayISO(),
                        relEstId: estId,
                        location: data.header.location || "",
                        project: data.header.project || "",
                        period: data.header.period || "",
                        payment: data.header.payment || "",
                        expiry: data.header.expiry || "",
                        status: "発注書作成",
                        visibility: "public"
                    };
                    dedicatedOrderForm.items = (data.items || []).map(it => {
                        const qty = Number(it.qty) || 0;
                        const cost = Number(it.cost) || 0;
                        return {
                            product: it.product || "",
                            spec: it.spec || "",
                            vendor: it.vendor || "",
                            estQty: qty,
                            estUnit: it.unit || "",
                            estPrice: Number(it.price) || 0,
                            estAmount: Number(it.amount) || 0,
                            exeQty: qty,
                            exeUnit: it.unit || "",
                            exePrice: cost,
                            exeAmount: Math.round(cost * qty),
                            selected: false
                        };
                    });
                    if (dedicatedOrderForm.items.length === 0) {
                        dedicatedOrderForm.items = [{ product: "", spec: "", vendor: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0, selected: false }];
                    }
                    currentTab.value = 'dedicated_order';
                    notify("見積データを発注フォームに読み込みました");
                } catch(e) {
                    notify("読込失敗: " + (e?.message || e), "error");
                } finally {
                    loading.value = false;
                }
            };

            const openLeftPanel = async (mode, rowIndex = null, context = 'estimate') => {
                leftPanelContext.value = context;
                if (leftPanelMode.value !== mode) leftPanelMode.value = mode;
                if (rowIndex !== null && activeLeftPanelRow.value !== rowIndex) {
                    activeLeftPanelRow.value = rowIndex;
                }
                // 単価マスタ時: 未読込なら遅延取得
                if (mode === 'price' && unifiedProducts.value.length === 0) {
                    loadingMessage.value = '単価マスタ読込中';
                    loading.value = true;
                    try {
                        const productsJson = await gas('apiGetUnifiedProducts');
                        unifiedProducts.value = JSON.parse(productsJson);
                    } catch(e) { console.error(e); }
                    finally { loading.value = false; }
                }
                // セット検索時は初期データをロード
                if (mode === 'set' && setMasters.value.length === 0) {
                    searchSets();
                }
                // 材料費単価マスタ時: 未読込なら遅延取得
                if (mode === 'material' && materialPrices.value.length === 0) {
                    loadingMessage.value = '材料費単価マスタ読込中';
                    loading.value = true;
                    try {
                        const res = await gas('apiGetMaterialPrices');
                        materialPrices.value = JSON.parse(res);
                    } catch(e) { console.error(e); }
                    finally { loading.value = false; }
                }
            };

            const closeLeftPanel = () => {
                leftPanelMode.value = null;
                activeLeftPanelRow.value = null;
            };

            const applyMasterItem = (master) => {
                if (activeLeftPanelRow.value === null) return;
                if (leftPanelContext.value === 'dedicated_order') {
                    const row = dedicatedOrderForm.items[activeLeftPanelRow.value];
                    if (!row) return;
                    row.product = master.product;
                    row.spec = master.spec;
                    row.estUnit = master.unit;
                    row.estPrice = master.price;
                    calcDedicatedLine(row);
                    notify("反映しました");
                    dedicatedOrderForm.items.splice(activeLeftPanelRow.value + 1, 0, {product:'',spec:'',vendor:'',estQty:'',estUnit:'',estPrice:'',estAmount:0,exeQty:'',exeUnit:'',exePrice:'',exeAmount:0,selected:false});
                    activeLeftPanelRow.value = activeLeftPanelRow.value + 1;
                } else {
                    const row = form.items[activeLeftPanelRow.value];
                    if (!row) return;
                    row.category = master.category !== '-' ? master.category : row.category;
                    row.product = master.product;
                    row.spec = master.spec;
                    row.unit = master.unit;
                    row.price = master.price;
                    calcLine(row);
                    notify("反映しました");
                    form.items.splice(activeLeftPanelRow.value + 1, 0, { _uid: genUid(), category: "", product: "", spec: "", qty: "", unit: "", price: "", cost: "", amount: 0, orderedQty: "", orderedAmount: 0, selected: false });
                    activeLeftPanelRow.value = activeLeftPanelRow.value + 1;
                }
            };

            const searchSets = async () => {
                try {
                    const res = await gas('apiSearchSets', ''); // 全件取得
                    setMasters.value = JSON.parse(res);
                } catch(e) { console.error(e); }
            };

            const applySetItem = async (setName) => {
                loading.value = true;
                try {
                    const res = await gas('apiGetSetDetails', setName);
                    const items = JSON.parse(res);
                    if (items && items.length > 0) {
                        const isFixedAmountItem = (item) => {
                            const p = String(item.product || '').trim();
                            const c = String(item.category || '').trim();
                            const masterAmt = Number(item.amount) || 0;
                            return masterAmt < 0 || p.includes('重機回送費') || p.includes('諸経費') || p.includes('値引') ||
                                   c.includes('重機回送費') || c.includes('諸経費') || c.includes('値引');
                        };
                        if (leftPanelContext.value === 'dedicated_order') {
                            items.forEach(item => {
                                const newRow = {product: item.product, spec: item.spec, vendor: '', estQty: item.qty, estUnit: item.unit, estPrice: item.price, estAmount: 0, exeQty: item.qty, exeUnit: item.unit, exePrice: item.price, exeAmount: 0, selected: false};
                                newRow.estAmount = Math.round((Number(newRow.estQty)||0) * (Number(newRow.estPrice)||0));
                                newRow.exeAmount = Math.round((Number(newRow.exeQty)||0) * (Number(newRow.exePrice)||0));
                                dedicatedOrderForm.items.push(newRow);
                            });
                        } else {
                            items.forEach(item => {
                                form.items.push({
                                    _uid: genUid(),
                                    category: item.category,
                                    product: item.product,
                                    spec: item.spec,
                                    qty: item.qty,
                                    unit: item.unit,
                                    price: item.price,
                                    cost: "",
                                    amount: Number(item.amount) || Math.round((Number(item.qty)||0) * (Number(item.price)||0)),
                                    orderedQty: "", orderedAmount: 0,
                                    selected: false
                                });
                            });
                        }
                        notify(`${items.length}件の明細を追加しました`);
                    }
                } catch(e) {
                    notify("セット読込エラー: " + e.message, "error");
                } finally {
                    loading.value = false;
                }
            };

            // Watch for changes（行追加/削除のみ監視。セル編集は tbody @input.capture で検知）
            watch(() => form.items.length, () => { isDirty.value = true; });
            watch(() => JSON.stringify(form.header), () => { isDirty.value = true; });

            // Phase 4: 専用発注画面の変更検知（行追加/削除のみ）
            watch(() => dedicatedOrderForm.items.length, () => { isDirty.value = true; });

            // 関連見積ID: 顧客名変更時にrelEstIdクリア
            watch(() => dedicatedOrderForm.header.client, (newClient, oldClient) => {
                if (oldClient && newClient !== oldClient && dedicatedOrderForm.header.relEstId) {
                    const estId = dedicatedOrderForm.header.relEstId;
                    const est = (projects.value || []).find(p => p.id === estId);
                    if (est && est.client !== newClient) {
                        dedicatedOrderForm.header.relEstId = '';
                        estSuggestions.value = [];
                        showEstSuggestions.value = false;
                    }
                }
            });

            // 関連見積ID: 手動入力時に自動補完（debounce付き）
            let relEstIdTimer = null;
            watch(() => dedicatedOrderForm.header.relEstId, (newId) => {
                if (relEstIdTimer) clearTimeout(relEstIdTimer);
                if (!newId || !newId.trim()) return;
                relEstIdTimer = setTimeout(() => {
                    const match = (projects.value || []).find(p => p.id === newId.trim());
                    if (match) applyEstimateToOrderHeader(newId.trim());
                }, 600);
            });

            // 改善3-1+: 発注パネルの変更をlocalStorageに自動退避
            watch(() => orderInPanel.items, (items) => {
                try {
                    if (items.length > 0) {
                        localStorage.setItem('orderPanelDraft', JSON.stringify({
                            estimateId: form.header.id,
                            items: items,
                            savedAt: Date.now()
                        }));
                    } else {
                        localStorage.removeItem('orderPanelDraft');
                    }
                } catch(e) { /* ignore */ }
            }, { deep: true });
            
            window.addEventListener('beforeunload', (e) => {
                const isEmpty = () => {
                    if (currentTab.value === 'dedicated_order') {
                        return dedicatedOrderForm.items.length === 0 ||
                            (dedicatedOrderForm.items.length === 1 && !String(dedicatedOrderForm.items[0].product || '').trim());
                    }
                    if (currentTab.value === 'edit') {
                        if (sidePanelMode.value === 'order' && orderInPanel.items.length > 0) return false;
                        const hasClient = String(form.header.client || '').trim();
                        const hasProject = String(form.header.project || '').trim();
                        const hasItems = form.items.some(i => String(i.product || '').trim() || String(i.category || '').trim());
                        return !form.header.id && !hasClient && !hasProject && !hasItems;
                    }
                    return true;
                };
                if (isDirty.value && !isEmpty()) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            const adminProjects = computed(() => {
                if (!Array.isArray(projects.value)) return [];
                return projects.value.filter(p => p.visibility === 'admin');
            });
            const adminOrders = computed(() => {
                if (!Array.isArray(orders.value)) return [];
                return orders.value.filter(o => o.visibility === 'admin' || o.status === '管理者確認中');
            });
            
            onMounted(async () => {
              // チャットボット初期位置 & リサイズ
              initChatPosition();
              window.addEventListener('resize', () => {
                  const elW = showChatBot.value ? 500 : 56;
                  const elH = showChatBot.value ? (650 + 56 + 16) : 56;
                  chatPosX.value = Math.max(0, Math.min(chatPosX.value, window.innerWidth - elW));
                  chatPosY.value = Math.max(0, Math.min(chatPosY.value, window.innerHeight - elH));
              });

              try {
                  const fallback = document.getElementById('loading-fallback');
                  if(fallback) fallback.style.display = 'none'; 
                  
                  // Phase 1: 起動時に auth + masters + 材料費単価を一括取得
                  const [authRes, mastersJson, materialJson] = await Promise.all([
                      gas('apiGetAuthStatus'),
                      gas('apiGetMasters'),
                      gas('apiGetMaterialPrices')
                  ]);
                  if (authRes) {
                    const authData = JSON.parse(authRes);
                    if (authData) {
                        auth.isAdmin = !!authData.isAdmin;
                        userEmail.value = authData.email || "";
                    }
                  }
                  const m = JSON.parse(mastersJson);
                  masters.clients = m.clients; masters.sets = m.sets; masters.vendors = m.vendors;
                  try { materialPrices.value = JSON.parse(materialJson); } catch(e) { /* ignore */ }
                  
                  currentTab.value = 'menu';
                  // リマインド取得（非同期、画面表示をブロックしない）
                  fetchReminders();
                  // 履歴用データをバックグラウンドでプリフェッチ
                  fetchProjects(true).catch(() => {});
                  fetchOrders().catch(() => {});
              } catch(e) {
                  window.showCriticalError("Initialization Error:\n" + e.message); 
              } 
              finally { loading.value = false; } 
            });
            
            // ... (既存メソッド省略なし) ...
            const closeSidePanel = async () => {
              // 改善3-1: パネル閉じ時の確認ダイアログ
              if (sidePanelMode.value === 'order' && orderInPanel.items.length > 0) {
                const ok = await confirmAction(
                  '発注パネルに未保存のデータがあります。\n閉じると入力中のデータが失われます。\nよろしいですか？'
                );
                if (!ok) return;
              }
              if (sidePanelMode.value === 'order') {
                orderInPanel.items = [];
                // 改善3-1+: localStorage一時保存をクリア
                try { localStorage.removeItem('orderPanelDraft'); } catch(e) {}
              }
              sidePanelMode.value = null;
            };
            const toggleSidePanel = async (mode) => {
              if (sidePanelMode.value === mode) {
                await closeSidePanel();
              } else {
                sidePanelMode.value = mode;
                // 改善3-1+: 発注パネルを開いたときにlocalStorageから復元確認
                if (mode === 'order') {
                  try {
                    const draft = localStorage.getItem('orderPanelDraft');
                    if (draft && orderInPanel.items.length === 0) {
                      const parsed = JSON.parse(draft);
                      if (parsed.estimateId === form.header.id && parsed.items && parsed.items.length > 0) {
                        const restore = await confirmAction(
                          `前回の未保存データ (${parsed.items.length}件) があります。復元しますか？`
                        );
                        if (restore) {
                          orderInPanel.items = parsed.items;
                          notify(`${parsed.items.length}件のデータを復元しました`);
                        } else {
                          localStorage.removeItem('orderPanelDraft');
                        }
                      }
                    }
                  } catch(e) { /* ignore parse error */ }

                  // チェックボックス選択済みの行を自動追加
                  const selected = form.items.filter(i => i.selected && i.product);
                  if (selected.length > 0 && orderInPanel.items.length === 0) {
                    const firstVendor = selected[0].vendor || "";
                    selected.forEach(item => {
                      const exists = orderInPanel.items.some(i => i.sourceUid === item._uid);
                      if (!exists) {
                        orderInPanel.items.push({
                          sourceUid: item._uid,
                          product: item.product,
                          spec: item.spec || "",
                          qty: item.qty,
                          unit: item.unit,
                          estimateCost: item.cost || 0,
                          cost: item.cost || 0,
                          price: item.price || 0,
                          vendor: firstVendor || item.vendor || ""
                        });
                      }
                    });
                    if (orderInPanel.items.length > 0) {
                      notify(`${orderInPanel.items.length}件の選択行を追加しました`);
                    }
                    // 選択状態をクリア
                    form.items.forEach(i => { i.selected = false; });
                  }
                }
              }
            };
            
            const loadEstimateHistory = async () => {
                isDraftLoading.value = true;
                try {
                    const res = await gas('apiGetDrafts');
                    historyList.value = JSON.parse(res);
                } catch(e) { notify("履歴読込失敗: " + e.message, "error"); }
                finally { isDraftLoading.value = false; }
            };

            // --- フローティングプレビューパネル操作 ---
            const _initFloatingPanelPos = () => {
                if (floatingPanelPosX.value === 200 && floatingPanelPosY.value === 100) {
                    floatingPanelPosX.value = Math.max(50, (window.innerWidth - 850) / 2);
                    floatingPanelPosY.value = Math.max(50, (window.innerHeight - 600) / 2);
                }
            };
            // リストモードで開く（見積一覧 or 発注一覧）
            const openFloatingPanelList = async (sourceType, targetContext) => {
                floatingPanel.show = true;
                floatingPanel.mode = 'list';
                floatingPanel.sourceType = sourceType;
                floatingPanel.targetContext = targetContext;
                floatingPanel.listFilter = '';
                floatingPanel.items = [];
                floatingPanel.header = null;
                floatingPanel.selectAll = false;
                _initFloatingPanelPos();
                // 既にデータがあれば即表示、なければローディング表示して取得
                const cached = sourceType === 'estimate' ? projects.value : orders.value;
                if (cached.length > 0) {
                    floatingPanel.listItems = cached;
                    floatingPanel.loading = false;
                } else {
                    floatingPanel.listItems = [];
                    floatingPanel.loading = true;
                }
                try {
                    if (sourceType === 'estimate') {
                        await fetchProjects(true);
                        floatingPanel.listItems = projects.value;
                    } else {
                        await fetchOrders();
                        floatingPanel.listItems = orders.value;
                    }
                } catch (e) {
                    notify("履歴の読込に失敗しました: " + e.message, "error");
                } finally {
                    floatingPanel.loading = false;
                }
            };
            // リストから1件選択→詳細モードへ
            const selectFloatingPanelItem = async (id) => {
                if (floatingPanel.targetContext === 'estimate' && id === form.header.id) {
                    notify("現在編集中の見積です", "error");
                    return;
                }
                floatingPanel.loading = true;
                floatingPanel.items = [];
                floatingPanel.header = null;
                floatingPanel.selectAll = false;
                try {
                    const apiFunc = floatingPanel.sourceType === 'estimate' ? 'apiGetEstimateDetails' : 'apiGetOrderDetails';
                    const res = await gas(apiFunc, id);
                    const data = JSON.parse(res);
                    if (data && !data.error) {
                        floatingPanel.header = data.header;
                        floatingPanel.items = (data.items || []).map(it => ({ ...it, _checked: false }));
                        floatingPanel.mode = 'detail';
                    } else {
                        notify(data?.error || "データが見つかりません", "error");
                    }
                } catch (e) {
                    notify("読込エラー: " + e.message, "error");
                } finally {
                    floatingPanel.loading = false;
                }
            };
            // 詳細→リストに戻る
            const floatingPanelBack = () => {
                floatingPanel.mode = 'list';
                floatingPanel.items = [];
                floatingPanel.header = null;
                floatingPanel.selectAll = false;
            };
            // 直接詳細モードで開く（見積履歴サイドパネルから）
            const openFloatingEstimatePanel = async (id) => {
                if (id === form.header.id) {
                    notify("現在編集中の見積です", "error");
                    return;
                }
                floatingPanel.show = true;
                floatingPanel.loading = true;
                floatingPanel.mode = 'detail';
                floatingPanel.sourceType = 'estimate';
                floatingPanel.targetContext = 'estimate';
                floatingPanel.items = [];
                floatingPanel.header = null;
                floatingPanel.selectAll = false;
                _initFloatingPanelPos();
                try {
                    const res = await gas('apiGetEstimateDetails', id);
                    const data = JSON.parse(res);
                    if (data) {
                        floatingPanel.header = data.header;
                        floatingPanel.items = (data.items || []).map(it => ({ ...it, _checked: false }));
                    } else {
                        notify("データが見つかりません", "error");
                        floatingPanel.show = false;
                    }
                } catch (e) {
                    notify("読込エラー: " + e.message, "error");
                    floatingPanel.show = false;
                } finally {
                    floatingPanel.loading = false;
                }
            };
            const closeFloatingPanel = () => {
                floatingPanel.show = false;
                floatingPanel.mode = 'detail';
                floatingPanel.items = [];
                floatingPanel.listItems = [];
                floatingPanel.header = null;
                floatingPanel.selectAll = false;
                floatingPanel.listFilter = '';
            };
            const toggleFloatingPanelSelectAll = () => {
                const val = floatingPanel.selectAll;
                floatingPanel.items.forEach(it => { it._checked = val; });
            };
            const applyFloatingPanelHeader = () => {
                const h = floatingPanel.header;
                if (!h) return;
                if (floatingPanel.targetContext === 'estimate') {
                    form.header.date = h.date || form.header.date;
                    form.header.client = h.client || form.header.client;
                    form.header.status = h.status || form.header.status;
                    form.header.project = h.project || form.header.project;
                    form.header.location = h.location || form.header.location;
                    form.header.period = h.period || form.header.period;
                    form.header.payment = h.payment || form.header.payment;
                    form.header.expiry = h.expiry || form.header.expiry;
                    form.header.taxMode = h.taxMode || form.header.taxMode;
                } else {
                    dedicatedOrderForm.header.date = toDateInputValue(h.date) || dedicatedOrderForm.header.date;
                    dedicatedOrderForm.header.client = h.vendor || h.client || dedicatedOrderForm.header.client;
                    dedicatedOrderForm.header.project = h.project || dedicatedOrderForm.header.project;
                    dedicatedOrderForm.header.location = h.location || dedicatedOrderForm.header.location;
                    dedicatedOrderForm.header.period = h.period || dedicatedOrderForm.header.period;
                    dedicatedOrderForm.header.payment = h.payment || dedicatedOrderForm.header.payment;
                    dedicatedOrderForm.header.expiry = h.expiry || dedicatedOrderForm.header.expiry;
                    dedicatedOrderForm.header.taxMode = h.taxMode || dedicatedOrderForm.header.taxMode;
                    dedicatedOrderForm.header.relEstId = h.relEstId || dedicatedOrderForm.header.relEstId;
                }
                isDirty.value = true;
                notify("ヘッダー情報を反映しました");
            };
            const addFloatingPanelItems = () => {
                const selected = floatingPanel.items.filter(it => it._checked);
                if (selected.length === 0) { notify("項目が選択されていません", "error"); return; }
                const h = floatingPanel.header;
                if (floatingPanel.targetContext === 'estimate') {
                    // 先頭の空行を削除
                    while (form.items.length > 0 && !String(form.items[0].product || '').trim() && !String(form.items[0].category || '').trim()) {
                        form.items.splice(0, 1);
                    }
                    // ヘッダー情報を自動反映（日付以外）
                    if (h) {
                        form.header.client = h.client || form.header.client;
                        form.header.status = h.status || form.header.status;
                        form.header.project = h.project || form.header.project;
                        form.header.location = h.location || form.header.location;
                        form.header.period = h.period || form.header.period;
                        form.header.payment = h.payment || form.header.payment;
                        form.header.expiry = h.expiry || form.header.expiry;
                        form.header.taxMode = h.taxMode || form.header.taxMode;
                    }
                    // 見積フォームに追加
                    selected.forEach(it => {
                        form.items.push({
                            _uid: genUid(),
                            category: it.category || "",
                            product: it.product || "",
                            spec: it.spec || "",
                            qty: Number(it.qty) || 0,
                            unit: it.unit || "",
                            price: Number(it.price) || 0,
                            cost: Number(it.cost) || 0,
                            amount: Math.round((Number(it.qty) || 0) * (Number(it.price) || 0)),
                            remarks: it.remarks || "",
                            vendor: it.vendor || "",
                            orderedQty: "",
                            orderedAmount: 0,
                            selected: false
                        });
                    });
                    isDirty.value = true;
                } else {
                    // 先頭の空行を削除
                    while (dedicatedOrderForm.items.length > 0 && !String(dedicatedOrderForm.items[0].product || '').trim()) {
                        dedicatedOrderForm.items.splice(0, 1);
                    }
                    // ヘッダー情報を自動反映（日付以外）
                    if (h) {
                        dedicatedOrderForm.header.client = h.vendor || h.client || dedicatedOrderForm.header.client;
                        dedicatedOrderForm.header.project = h.project || dedicatedOrderForm.header.project;
                        dedicatedOrderForm.header.location = h.location || dedicatedOrderForm.header.location;
                        dedicatedOrderForm.header.period = h.period || dedicatedOrderForm.header.period;
                        dedicatedOrderForm.header.payment = h.payment || dedicatedOrderForm.header.payment;
                        dedicatedOrderForm.header.expiry = h.expiry || dedicatedOrderForm.header.expiry;
                        dedicatedOrderForm.header.taxMode = h.taxMode || dedicatedOrderForm.header.taxMode;
                        dedicatedOrderForm.header.relEstId = h.relEstId || dedicatedOrderForm.header.relEstId;
                    }
                    // 発注フォームに追加
                    selected.forEach(it => {
                        const qty = Number(it.qty) || 0;
                        const price = Number(it.price) || 0;
                        const cost = Number(it.cost) || 0;
                        const itemVendor = it.vendor || (h && h.vendor) || "";
                        dedicatedOrderForm.items.push({
                            product: it.product || "",
                            spec: it.spec || "",
                            vendor: itemVendor,
                            estQty: qty,
                            estUnit: it.unit || "",
                            estPrice: price,
                            estAmount: Math.round(qty * price),
                            exeQty: qty,
                            exeUnit: it.unit || "",
                            exePrice: cost || price,
                            exeAmount: Math.round(qty * (cost || price)),
                            selected: false
                        });
                    });
                }
                notify(`${selected.length}件の明細を追加しました`);
                floatingPanel.items.forEach(it => { it._checked = false; });
                floatingPanel.selectAll = false;
            };

            // Phase 3: 見積行クリック時の連携処理改修 + Phase 1: 粗利計算用priceの追加
            const handleEstimateRowClick = (item, idx) => {
                if (sidePanelMode.value === 'order') {
                    if (!item.product) return;
                    
                    // 重複チェック
                    // 改善3-3: UIDベースの紐付け
                    const exists = orderInPanel.items.some(i => i.sourceUid === item._uid);
                    if (exists) {
                        notify("既に追加されています", "error");
                        return;
                    }

                    const firstVendor = orderInPanel.items.length > 0 ? orderInPanel.items[0].vendor : null;
                    orderInPanel.items.push({
                        sourceUid: item._uid, // 改善3-3: UIDで参照
                        product: item.product,
                        spec: item.spec || "",
                        qty: item.qty,
                        unit: item.unit,
                        estimateCost: item.cost || 0, // 改善2B: 見積原価（参照用）
                        cost: item.cost || 0,
                        price: item.price || 0,
                        vendor: firstVendor || item.vendor || "" 
                    });
                    
                    notify("発注パネルに追加しました");
                }
            };
            
            // Phase 1: 発注パネル用粗利計算
            const calcPanelMargin = (item) => {
                const p = Number(item.price) || 0;
                const c = Number(item.cost) || 0;
                if (!p) return 0;
                return ((p - c) / p * 100).toFixed(1);
            };

            // 選択中明細の件数
            const selectedItemsCount = computed(() => form.items.filter(i => i.selected).length );
            
            // 改善5: モード廃止 — toggleSelectionMode は後方互換用に残す（no-op）
            const toggleSelectionMode = () => {};
            
            const selectAllRows = () => {
                form.items.forEach(i => { if (i.product) i.selected = true; });
            };
            
            const clearAllSelection = () => {
                form.items.forEach(i => { i.selected = false; });
                lastSelectedIndex.value = null;
            };

            // 発注書画面の行選択
            const dedicatedSelectedCount = computed(() => dedicatedOrderForm.items.filter(i => i.selected).length);
            const batchDedicatedVendor = ref('');
            const selectAllDedicatedRows = () => {
                dedicatedOrderForm.items.forEach(i => { if (i.product) i.selected = true; });
            };
            const clearAllDedicatedSelection = () => {
                dedicatedOrderForm.items.forEach(i => { i.selected = false; });
            };
            const applyBatchDedicatedVendor = () => {
                const vendor = (batchDedicatedVendor.value || "").trim();
                if (!vendor) return notify("発注先を選択してください", "error");
                const selected = dedicatedOrderForm.items.filter(i => i.selected);
                if (selected.length === 0) return notify("変更する明細を選択してください", "error");
                selected.forEach(item => { item.vendor = vendor; });
                dedicatedOrderForm.items.forEach(i => { i.selected = false; });
                notify(`${selected.length}件の発注先を「${vendor}」に変更しました`);
                batchDedicatedVendor.value = '';
            };

            // 改善5: 行選択（チェックボックス列クリック: トグル or Shift範囲選択）
            const handleRowSelection = (idx, event) => {
                if (event.shiftKey && lastSelectedIndex.value !== null) {
                    // Shift+クリック: 範囲選択
                    const start = Math.min(lastSelectedIndex.value, idx);
                    const end = Math.max(lastSelectedIndex.value, idx);
                    for (let i = start; i <= end; i++) {
                        form.items[i].selected = true;
                    }
                }
                // 通常クリックは v-model が即座に処理（何もしない）
                lastSelectedIndex.value = idx;
            };
            
            // 改善6: スマート一括選択
            const selectByVendorPrompt = () => {
                const vendors = [...new Set(form.items.filter(i => i.vendor && i.vendor.trim()).map(i => i.vendor.trim()))];
                if (vendors.length === 0) return notify("発注先が入力された行がありません", "error");
                // 簡易: 1件ならそのまま選択、複数ならモーダル表示
                if (vendors.length === 1) {
                    let cnt = 0;
                    form.items.forEach(i => { if (i.vendor && i.vendor.trim() === vendors[0]) { i.selected = true; cnt++; } });
                    notify(`「${vendors[0]}」の ${cnt} 件を選択しました`);
                } else {
                    batchSelectOptions.value = vendors;
                    batchSelectType.value = 'vendor';
                    showBatchSelectModal.value = true;
                }
            };

            const selectByCategoryPrompt = () => {
                const cats = [...new Set(form.items.filter(i => i.category && i.category.trim()).map(i => i.category.trim()))];
                if (cats.length === 0) return notify("工種が入力された行がありません", "error");
                if (cats.length === 1) {
                    let cnt = 0;
                    form.items.forEach(i => { if (i.category && i.category.trim() === cats[0]) { i.selected = true; cnt++; } });
                    notify(`「${cats[0]}」の ${cnt} 件を選択しました`);
                } else {
                    batchSelectOptions.value = cats;
                    batchSelectType.value = 'category';
                    showBatchSelectModal.value = true;
                }
            };

            const selectByProductPrompt = () => {
                const products = [...new Set(form.items.filter(i => i.product && i.product.trim()).map(i => i.product.trim()))];
                if (products.length === 0) return notify("品名が入力された行がありません", "error");
                if (products.length === 1) {
                    let cnt = 0;
                    form.items.forEach(i => { if (i.product && i.product.trim() === products[0]) { i.selected = true; cnt++; } });
                    notify(`「${products[0]}」の ${cnt} 件を選択しました`);
                } else {
                    batchSelectOptions.value = products;
                    batchSelectType.value = 'product';
                    showBatchSelectModal.value = true;
                }
            };

            const selectBatchOption = (option) => {
                let cnt = 0;
                if (batchSelectType.value === 'vendor') {
                    form.items.forEach(i => { if (i.vendor && i.vendor.trim() === option) { i.selected = true; cnt++; } });
                } else if (batchSelectType.value === 'category') {
                    form.items.forEach(i => { if (i.category && i.category.trim() === option) { i.selected = true; cnt++; } });
                } else if (batchSelectType.value === 'product') {
                    form.items.forEach(i => { if (i.product && i.product.trim() === option) { i.selected = true; cnt++; } });
                }
                showBatchSelectModal.value = false;
                notify(`「${option}」の ${cnt} 件を選択しました`);
            };

            const selectUnorderedRows = () => {
                let cnt = 0;
                form.items.forEach(i => {
                    if (i.product && (!i.vendor || !(i.vendor||"").trim() || !Number(i.cost))) {
                        i.selected = true; cnt++;
                    }
                });
                if (cnt > 0) notify(`未発注の ${cnt} 件を選択しました`);
                else notify("未発注行はありません");
            };

            // 発注先一括変更
            const batchUpdateVendor = () => {
                const vendor = (batchVendorSelect.value || "").trim();
                if (!vendor) return notify("発注先を選択してください", "error");
                const selected = form.items.filter(i => i.selected);
                if (selected.length === 0) return notify("変更する明細を選択してください", "error");
                selected.forEach(item => {
                    item.vendor = vendor;
                    calcLine(item);
                });
                form.items.forEach(i => { i.selected = false; });
                if (typeof lastSelectedIndex !== 'undefined') lastSelectedIndex.value = null;
                notify(`${selected.length}件の発注先を更新しました`);
            };
            
            // Phase 3: 見積行削除時の同期
            const addItem = () => form.items.push({ _uid: genUid(), category: "", product: "", spec: "", qty: "", unit: "", price: "", cost: "", amount: 0, orderedQty: "", orderedAmount: 0, selected: false });

            // 修正箇所: ここで removeItem を定義し、重複を解消
            // 改善3-3: UIDベースの紐付け — インデックスずれのリスクを排除
            const removeItem = (i) => {
                formSnapshot.value = { source: 'edit', header: JSON.parse(JSON.stringify(form.header)), items: JSON.parse(JSON.stringify(form.items)) };
                const removedUid = form.items[i]._uid;
                form.items.splice(i, 1);
                if (orderInPanel.items.length > 0 && removedUid) {
                    const oIdx = orderInPanel.items.findIndex(item => item.sourceUid === removedUid);
                    if (oIdx !== -1) {
                        orderInPanel.items.splice(oIdx, 1);
                    }
                }
            };

            // Phase 3: 発注パネルからアイテム削除
            const removeOrderItem = (i) => {
                orderInPanel.items.splice(i, 1);
            };

            const removeDedicatedItem = (i) => {
                formSnapshot.value = { source: 'dedicated_order', header: JSON.parse(JSON.stringify(dedicatedOrderForm.header)), items: JSON.parse(JSON.stringify(dedicatedOrderForm.items)) };
                dedicatedOrderForm.items.splice(i, 1);
            };

            // 発注パネルの発注先一括変更
            const applyBatchVendorToPanel = () => {
                const vendor = (tempBatchVendor.value || "").trim();
                if (!vendor) return notify("発注先を選択してください", "error");
                orderInPanel.items.forEach(item => { item.vendor = vendor; });
                orderInPanel.vendor = vendor;
                notify(`${orderInPanel.items.length}件の発注先を「${vendor}」に変更しました`);
                tempBatchVendor.value = '';
            };

            // 発注パネルの内容を見積明細に反映する（発注は作成しない）
            const saveOrderPanelToEstimate = () => {
                if (orderInPanel.items.length === 0) return notify("明細がありません", "error");
                const vendor = orderInPanel.vendor || "";
                orderInPanel.items.forEach(oItem => {
                    const row = form.items.find(fi => fi._uid === oItem.sourceUid);
                    if (row) {
                        row.vendor = oItem.vendor || vendor || "";
                        row.cost = oItem.cost;
                        row.qty = oItem.qty;
                        calcLine(row);
                    }
                });
                notify("見積明細に反映しました");
            };

            const openOrderForEdit = async (orderId) => {
                loadingMessage.value = '読込中';
                loading.value = true;
                try {
                    const res = await gas('apiGetOrderDetails', orderId);
                    const data = JSON.parse(res);
                    if (data.error) { notify(data.error, "error"); return; }
                    
                    // 単独発注書作成画面（dedicated_order）にデータをロード
                    dedicatedOrderForm.header = {
                        id: data.header.id || "",
                        vendor: data.header.vendor || "",
                        date: toDateInputValue(data.header.date) || getTodayISO(),
                        relEstId: data.header.relEstId || "",
                        project: data.header.project || "",
                        location: data.header.location || "",
                        period: data.header.period || "",
                        payment: data.header.payment || "",
                        expiry: data.header.expiry || "",
                        status: "発注書作成",
                        visibility: "public"
                    };
                    dedicatedOrderForm.items = (data.items || []).map(it => ({
                        category: it.category || "発注",
                        product: it.product || "",
                        spec: it.spec || "",
                        vendor: it.vendor || "",
                        estQty: it.estQty || it.qty || 0,
                        estUnit: it.estUnit || it.unit || "",
                        estPrice: it.estPrice || it.price || 0,
                        estAmount: it.estAmount || Math.round((it.qty||0) * (it.price||0)),
                        exeQty: it.exeQty || 0,
                        exeUnit: it.exeUnit || "",
                        exePrice: it.exePrice || it.cost || 0,
                        exeAmount: it.exeAmount || Math.round((it.exeQty||0) * (it.cost||0)),
                        selected: false
                    }));
                    if (dedicatedOrderForm.items.length === 0) {
                        dedicatedOrderForm.items = [{ product: "", spec: "", estQty: "", estUnit: "", estPrice: "", estAmount: 0, exeQty: "", exeUnit: "", exePrice: "", exeAmount: 0, selected: false }];
                    }
                    
                    // 画面遷移
                    currentTab.value = 'dedicated_order';
                    notify("発注データを読み込みました");

                } catch(e) { notify("読込失敗: " + e.message, "error"); }
                finally { loading.value = false; }
            };

            const goHome = async () => {
                isDirty.value = false;
                isReviewMode.value = false;
                sidePanelMode.value = null;
                leftPanelMode.value = null;
                currentTab.value = 'menu';
            };
            const handleBack = () => { if(isReviewMode.value) { currentTab.value = 'admin'; } else { currentTab.value = 'list'; } };
            const handleNavigation = (tab) => { checkUnsavedChanges(() => { if (tab === 'dedicated_order') { createNewDedicatedOrder(); fetchProjects(true, true); } currentTab.value = tab; }); };
            const formatCurrency = (val) => Number(val || 0).toLocaleString();
            
            const fetchProjects = async (skipLoading = false, force = false) => {
                if (!force && projects.value.length > 0) return;
                if(!skipLoading) loading.value = true;
                try {
                    const d = await gas('apiGetProjects');
                    projects.value = JSON.parse(d);
                } finally {
                    if(!skipLoading) loading.value = false;
                }
            };
            const fetchOrders = async (force = false) => { 
                // 既にデータがあり、強制取得でない場合はスキップ
                if (!force && orders.value.length > 0) {
                    return;
                }
                try { 
                    const d = await gas('apiGetOrders'); 
                    orders.value = JSON.parse(d); 
                } catch(e) { console.error(e); orders.value = []; }
            };
            
            // 発注書履歴タブ表示用の最適化された関数
            const showOrderHistoryTab = async () => {
                orderPanelTab.value = 'list';
                // 既にデータがある場合は即座に表示（再取得しない）
                if (orders.value.length > 0) {
                    return;
                }
                // データがない場合のみ取得
                isOrderPanelLoading.value = true;
                try {
                    await fetchOrders(true);
                } catch(e) {
                    notify("発注書履歴の読込に失敗しました", "error");
                } finally {
                    isOrderPanelLoading.value = false;
                }
            };
            
            // 発注書履歴を手動で更新
            const refreshOrderHistory = async () => {
                isOrderPanelLoading.value = true;
                try {
                    await fetchOrders(true);
                    notify("更新しました", "success");
                } catch(e) {
                    notify("更新に失敗しました", "error");
                } finally {
                    isOrderPanelLoading.value = false;
                }
            };
            
            const fetchInvoices = async () => {
                try {
                    const d = await gas('apiGetInvoices');
                    adminInvoices.value = JSON.parse(d);
                } catch(e) {
                    console.error(e); adminInvoices.value = []; 
                }
            }
            
            const goToProjectList = async () => { 
                checkUnsavedChanges(async () => {
                    loadingMessage.value = '読込中';
                    loading.value = true;
                    try {
                        await Promise.all([fetchProjects(true, true), fetchOrders(true), fetchInvoices()]);
                        currentTab.value = 'list'; 
                    } finally { loading.value = false; }
                });
            };
            const goToInvoice = async () => {
                checkUnsavedChanges(async () => {
                    loadingMessage.value = '読込中';
                    loading.value = true; 
                    try { 
                        const [pList] = await Promise.all([
                            gas('apiGetActiveProjectsList'),
                            loadInvoiceFiles(),
                            fetchInvoices()
                        ]);
                        activeProjects.value = JSON.parse(pList);
                        resetInvoiceForm();
                        currentTab.value = 'invoice';
                    } finally { loading.value = false; }
                });
            };
            // 管理者サブタブごとのローディング状態
            const adminTabLoading = ref(false);
            const loadAdminSubTab = async (tab) => {
                adminTabLoading.value = true;
                try {
                    if (tab === 'approval') {
                        await Promise.all([fetchProjects(true, true), fetchOrders(true), fetchInvoices()]);
                    } else if (tab === 'deposits') {
                        await fetchDeposits();
                        return; // fetchDepositsは自前でloading制御するのでここで終了
                    } else if (tab === 'payments') {
                        await fetchPayments();
                        return;
                    }
                } catch (e) { console.error('loadAdminSubTab error:', e); }
                finally { adminTabLoading.value = false; }
            };
            const goToAdmin = async () => {
                checkUnsavedChanges(async () => {
                    if(auth.isAdmin) {
                        currentTab.value = 'admin';
                        adminSubTab.value = 'approval';
                        // 承認タブのデータだけ即座に取得（他は遅延）
                        loadAdminSubTab('approval');
                        // 会計連携用の年リストはバックグラウンドで取得
                        gas('apiGetJournalYears').then(yList => {
                            journalYears.value = JSON.parse(yList);
                            if(journalYears.value.length > 0) journalYear.value = journalYears.value[0];
                        }).catch(() => {});
                    }
                });
            };

            const filteredProjects = computed(() => {
                let res = projects.value;
                if (filter.year) res = res.filter(p => new Date(p.date).getFullYear() == filter.year);
                if (filter.month) res = res.filter(p => new Date(p.date).getMonth() + 1 == filter.month);
                if (filter.client) res = res.filter(p => p.client === filter.client);
                return [...res].sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
            });
            
            const stats = computed(() => {
                const s = { totalSales: 0, totalCost: 0, totalInvoiced: 0, totalProfit: 0, margin: 0, pendingPayment: 0 };
                filteredProjects.value.forEach(p => {
                    s.totalSales += p.totalAmount;
                    s.totalCost += p.totalOrderAmount;
                    s.totalInvoiced += p.totalInvoicedAmount;
                });
                s.totalProfit = s.totalSales - s.totalCost;
                s.margin = s.totalSales ? ((s.totalProfit / s.totalSales) * 100).toFixed(1) : 0;
                adminInvoices.value.forEach(inv => {
                    if (inv.status === '着工') s.pendingPayment += Number(inv.payment || 0);
                });
                return s;
            });
            const years = computed(() => {
                const ys = new Set(projects.value.map(p => new Date(p.date).getFullYear()));
                return Array.from(ys).sort((a,b)=>b-a);
            });

            const clearEstimateForm = () => {
                const hasData = form.header.id || form.header.client || form.items.some(i => String(i.product || '').trim());
                if (hasData) {
                    formSnapshot.value = { source: 'edit', header: JSON.parse(JSON.stringify(form.header)), items: JSON.parse(JSON.stringify(form.items)) };
                }
                form.header = { id: "", date: "", client: "", project: "", location: "", period: "", payment: "", expiry: "", status: "見積提出", visibility: "public", defaultVendor: "", taxMode: "税別" };
                form.items = [{ category: "", product: "", spec: "", qty: "", unit: "", price: "", cost: "", amount: 0, orderedQty: "", orderedAmount: 0, selected: false }];
                isReviewMode.value = false;
                isDirty.value = false;
                sidePanelMode.value = null;
                orderInPanel.items = [];
                closeLeftPanel();
            };
            // 見積関連（unifiedProducts は編集画面表示時に遅延取得）
            const createNewEstimate = async () => {
                if (unifiedProducts.value.length === 0) {
                    loadingMessage.value = '読込中';
                    loading.value = true;
                    try {
                        const productsJson = await gas('apiGetUnifiedProducts');
                        unifiedProducts.value = JSON.parse(productsJson);
                    } finally {
                        loading.value = false;
                    }
                }
                form.header = { id: "", date: "", client: "", project: "", location: "", period: "", payment: "", expiry: "", status: "見積提出", visibility: "public", defaultVendor: "", taxMode: "税別" };
                form.items = [{ category: "", product: "", spec: "", qty: "", unit: "", price: "", cost: "", amount: 0, orderedQty: "", orderedAmount: 0, selected: false }];
                isReviewMode.value = false;
                isDirty.value = false;
                orderInPanel.items = [];
                currentTab.value = 'edit';
            };
            // メニューから履歴を開きつつ編集画面へ遷移
            const openEstimateHistoryFromMenu = async () => {
                await createNewEstimate();
                openFloatingPanelList('estimate', 'estimate');
            };
            const openOrderHistoryFromMenu = async () => {
                createNewDedicatedOrder();
                fetchProjects(true);
                currentTab.value = 'dedicated_order';
                openFloatingPanelList('order', 'order');
            };

            const loadEstimate = async (id, fromList=false) => {
                loadingMessage.value = '読込中';
                loading.value = true;
                try {
                    const promises = [gas('apiGetEstimateDetails', id)];
                    if (unifiedProducts.value.length === 0) promises.push(gas('apiGetUnifiedProducts'));
                    const [res, productsJson] = await Promise.all(promises);
                    if (productsJson) unifiedProducts.value = JSON.parse(productsJson);
                    const data = JSON.parse(res);
                    if (data) {
                        const firstVendor = data.items && data.items[0] && data.items[0].vendor;
                        form.header = { ...data.header, defaultVendor: data.header.defaultVendor || firstVendor || "" };
                        form.items = (data.items || []).map(it => ({ ...it, _uid: it._uid || genUid(), selected: it.selected ?? false }));
                        isReviewMode.value = (currentTab.value === 'admin'); 
                        showBackButton.value = fromList;
                        isDirty.value = false;
                        currentTab.value = 'edit';
                        sidePanelMode.value = null;
                        orderInPanel.items = []; // 別見積読込時は発注パネルをクリア
                        closeLeftPanel(); // パネルリセット
                    } else {
                        notify("データが見つかりません", "error");
                    }
                } catch(e) { notify("読込エラー: " + e.message, "error"); }
                finally { loading.value = false; }
            };
            const saveEstimate = async (target, skipNotify = false) => {
                loadingMessage.value = '保存中...';
                loading.value = true;
                try {
                    if (target === 'admin') { form.header.status = '管理者確認中'; form.header.visibility = 'admin'; }
                    else { form.header.visibility = 'public'; }
                    
                    const res = await gas('apiSaveUnifiedData', JSON.stringify({ estimate: form }));
                    const r = JSON.parse(res);
                    if (r.success) {
                        form.header.id = r.id;
                        isDirty.value = false;
                        if (!skipNotify) notify("保存しました");
                        // 自動発注生成されるため発注キャッシュを更新
                        fetchOrders(true).catch(() => {});
                    } else {
                        notify("保存失敗: " + r.message, "error");
                    }
                    return r.success;
                } catch(e) { notify("通信エラー: " + e.message, "error"); return false; }
                finally { loading.value = false; }
            };
            
            const openUrl = (url) => {
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            const createPdf = async () => {
                loadingMessage.value = '見積PDF作成中...';
                loading.value = true;
                try {
                    const res = await gas('apiSaveAndCreateEstimatePdf', JSON.stringify(form));
                    const r = JSON.parse(res);
                    if (r.success) {
                        openUrl(r.url);
                        form.header.id = r.id;
                        isDirty.value = false;
                        notify("見積PDFを作成しました");
                    } else {
                        notify(r.message || "PDF作成に失敗しました", "error");
                    }
                } catch(e) { notify("PDF作成エラー: " + (e.message || e), "error"); }
                finally { loading.value = false; }
            };
            
            const createOrderPdf = () => {
                const vendors = new Set();
                form.items.forEach(item => {
                    if(item.vendor) vendors.add(item.vendor);
                });
                const vendorList = Array.from(vendors);

                if (vendorList.length === 0) {
                    notify("発注先が入力されている明細がありません。", "error");
                    return;
                }

                if (vendorList.length === 1) {
                    selectVendorAndPrint(vendorList[0]);
                } else {
                    vendorCandidates.value = vendorList;
                    showVendorSelectModal.value = true;
                }
            };

            const selectVendorAndPrint = async (vendor) => {
                showVendorSelectModal.value = false;
                loadingMessage.value = '発注書作成中...';
                loading.value = true;
                try {
                    await saveEstimate('public'); // 先に保存
                    const r = JSON.parse(await gas('apiCreateOrderPdf', JSON.stringify(form), vendor));
                    if(r.success) {
                         openUrl(r.url);
                         notify("発注書を作成しました");
                    } else {
                         notify(r.message, "error");
                    }
                } catch(e) {
                    notify("エラー: " + e.message, "error");
                } finally {
                    loading.value = false;
                }
            };

            const isFixedAmountRow = (item) => {
                const amt = Number(item.amount) || 0;
                const p = String(item.product || '').trim();
                const c = String(item.category || '').trim();
                return amt < 0 || p.includes('重機回送費') || p.includes('諸経費') || p.includes('値引') ||
                       c.includes('重機回送費') || c.includes('諸経費') || c.includes('値引');
            };
            const calcLine = (item) => {
                if (!isFixedAmountRow(item)) {
                    item.amount = Math.round((Number(item.qty)||0) * (Number(item.price)||0));
                }
                item.orderedAmount = Math.round((Number(item.orderedQty)||0) * (Number(item.cost)||0));
            };
            const totalAmount = computed(() => form.items.reduce((s, i) => s + (Number(i.amount) || 0), 0));
            const totalEstimatedCost = computed(() => form.items.reduce((s, i) => s + (Number(i.orderedAmount) || 0), 0));
            const calculateMargin = (item) => {
                const rev = Number(item.amount) || 0;
                if (!rev) return 0;
                const cost = Number(item.orderedAmount) || 0;
                return ((rev - cost) / rev * 100).toFixed(1);
            };

            const getPricePct = (item) => {
                if (!item._origPrice || !item.price) return null;
                const orig = Number(item._origPrice);
                if (!orig) return null;
                const pct = ((Number(item.price) - orig) / orig * 100);
                return Math.abs(pct) < 0.1 ? null : pct.toFixed(1);
            };
            const getCostPct = (item) => {
                if (!item._origCost || !item.cost) return null;
                const orig = Number(item._origCost);
                if (!orig) return null;
                const pct = ((Number(item.cost) - orig) / orig * 100);
                return Math.abs(pct) < 0.1 ? null : pct.toFixed(1);
            };

            const applyBulkPriceChange = () => {
                const pct = Number(bulkPricePercent.value);
                if (isNaN(pct) || pct === 0) { notify('変更率を入力してください', 'error'); return; }
                const target = bulkPriceTarget.value;
                const hasSelection = selectedItemsCount.value > 0;
                const targets = hasSelection ? form.items.filter(i => i.selected) : form.items;
                if (targets.length === 0) { notify('対象行がありません', 'error'); return; }
                const multiplier = 1 + pct / 100;
                let count = 0;
                targets.forEach(item => {
                    if (isFixedAmountRow(item)) return;
                    if (target === 'price' || target === 'both') {
                        if (!item._origPrice) item._origPrice = Number(item.price) || 0;
                        item.price = Math.round((Number(item.price) || 0) * multiplier);
                    }
                    if (target === 'cost' || target === 'both') {
                        if (!item._origCost) item._origCost = Number(item.cost) || 0;
                        item.cost = Math.round((Number(item.cost) || 0) * multiplier);
                    }
                    calcLine(item);
                    count++;
                });
                isDirty.value = true;
                const label = target === 'price' ? '見積単価' : target === 'cost' ? '原価単価' : '見積単価・原価単価';
                notify(count + '行の' + label + 'を' + (pct > 0 ? '+' : '') + pct + '%変更しました', 'success');
            };

            const predictPrice = async (item) => {
                if (!item.product) return;
                loading.value = true;
                loadingMessage.value = 'AI単価予測中...';
                try {
                    const res = JSON.parse(await gas('apiPredictUnitPrice', item.product, item.spec || ''));
                    if (res.price) {
                        item.price = res.price;
                        calcLine(item);
                        notify('AI予測単価: ' + formatCurrency(res.price));
                    } else {
                        notify(res.error || '予測できませんでした', 'error');
                    }
                } catch (e) {
                    notify('AI予測エラー: ' + e.message, 'error');
                } finally {
                    loading.value = false;
                }
            };

            const showSuggestions = (idx) => { activeSuggestionIdx.value = idx; filteredSuggestions.value = []; };
            const hideSuggestions = () => { setTimeout(() => activeSuggestionIdx.value = null, 200); };
            const applySuggestion = (idx, s) => { /* 実装省略 */ };
            const onClientInput = debounce(async (e) => {
                const val = e.target.value;
                if(!val) { clientHistory.value = []; return; }
                const res = await gas('apiGetClientHistory', val);
                clientHistory.value = JSON.parse(res);
                if(clientHistory.value.length > 0) showSidePanel.value = true;
            }, 400);
            
            const loadInvoiceFiles = async () => { invoiceFiles.value = JSON.parse(await gas('apiListInvoiceDriveFiles')); };
            const selectInvoiceFile = async (f) => { selectedInvoiceFile.value = f; isAnalyzing.value = true; invoiceForm.fileId = f.id; invoiceForm.id = ""; try { const r = JSON.parse(await gas('apiParseInvoiceFile', f.id)); Object.assign(invoiceForm, r); if(invoiceForm.constructionId) checkOrderBalance(); } finally { isAnalyzing.value = false; } };
            const resetInvoiceForm = () => { Object.assign(invoiceForm, { id: "", constructionId: "", project: "", date: "", person: "", contractor: "", amount: 0, offset: 0, content: "", location: "", fileId: "", status: "着工", initial: "", detectedKanryo: false }); selectedInvoiceFile.value = null; uploadedInvoiceFile.value = null; };
            const uploadInvoicePdf = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                event.target.value = '';
                resetInvoiceForm();
                uploadedInvoiceFile.value = { name: file.name };
                isAnalyzing.value = true;
                try {
                    const reader = new FileReader();
                    const base64 = await new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    const res = JSON.parse(await gas('apiParseInvoiceFromBase64', base64, file.type));
                    if (res.error) { notify(res.error, 'error'); return; }
                    Object.assign(invoiceForm, res);
                    if (invoiceForm.constructionId) checkOrderBalance();
                    notify('PDFの解析が完了しました');
                } catch (e) {
                    notify('PDF解析エラー: ' + (e.message || e), 'error');
                } finally {
                    isAnalyzing.value = false;
                }
            };
            const checkOrderBalance = async () => { if(invoiceForm.constructionId && invoiceForm.person) orderBalance.value = JSON.parse(await gas('apiGetOrderBalance', invoiceForm.constructionId, invoiceForm.person)); };
            const onProjectSelect = (e) => { const val = e.target.value; const p = activeProjects.value.find(ap => ap.name === val); if(p) { invoiceForm.constructionId = p.id; invoiceForm.project = p.name; checkOrderBalance(); } };
            const registerInvoice = async () => { if(!invoiceForm.id && !selectedInvoiceFile.value && !uploadedInvoiceFile.value) return notify("ファイル未選択", "error"); loadingMessage.value = '保存中...'; loading.value = true; try { const r = JSON.parse(await gas('apiSaveInvoice', JSON.stringify(invoiceForm))); if(r.success) { let msg = "登録しました"; if(r.constructionId) msg += " (工事番号: " + r.constructionId + ")"; if(r.autoComplete && r.autoComplete.updated > 0) msg += "\n" + r.autoComplete.updated + "件の関連レコードを「完了」に更新しました"; notify(msg); resetInvoiceForm(); loadInvoiceFiles(); fetchInvoices(); } } finally { loading.value = false; } };
            const editInvoice = (inv) => { Object.assign(invoiceForm, inv); selectedInvoiceFile.value = null; checkOrderBalance(); };
            const updateInvoiceStatus = async (id, st) => { await gas('apiUpdateInvoiceStatus', id, st); fetchInvoices(); };
            const deleteItem = async (id) => { if(await confirmAction("削除しますか？")) { await gas('apiDeleteData', id); notify("削除しました"); if(currentTab.value==='admin') goToAdmin(); } };
            
            const openLedger = async (id) => { loadingMessage.value = '読込中'; loading.value = true; try { ledgerData.value = JSON.parse(await gas('apiGetProjectLedger', id)); showLedgerModal.value = true; } finally { loading.value = false; } };
            const createLedgerPdf = async () => { loading.value = true; try { const r = JSON.parse(await gas('apiCreateLedgerPdf', JSON.stringify(ledgerData.value))); if(r.success) openUrl(r.url); } finally { loading.value = false; } };
            
            const loadAnalysis = async () => {
                adminSubTab.value = 'analysis';
                loadingMessage.value = '読込中';
                loading.value = true;
                try {
                    const res = await gas('apiGetAnalysisData', analysisYear.value);
                    const d = res ? (typeof res === 'string' ? JSON.parse(res) : res) : null;
                    analysisData.monthly = (d && Array.isArray(d.monthly)) ? d.monthly : Array(12).fill(0).map(() => ({ sales: 0, cost: 0, profit: 0 }));
                    analysisData.ranking = (d && Array.isArray(d.ranking)) ? d.ranking : [];
                } catch (e) {
                    analysisData.monthly = Array(12).fill(0).map(() => ({ sales: 0, cost: 0, profit: 0 }));
                    analysisData.ranking = [];
                    notify("分析データの取得に失敗しました: " + (e?.message || e), "error");
                } finally {
                    loading.value = false;
                    await nextTick();
                    renderChart();
                }
            };
            const renderChart = () => {
                const ctx = document.getElementById('salesChart');
                if (!ctx) return;
                if (salesChartInstance) { salesChartInstance.destroy(); salesChartInstance = null; }
                const monthly = analysisData.monthly || [];
                const labels = [1,2,3,4,5,6,7,8,9,10,11,12].map(m => m + '月');
                const salesData = monthly.length >= 12 ? monthly.map(m => Number(m.sales) || 0) : Array(12).fill(0);
                const profitData = monthly.length >= 12 ? monthly.map(m => Number(m.profit) || 0) : Array(12).fill(0);
                salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: '売上', data: salesData, backgroundColor: '#3B82F6' },
                            { label: '粗利', data: profitData, backgroundColor: '#10B981' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { beginAtZero: true }
                        }
                    }
                });
            };
            
            const openDraftModal = async () => { showDraftModal.value = true; isDraftLoading.value = true; try { drafts.value = JSON.parse(await gas('apiGetDrafts')).filter(i => i.status === '下書き'); } finally { isDraftLoading.value = false; } };
            const selectDraft = (id) => {
                // 下書きモーダル経由 → 従来どおり見積全体をロード
                if (showDraftModal.value) { showDraftModal.value = false; loadEstimate(id); return; }
                // 履歴サイドパネル経由 → フローティングプレビューパネルを開く
                openFloatingEstimatePanel(id);
            };
            const openOcrModal = async () => {
                showOcrModal.value = true;
                ocrTab.value = 'upload';
                selectedOcrFiles.value = [];
                ocrUploadFiles.value = [];
                ocrResults.value = [];
                showOcrPreview.value = false;
                ocrProcessing.value = false;
                isOcrLoading.value = true;
                try {
                    const res = JSON.parse(await gas('apiListDriveFiles'));
                    ocrFiles.value = res.error ? [] : res;
                } catch(e) { ocrFiles.value = []; }
                finally { isOcrLoading.value = false; }
            };
            const toggleFileSelection = (f) => { const idx = selectedOcrFiles.value.indexOf(f.id); if(idx>=0) selectedOcrFiles.value.splice(idx,1); else selectedOcrFiles.value.push(f.id); };
            const readFilesForOcr = (fileList) => {
                Array.from(fileList).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) { notify(file.name + ' は10MBを超えています', 'error'); return; }
                    const allowed = ['image/jpeg','image/png','image/gif','image/webp','application/pdf'];
                    if (!allowed.includes(file.type)) { notify(file.name + ' は対応していない形式です', 'error'); return; }
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        ocrUploadFiles.value.push({ name: file.name, mime: file.type, base64, size: file.size });
                    };
                    reader.readAsDataURL(file);
                });
            };
            const handleOcrFileSelect = (event) => { readFilesForOcr(event.target.files); event.target.value = ''; };
            const handleOcrDrop = (event) => { readFilesForOcr(event.dataTransfer.files); };
            const executeOcrScan = async () => {
                ocrProcessing.value = true;
                ocrResults.value = [];
                try {
                    let allItems = [];
                    if (ocrTab.value === 'drive') {
                        for (const fileId of selectedOcrFiles.value) {
                            const res = JSON.parse(await gas('apiOcrEstimateFromDrive', fileId));
                            if (res.error) { notify('読取エラー: ' + res.error, 'error'); continue; }
                            if (res.items && res.items.length > 0) allItems = allItems.concat(res.items);
                        }
                    } else {
                        for (const file of ocrUploadFiles.value) {
                            const res = JSON.parse(await gas('apiOcrEstimateFromBase64', file.base64, file.mime));
                            if (res.error) { notify(file.name + ' の読取エラー: ' + res.error, 'error'); continue; }
                            if (res.items && res.items.length > 0) allItems = allItems.concat(res.items);
                        }
                    }
                    if (allItems.length === 0) { notify('明細を検出できませんでした', 'error'); return; }
                    ocrResults.value = allItems;
                    showOcrPreview.value = true;
                } catch(e) { notify('OCR処理でエラーが発生しました: ' + (e.message || e), 'error'); }
                finally { ocrProcessing.value = false; }
            };
            const applyOcrResults = (mode) => {
                const items = ocrResults.value;
                if (items.length === 0) return;
                const count = items.length;
                if (currentTab.value === 'dedicated_order') {
                    if (mode === 'replace') dedicatedOrderForm.items = [];
                    items.forEach(item => {
                        const ocrAmount = Number(item.amount) || 0;
                        const qty = Number(item.qty) || 1;
                        const price = Number(item.price) || 0;
                        const calcAmount = Math.round(qty * price);
                        const newRow = {product: item.product || "", spec: item.spec || "", vendor: "", estQty: qty, estUnit: item.unit || "式", estPrice: price, estAmount: ocrAmount || calcAmount, exeQty: qty, exeUnit: item.unit || "式", exePrice: price, exeAmount: ocrAmount || calcAmount, selected: false};
                        dedicatedOrderForm.items.push(newRow);
                    });
                } else {
                    if (mode === 'replace') form.items = [];
                    items.forEach(item => {
                        const ocrAmount = Number(item.amount) || 0;
                        const qty = Number(item.qty) || 1;
                        const price = Number(item.price) || 0;
                        const calcAmount = Math.round(qty * price);
                        const newItem = { _uid: genUid(), category: item.category || "", product: item.product || "", spec: item.spec || "",
                            qty: qty, unit: item.unit || "式", price: price,
                            cost: "", amount: ocrAmount || calcAmount, orderedQty: "", orderedAmount: 0, selected: false };
                        form.items.push(newItem);
                    });
                }
                showOcrModal.value = false;
                showOcrPreview.value = false;
                // 材料費単価マスタに自動蓄積（バックグラウンド）
                const materialItems = items.filter(it => it.product).map(it => ({
                    product: it.product || '', spec: it.spec || '',
                    unit: it.unit || '式', price: Number(it.price) || 0
                }));
                if (materialItems.length > 0) {
                    gas('apiUpsertMaterialPrices', JSON.stringify(materialItems))
                        .then(() => gas('apiGetMaterialPrices'))
                        .then(res => { materialPrices.value = JSON.parse(res); })
                        .catch(e => console.warn('材料費単価マスタ更新失敗:', e));
                }
                ocrResults.value = [];
                selectedOcrFiles.value = [];
                ocrUploadFiles.value = [];
                notify((mode === 'replace' ? '置換' : '追加') + 'で ' + count + ' 件の明細を反映しました');
            };
            
            const showPreview = async () => { loadingMessage.value = '読込中'; loading.value = true; try { const res = JSON.parse(await gas('apiPreviewJournalData', journalYear.value, journalMonth.value, journalIncludeSales.value, journalIncludePurchases.value)); previewData.headers = res.headers; previewData.rows = res.rows; showPreviewModal.value = true; } finally { loading.value = false; } };
            const downloadJournalCsv = async () => { loadingMessage.value = '読込中'; loading.value = true; try { const res = JSON.parse(await gas('apiGenerateJournalData', journalYear.value, journalMonth.value, journalIncludeSales.value, journalIncludePurchases.value)); if(res.success) { const a = document.createElement('a'); a.href = "data:text/csv;base64," + res.data; a.download = res.filename; a.click(); } } finally { loading.value = false; } };

            const fetchDeposits = async () => { adminTabLoading.value = true; try { const res = await gas('apiGetDeposits'); deposits.value = JSON.parse(res); } catch(e) { deposits.value = []; notify("入金データの取得に失敗しました", "error"); } finally { adminTabLoading.value = false; } };
            const fetchPayments = async () => { adminTabLoading.value = true; try { const res = await gas('apiGetPayments'); payments.value = JSON.parse(res); } catch(e) { payments.value = []; notify("出金データの取得に失敗しました", "error"); } finally { adminTabLoading.value = false; } };
            const openDepositModal = (d) => {
                const today = new Date().toISOString().slice(0,10);
                if (d) { Object.assign(depositForm, { id: d.id, date: d.date ? new Date(d.date).toISOString().slice(0,10) : today, estimateId: d.estimateId || "", client: d.client, project: d.project || "", type: d.type || "振込", amount: d.amount || 0, fee: d.fee || 0, offset: d.offset || 0, remarks: d.remarks || "", status: d.status || "確認済" }); }
                else { Object.assign(depositForm, { id: "", date: today, estimateId: "", client: "", project: "", type: "振込", amount: 0, fee: 0, offset: 0, remarks: "", status: "確認済" }); }
                showDepositModal.value = true;
            };
            const openPaymentModal = (p) => {
                const today = new Date().toISOString().slice(0,10);
                if (p) { Object.assign(paymentForm, { id: p.id, date: p.date ? new Date(p.date).toISOString().slice(0,10) : today, orderId: p.orderId || "", invoiceId: p.invoiceId || "", supplier: p.supplier, project: p.project || "", type: p.type || "振込", amount: p.amount || 0, fee: p.fee || 0, offset: p.offset || 0, remarks: p.remarks || "", status: p.status || "確認済" }); }
                else { Object.assign(paymentForm, { id: "", date: today, orderId: "", invoiceId: "", supplier: "", project: "", type: "振込", amount: 0, fee: 0, offset: 0, remarks: "", status: "確認済" }); }
                showPaymentModal.value = true;
            };
            const saveDeposit = async () => {
                if (!(depositForm.client || "").trim()) return notify("取引先名を入力してください", "error");
                if (!(depositForm.amount || 0)) return notify("入金金額を入力してください", "error");
                loading.value = true; try {
                    const res = JSON.parse(await gas('apiSaveDeposit', JSON.stringify(depositForm)));
                    if (res.success) { notify("入金情報を保存しました"); showDepositModal.value = false; await fetchDeposits(); }
                    else notify(res.message || "保存に失敗しました", "error");
                } catch(e) { notify("保存エラー: " + (e.message||e), "error"); } finally { loading.value = false; }
            };
            const savePayment = async () => {
                if (!(paymentForm.supplier || "").trim()) return notify("支払先名を入力してください", "error");
                if (!(paymentForm.amount || 0)) return notify("出金金額を入力してください", "error");
                loading.value = true; try {
                    const res = JSON.parse(await gas('apiSavePayment', JSON.stringify(paymentForm)));
                    if (res.success) { notify("出金情報を保存しました"); showPaymentModal.value = false; await fetchPayments(); }
                    else notify(res.message || "保存に失敗しました", "error");
                } catch(e) { notify("保存エラー: " + (e.message||e), "error"); } finally { loading.value = false; }
            };

            const reprintOrderPdf = async (orderId) => {
                if(!await confirmAction("この発注書のPDFを再発行しますか？")) return;
                loading.value = true;
                try {
                    const res = await gas('apiReprintOrderPdf', orderId);
                    const r = JSON.parse(res);
                    if (r.success) {
                        openUrl(r.url);
                        notify("PDFを再発行しました");
                    } else {
                        notify(r.message, "error");
                    }
                } catch(e) {
                    notify("エラー: " + e.message, "error");
                } finally {
                    loading.value = false;
                }
            };

            // --- AIチャットボット：画面コンテキスト収集 ---
            const getScreenContext = () => {
                const tabNameMap = {
                    'menu': 'メインメニュー',
                    'edit': '御見積書作成・編集画面',
                    'dedicated_order': '発注書作成画面',
                    'list': '案件一覧・売上統計画面',
                    'invoice': '請求書受取画面',
                    'admin': '管理者画面'
                };
                const ctx = { screenName: tabNameMap[currentTab.value] || currentTab.value };

                if (currentTab.value === 'menu' && reminders.value.length > 0) {
                    ctx.subScreen = 'リマインドパネル表示中（' + reminders.value.length + '件）';
                }
                if (currentTab.value === 'list') {
                    ctx.subScreen = listSubTab.value === 'estimate' ? '見積案件一覧' : '発注案件一覧';
                }
                if (currentTab.value === 'admin') {
                    const adminMap = { 'approval': '承認管理', 'analysis': '経営分析', 'accounting': '会計連携', 'deposits': '入金管理', 'payments': '支払管理', 'settings': 'システム設定' };
                    ctx.subScreen = adminMap[adminSubTab.value] || adminSubTab.value;
                }
                if (currentTab.value === 'edit') {
                    if (sidePanelMode.value) {
                        ctx.sidePanel = sidePanelMode.value === 'history' ? '履歴パネル' : '発注先パネル';
                    }
                    if (leftPanelMode.value) {
                        ctx.leftPanel = leftPanelMode.value === 'price' ? '単価マスタパネル' : 'セットテンプレートパネル';
                    }
                }
                return ctx;
            };

            // --- AIチャットボット送信処理 ---
            const sendChatMessage = async () => {
                const text = chatInput.value.trim();
                if (!text) return;

                // 画面コンテキストを収集
                const screenContext = getScreenContext();

                // ユーザーのメッセージを追加
                chatMessages.value.push({ role: 'user', text: text });
                chatInput.value = "";
                isChatThinking.value = true;

                // 最下部へスクロール
                await nextTick();
                const container = document.getElementById('chat-history');
                if(container) container.scrollTop = container.scrollHeight;

                try {
                    // GAS (コード.js) の apiChatWithSystemBot を呼び出し
                    const resJson = await gas('apiChatWithSystemBot', text, screenContext);
                    const res = JSON.parse(resJson);
                    
                    if (res.error) {
                        chatMessages.value.push({ role: 'ai', text: "エラーが発生しました:\n" + res.error });
                    } else {
                        chatMessages.value.push({ role: 'ai', text: res.reply });
                    }
                } catch (e) {
                    console.error(e);
                    chatMessages.value.push({ role: 'ai', text: "通信エラーが発生しました。ネットワークを確認してください。" });
                } finally {
                    isChatThinking.value = false;
                    await nextTick();
                    if(container) container.scrollTop = container.scrollHeight;
                }
            };

            // --- AI操作アシスタント ---
            const ALLOWED_ITEM_FIELDS = ['vendor','category','product','spec','qty','unit','price','cost','remarks'];
            const ALLOWED_HEADER_FIELDS = ['client','project','location','period','payment','expiry'];
            const ALLOWED_ORDER_ITEM_FIELDS = ['product','spec','vendor','estQty','estUnit','estPrice','exeQty','exeUnit','exePrice'];
            const ALLOWED_ORDER_HEADER_FIELDS = ['vendor','project','location','period','payment','expiry','date'];
            const ALLOWED_ORDER_MODIFIER_FIELDS = ['estPrice','exePrice','estQty','exeQty'];
            const ALLOWED_INVOICE_FIELDS = ['constructionId','project','date','person','contractor','amount','offset','content','location','status'];
            const FIELD_LABELS = { vendor:'発注先', category:'工種', product:'品名', spec:'仕様', qty:'数量', unit:'単位', price:'単価', cost:'原価', remarks:'備考', client:'顧客名', project:'工事名', location:'現場', period:'工期', payment:'支払条件', expiry:'有効期限', estQty:'見積数量', estUnit:'見積単位', estPrice:'見積単価', exeQty:'実行数量', exeUnit:'実行単位', exePrice:'実行単価', constructionId:'工事ID', date:'日付', person:'担当者', contractor:'業者', amount:'金額', offset:'相殺', content:'内容', status:'ステータス' };
            const aiAssistantLoadingText = ref('AI分析中...');

            const aiAssistantPlaceholder = computed(() => {
                const tab = currentTab.value;
                if (tab === 'edit') return '例: 発注先を全て○○にして';
                if (tab === 'dedicated_order') return '例: 全ての単価を1.1倍にして';
                if (tab === 'invoice') return '例: 担当者をXXに変更して';
                if (tab === 'list') return '例: 先月の見積合計は？';
                return '例: 見積一覧を開いて';
            });

            const filterItems = (filter) => {
                if (!filter || filter.operator === 'all') return form.items.map((it, i) => ({ item: it, index: i }));
                return form.items.map((it, i) => ({ item: it, index: i })).filter(({ item }) => {
                    const val = String(item[filter.field] || '');
                    if (filter.operator === 'equals') return val === filter.value;
                    if (filter.operator === 'contains') return val.includes(filter.value);
                    return false;
                });
            };

            const filterOrderItems = (filter) => {
                if (!filter || filter.operator === 'all') return dedicatedOrderForm.items.map((it, i) => ({ item: it, index: i }));
                return dedicatedOrderForm.items.map((it, i) => ({ item: it, index: i })).filter(({ item }) => {
                    const val = String(item[filter.field] || '');
                    if (filter.operator === 'equals') return val === filter.value;
                    if (filter.operator === 'contains') return val.includes(filter.value);
                    return false;
                });
            };

            const generateAiPreview = (actions) => {
                const lines = [];
                for (const act of actions) {
                    if (act.type === 'update_item') {
                        const matched = filterItems(act.filter);
                        if (act.changes) {
                            const chFields = Object.entries(act.changes).filter(([k,v]) => v !== undefined && v !== '').map(([k,v]) => `${FIELD_LABELS[k]||k}→「${v}」`).join(', ');
                            lines.push(`明細 ${matched.length}件: ${chFields}`);
                        }
                        if (act.modifier) {
                            const opLabel = act.modifier.operation === 'multiply' ? '×' : act.modifier.operation === 'add' ? '+' : '=';
                            lines.push(`明細 ${matched.length}件: ${FIELD_LABELS[act.modifier.field]||act.modifier.field} ${opLabel}${act.modifier.value}`);
                        }
                    } else if (act.type === 'update_header') {
                        const chFields = Object.entries(act.changes || {}).filter(([k,v]) => v !== undefined && v !== '').map(([k,v]) => `${FIELD_LABELS[k]||k}→「${v}」`).join(', ');
                        lines.push(`ヘッダー: ${chFields}`);
                    } else if (act.type === 'add_item') {
                        lines.push(`追加: ${act.newItem?.product || '品目'}`);
                    } else if (act.type === 'remove_item') {
                        const matched = filterItems(act.filter);
                        lines.push(`削除: ${matched.length}件`);
                    // 発注アクション
                    } else if (act.type === 'update_order_item') {
                        const matched = filterOrderItems(act.filter);
                        if (act.changes) {
                            const chFields = Object.entries(act.changes).filter(([k,v]) => v !== undefined && v !== '').map(([k,v]) => `${FIELD_LABELS[k]||k}→「${v}」`).join(', ');
                            lines.push(`発注明細 ${matched.length}件: ${chFields}`);
                        }
                        if (act.modifier) {
                            const opLabel = act.modifier.operation === 'multiply' ? '×' : act.modifier.operation === 'add' ? '+' : '=';
                            lines.push(`発注明細 ${matched.length}件: ${FIELD_LABELS[act.modifier.field]||act.modifier.field} ${opLabel}${act.modifier.value}`);
                        }
                    } else if (act.type === 'update_order_header') {
                        const chFields = Object.entries(act.changes || {}).filter(([k,v]) => v !== undefined && v !== '').map(([k,v]) => `${FIELD_LABELS[k]||k}→「${v}」`).join(', ');
                        lines.push(`発注ヘッダー: ${chFields}`);
                    } else if (act.type === 'add_order_item') {
                        lines.push(`発注追加: ${act.newItem?.product || '品目'}`);
                    } else if (act.type === 'remove_order_item') {
                        const matched = filterOrderItems(act.filter);
                        lines.push(`発注削除: ${matched.length}件`);
                    // 請求書アクション
                    } else if (act.type === 'update_invoice') {
                        const chFields = Object.entries(act.changes || {}).filter(([k,v]) => v !== undefined && v !== '').map(([k,v]) => `${FIELD_LABELS[k]||k}→「${v}」`).join(', ');
                        lines.push(`請求書: ${chFields}`);
                    }
                }
                return lines.join('\n');
            };

            const executeAiActions = (actions) => {
                let changeCount = 0;
                for (const act of actions) {
                    if (act.type === 'update_item') {
                        const matched = filterItems(act.filter);
                        for (const { item } of matched) {
                            if (act.changes) {
                                for (const [k, v] of Object.entries(act.changes)) {
                                    if (ALLOWED_ITEM_FIELDS.includes(k) && v !== undefined && v !== '') { item[k] = v; changeCount++; }
                                }
                            }
                            if (act.modifier && ALLOWED_ITEM_FIELDS.includes(act.modifier.field)) {
                                const cur = Number(item[act.modifier.field]) || 0;
                                if (act.modifier.operation === 'multiply') item[act.modifier.field] = Math.round(cur * act.modifier.value);
                                else if (act.modifier.operation === 'add') item[act.modifier.field] = Math.round(cur + act.modifier.value);
                                else if (act.modifier.operation === 'set') item[act.modifier.field] = act.modifier.value;
                                changeCount++;
                            }
                            calcLine(item);
                        }
                    } else if (act.type === 'update_header') {
                        for (const [k, v] of Object.entries(act.changes || {})) {
                            if (ALLOWED_HEADER_FIELDS.includes(k) && v !== undefined && v !== '') { form.header[k] = v; changeCount++; }
                        }
                    } else if (act.type === 'add_item') {
                        const ni = act.newItem || {};
                        const newRow = { _uid: genUid(), category: ni.category||'', product: ni.product||'', spec: ni.spec||'', qty: ni.qty||0, unit: ni.unit||'', price: ni.price||0, cost: ni.cost||0, vendor: ni.vendor||'', amount: 0, orderedQty: '', orderedAmount: 0, selected: false, remarks: '' };
                        calcLine(newRow);
                        form.items.push(newRow);
                        changeCount++;
                    } else if (act.type === 'remove_item') {
                        const matched = filterItems(act.filter);
                        const indices = matched.map(m => m.index).sort((a,b) => b - a);
                        for (const idx of indices) { form.items.splice(idx, 1); changeCount++; }
                    }
                }
                return changeCount;
            };

            const executeAiOrderActions = (actions) => {
                let changeCount = 0;
                for (const act of actions) {
                    if (act.type === 'update_order_item') {
                        const matched = filterOrderItems(act.filter);
                        for (const { item } of matched) {
                            if (act.changes) {
                                for (const [k, v] of Object.entries(act.changes)) {
                                    if (ALLOWED_ORDER_ITEM_FIELDS.includes(k) && v !== undefined && v !== '') { item[k] = v; changeCount++; }
                                }
                            }
                            if (act.modifier && ALLOWED_ORDER_MODIFIER_FIELDS.includes(act.modifier.field)) {
                                const cur = Number(item[act.modifier.field]) || 0;
                                if (act.modifier.operation === 'multiply') item[act.modifier.field] = Math.round(cur * act.modifier.value);
                                else if (act.modifier.operation === 'add') item[act.modifier.field] = Math.round(cur + act.modifier.value);
                                else if (act.modifier.operation === 'set') item[act.modifier.field] = act.modifier.value;
                                changeCount++;
                            }
                            calcDedicatedLine(item);
                        }
                    } else if (act.type === 'update_order_header') {
                        for (const [k, v] of Object.entries(act.changes || {})) {
                            if (ALLOWED_ORDER_HEADER_FIELDS.includes(k) && v !== undefined && v !== '') { dedicatedOrderForm.header[k] = v; changeCount++; }
                        }
                    } else if (act.type === 'add_order_item') {
                        const ni = act.newItem || {};
                        const newRow = { product: ni.product||'', spec: ni.spec||'', vendor: ni.vendor||'', estQty: ni.estQty||0, estUnit: ni.estUnit||'', estPrice: ni.estPrice||0, estAmount: 0, exeQty: ni.exeQty||0, exeUnit: ni.exeUnit||'', exePrice: ni.exePrice||0, exeAmount: 0, selected: false };
                        calcDedicatedLine(newRow);
                        dedicatedOrderForm.items.push(newRow);
                        changeCount++;
                    } else if (act.type === 'remove_order_item') {
                        const matched = filterOrderItems(act.filter);
                        const indices = matched.map(m => m.index).sort((a,b) => b - a);
                        for (const idx of indices) { dedicatedOrderForm.items.splice(idx, 1); changeCount++; }
                    }
                }
                return changeCount;
            };

            const executeAiInvoiceActions = (actions) => {
                let changeCount = 0;
                for (const act of actions) {
                    if (act.type === 'update_invoice') {
                        for (const [k, v] of Object.entries(act.changes || {})) {
                            if (ALLOWED_INVOICE_FIELDS.includes(k) && v !== undefined && v !== '') {
                                invoiceForm[k] = (k === 'amount' || k === 'offset') ? Number(v) : v;
                                changeCount++;
                            }
                        }
                    }
                }
                return changeCount;
            };

            // 画面とアクションの整合性バリデーション
            const validateActionsForScreen = (actions, screen) => {
                const screenActions = {
                    edit: ['update_item', 'update_header', 'add_item', 'remove_item', 'navigate'],
                    dedicated_order: ['update_order_item', 'update_order_header', 'add_order_item', 'remove_order_item', 'navigate'],
                    invoice: ['update_invoice', 'navigate'],
                    menu: ['navigate'], list: ['navigate'], admin: ['navigate']
                };
                const allowed = screenActions[screen] || ['navigate'];
                return actions.filter(a => allowed.includes(a.type));
            };

            // ナビゲーション処理
            const handleAiNavigation = async (action) => {
                checkUnsavedChanges(async () => {
                    const target = action.target;
                    const targetId = action.targetId;
                    const targetSubTab = action.targetSubTab;
                    if (target === 'edit') {
                        if (targetId) { await loadEstimate(targetId); }
                        else { createNewEstimate(); }
                    } else if (target === 'dedicated_order') {
                        if (targetId) { await openOrderForEdit(targetId); }
                        else { createNewDedicatedOrder(); }
                    } else if (target === 'list') {
                        await goToProjectList();
                        if (targetSubTab) nextTick(() => { listSubTab.value = targetSubTab; });
                    } else if (target === 'invoice') {
                        await goToInvoice();
                    } else if (target === 'admin') {
                        await goToAdmin();
                        if (targetSubTab) nextTick(() => { adminSubTab.value = targetSubTab; loadAdminSubTab(targetSubTab); });
                    } else if (target === 'menu') {
                        goHome();
                    }
                });
            };

            const sendAiAssistantMessage = async () => {
                const text = aiAssistantInput.value.trim();
                if (!text) return;

                aiAssistantMessages.value.push({ role: 'user', text });
                aiAssistantInput.value = '';
                isAiAssistantThinking.value = true;
                aiAssistantLoadingText.value = 'AI分析中...';

                await nextTick();
                const container = document.getElementById('ai-assistant-history');
                if (container) container.scrollTop = container.scrollHeight;

                try {
                    // 画面に応じたコンテキスト構築
                    const screen = currentTab.value;
                    const ctx = { screen };
                    if (screen === 'edit') {
                        ctx.formData = { header: JSON.parse(JSON.stringify(form.header)), items: form.items.map(i => ({ category: i.category, product: i.product, spec: i.spec, qty: i.qty, unit: i.unit, price: i.price, cost: i.cost, vendor: i.vendor })) };
                    } else if (screen === 'dedicated_order') {
                        ctx.formData = { header: JSON.parse(JSON.stringify(dedicatedOrderForm.header)), items: dedicatedOrderForm.items.map(i => ({ product: i.product, spec: i.spec, vendor: i.vendor, estQty: i.estQty, estUnit: i.estUnit, estPrice: i.estPrice, exeQty: i.exeQty, exeUnit: i.exeUnit, exePrice: i.exePrice })) };
                    } else if (screen === 'invoice') {
                        ctx.formData = JSON.parse(JSON.stringify(invoiceForm));
                    } else if (screen === 'list') {
                        ctx.summaryData = { subTab: listSubTab.value, count: filteredProjects.value ? filteredProjects.value.length : 0 };
                    } else if (screen === 'admin') {
                        ctx.summaryData = { subTab: adminSubTab.value };
                    } else if (screen === 'menu') {
                        ctx.summaryData = { reminderCount: reminders.value ? reminders.value.length : 0 };
                    }
                    // 直近3件の会話履歴
                    const recentMsgs = aiAssistantMessages.value.filter(m => m.role === 'user' || m.role === 'ai').slice(-6);
                    ctx.history = recentMsgs.map(m => ({ role: m.role, text: m.text ? m.text.substring(0, 200) : '' }));

                    const resJson = await gas('apiAiAssistantUnified', text, JSON.stringify(ctx));
                    const res = JSON.parse(resJson);

                    if (res.error) {
                        aiAssistantMessages.value.push({ role: 'ai', text: 'エラー: ' + res.error });
                    } else if (res.responseType === 'navigate') {
                        // ナビゲーション
                        const navAction = (res.actions && res.actions[0]) || res;
                        aiAssistantMessages.value.push({ role: 'ai', text: res.summary || '画面を遷移します。' });
                        await handleAiNavigation(navAction);
                    } else if (res.responseType === 'query') {
                        // クエリ結果表示
                        aiAssistantMessages.value.push({ role: 'ai', text: res.queryResult || res.summary || 'データを取得しました。' });
                    } else if (res.responseType === 'action') {
                        // データ変更アクション（プレビュー→確認フロー）
                        const validActions = validateActionsForScreen(res.actions || [], screen);
                        if (validActions.length === 0) {
                            aiAssistantMessages.value.push({ role: 'ai', text: res.summary || '現在の画面では実行できない操作です。' });
                        } else {
                            const preview = generateAiPreview(validActions);
                            aiAssistantMessages.value.push({ role: 'preview', text: res.summary, detail: preview, confidence: res.confidence, actions: validActions });
                            aiPendingActions.value = { ...res, actions: validActions };
                        }
                    } else {
                        // responseType不明またはactions空
                        aiAssistantMessages.value.push({ role: 'ai', text: res.summary || '操作対象が見つかりませんでした。' });
                    }
                } catch (e) {
                    console.error(e);
                    aiAssistantMessages.value.push({ role: 'ai', text: '通信エラーが発生しました。' });
                } finally {
                    isAiAssistantThinking.value = false;
                    aiAssistantLoadingText.value = 'AI分析中...';
                    await nextTick();
                    if (container) container.scrollTop = container.scrollHeight;
                }
            };

            const applyAiActions = () => {
                if (!aiPendingActions.value) return;
                const actions = aiPendingActions.value.actions || [];
                const hasOrderActions = actions.some(a => (a.type && a.type.startsWith('update_order')) || a.type === 'add_order_item' || a.type === 'remove_order_item');
                const hasInvoiceActions = actions.some(a => a.type === 'update_invoice');
                let count = 0;

                if (hasOrderActions) {
                    // 発注フォームのスナップショット
                    formSnapshot.value = { source: 'dedicated_order', header: JSON.parse(JSON.stringify(dedicatedOrderForm.header)), items: JSON.parse(JSON.stringify(dedicatedOrderForm.items)) };
                    count = executeAiOrderActions(actions);
                } else if (hasInvoiceActions) {
                    // 請求書フォームのスナップショット
                    formSnapshot.value = { source: 'invoice', data: JSON.parse(JSON.stringify(invoiceForm)) };
                    count = executeAiInvoiceActions(actions);
                } else {
                    // 見積フォームのスナップショット（既存）
                    formSnapshot.value = { source: 'edit', header: JSON.parse(JSON.stringify(form.header)), items: JSON.parse(JSON.stringify(form.items)) };
                    count = executeAiActions(actions);
                }
                isDirty.value = true;
                // プレビューメッセージを適用済みに更新
                const lastPreview = [...aiAssistantMessages.value].reverse().find(m => m.role === 'preview');
                if (lastPreview) lastPreview.applied = true;
                aiPendingActions.value = null;
                notify(`AI操作を適用しました (${count}件変更)`);
            };

            const cancelAiAction = () => {
                const lastPreview = [...aiAssistantMessages.value].reverse().find(m => m.role === 'preview' && !m.applied);
                if (lastPreview) lastPreview.cancelled = true;
                aiPendingActions.value = null;
                notify('操作をキャンセルしました', 'info');
            };

            return {
                reminders, remindersLoading, reminderTriggerActive, reminderTriggerLoading, fetchReminderTriggerStatus, toggleReminderTrigger,
                lineSettings, lineSettingsLoading, fetchLineSettings, saveLineToken, addLineUser, removeLineUser, testLineSend,
                webhookUrl, fetchWebhookUrl, copyWebhookUrl, saveLineChannelSecret,
                loading, loadingMessage, currentTab, userEmail, auth, masters, projects, orders, adminInvoices, isReviewMode, showBackButton, isDirty, clipboardData, formSnapshot, restoreSnapshot, copyDocument, pasteDocument, allCompanies, clientDropdown, filteredCompanies,
                invoiceFiles, selectedInvoiceFile, uploadedInvoiceFile, isAnalyzing, invoiceForm, activeProjects, orderBalance, uploadInvoicePdf,
                journalYear, journalMonth, journalYears, showPreviewModal, previewData, journalIncludeSales, journalIncludePurchases,
                deposits, payments, depositForm, paymentForm, showDepositModal, showPaymentModal, fetchDeposits, fetchPayments, openDepositModal, openPaymentModal, saveDeposit, savePayment,
                activeSuggestionIdx, filteredSuggestions, showSidePanel, clientHistory,
                showLedgerModal, ledgerData, adminSubTab, adminTabLoading, loadAdminSubTab, analysisYear, analysisData, analysisTotalSales, analysisTotalProfit,
                notifications, confirmState, form, filter, listSubTab, orderListFilter, orderListVendors, orderListYears, filteredOrderList,
                showOcrModal, ocrFiles, isOcrLoading, selectedOcrFiles, ocrTab, ocrUploadFiles, ocrResults, showOcrPreview, ocrProcessing,
                showDraftModal, drafts, isDraftLoading, estimateCandidates,
                showVendorSelectModal, vendorCandidates, vendorSplitPreview,
                assistantBtnVisible, assistantCtxMenu, openAssistantCtxMenu, setAssistantBtnVisible,
                showChatBot, chatInput, chatMessages, isChatThinking, sendChatMessage, chatMode, aiAssistantInput, aiAssistantMessages, isAiAssistantThinking, aiAssistantLoadingText, aiAssistantPlaceholder, sendAiAssistantMessage, applyAiActions, cancelAiAction, aiPendingActions, handleAiNavigation,
                chatPosX, chatPosY, isDragging, onChatDragStart, onChatBtnClick,
                floatingPanel, floatingPanelPosX, floatingPanelPosY, isFloatingPanelDragging, onFloatingPanelDragStart, openFloatingEstimatePanel, openFloatingPanelList, selectFloatingPanelItem, floatingPanelBack, closeFloatingPanel, toggleFloatingPanelSelectAll, addFloatingPanelItems, applyFloatingPanelHeader, floatingPanelCheckedCount, floatingPanelFilteredList,
                sidePanelMode, orderInPanel, toggleSidePanel, closeSidePanel, handleEstimateRowClick, saveOrderPanelToEstimate, currentEstimateOrders, reprintOrderPdf, openOrderForEdit,
                batchVendorSelect, tempBatchVendor, applyBatchVendorToPanel, selectedItemsCount, toggleSelectionMode, selectAllRows, clearAllSelection, handleRowSelection, batchUpdateVendor,
                selectByVendorPrompt, selectByCategoryPrompt, selectByProductPrompt, selectUnorderedRows, selectBatchOption,
                showBatchSelectModal, batchSelectOptions, batchSelectType,
                isSelectionMode, lastSelectedIndex,
                saveConfirmState,
                unifiedProducts, unitOptions, setMasters, searchMasterKeyword, searchSetKeyword, leftPanelMode, activeLeftPanelRow, leftPanelContext, filteredMasters, filteredSets, openLeftPanel, closeLeftPanel, applyMasterItem, applySetItem,
                materialPrices, searchMaterialKeyword, filteredMaterialPrices, materialEditIdx, materialEditData, openMaterialAdd, openMaterialEdit, cancelMaterialEdit, saveMaterialItem, deleteMaterialItem,
                removeItem, removeOrderItem, removeDedicatedItem, contextMenu, onRowContextMenu, insertRow, cellNav,
                // Phase 1 Add: 粗利計算
                calcPanelMargin,
                // Phase 4 New Returns
                dedicatedOrderForm, createNewDedicatedOrder, calcDedicatedLine, totalDedicatedEstimate, totalDedicatedAmount, saveDedicatedOrder, createDedicatedOrderPdf, dedicatedOrderPdfMode, selectDedicatedVendorAndPrint, estSuggestions, showEstSuggestions, matchingEstimates, onDedicatedClientSelect, selectEstimateSuggestion,
                dedicatedSelectedCount, batchDedicatedVendor, selectAllDedicatedRows, clearAllDedicatedSelection, applyBatchDedicatedVendor,
                loadOrderFromHistory,
                loadEstimateToOrder,
                // Methods
                goHome, handleBack, handleNavigation, formatCurrency, fetchProjects, fetchOrders, fetchInvoices, loadInvoiceFiles, goToProjectList, goToInvoice, goToAdmin, filteredProjects, stats, years, adminProjects, adminOrders,
                clearEstimateForm, createNewEstimate, openEstimateHistoryFromMenu, openOrderHistoryFromMenu, loadEstimate, saveEstimate, createPdf, createOrderPdf, selectVendorAndPrint,
                addItem, calcLine, totalAmount, totalEstimatedCost, calculateMargin, predictPrice, bulkPriceTarget, bulkPricePercent, applyBulkPriceChange, getPricePct, getCostPct,
                showSuggestions, hideSuggestions, applySuggestion, onClientInput, 
                selectInvoiceFile, resetInvoiceForm, checkOrderBalance, onProjectSelect, registerInvoice, editInvoice, updateInvoiceStatus, deleteItem,
                openLedger, createLedgerPdf, loadAnalysis, openDraftModal, selectDraft, openOcrModal, toggleFileSelection, executeOcrScan, handleOcrFileSelect, handleOcrDrop, applyOcrResults,
                showPreview, downloadJournalCsv, confirmAction, handleConfirm,
                checkUnsavedChanges, handleSaveAndMove
            };
          }
        });

        app.component('num-input', {
          inheritAttrs: false,
          props: {
            modelValue: { type: [Number, String], default: '' }
          },
          emits: ['update:modelValue'],
          setup(props, { emit }) {
            const editing = Vue.ref(false);
            const rawInput = Vue.ref('');
            const displayValue = Vue.computed(() => {
              if (editing.value) return rawInput.value;
              const n = Number(props.modelValue);
              if (!props.modelValue && props.modelValue !== 0) return '';
              if (n === 0 && String(props.modelValue) === '') return '';
              return n.toLocaleString();
            });
            const onFocus = (e) => {
              editing.value = true;
              const n = Number(props.modelValue);
              rawInput.value = (!props.modelValue && props.modelValue !== 0) ? '' :
                               (n === 0 && String(props.modelValue) === '') ? '' : String(n);
              Vue.nextTick(() => e.target.select());
            };
            const onBlur = () => {
              editing.value = false;
              if (rawInput.value === '') { emit('update:modelValue', ''); return; }
              const parsed = parseFloat(rawInput.value);
              emit('update:modelValue', isNaN(parsed) ? '' : parsed);
            };
            const onInput = (e) => {
              rawInput.value = e.target.value;
              if (e.target.value === '') { emit('update:modelValue', ''); return; }
              const parsed = parseFloat(e.target.value);
              emit('update:modelValue', isNaN(parsed) ? '' : parsed);
            };
            return { displayValue, onFocus, onBlur, onInput };
          },
          template: `<input v-bind="$attrs" type="text" inputmode="decimal" :value="displayValue" @focus="onFocus" @blur="onBlur" @input="onInput" />`
        });

        window.__mountAttempted = true;
        app.mount('#app');
        window.__mountComplete = true;
        
    } catch (e) {
        const lb = document.getElementById('loading-fallback');
        const ce = document.getElementById('critical-error');
        if (lb) lb.style.display = 'none';
        if (ce) { ce.style.display = 'block'; ce.innerHTML = '<h3>初期化エラー</h3><pre>' + window._escHtml(e.message||e) + '</pre><p>上記エラーを管理者に伝えてください。</p>'; }
    }
  </script>

</body>
</html>